<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>src.agents.funding_rounds API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../agents.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;src.agents</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#FundingRoundsAgent">FundingRoundsAgent</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FundingRoundsAgent.__init__">FundingRoundsAgent</a>
                        </li>
                        <li>
                                <a class="function" href="#FundingRoundsAgent.execute">execute</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
src<wbr>.<a href="./../agents.html">agents</a><wbr>.funding_rounds    </h1>

                        <div class="docstring"><p>Funding rounds agent module.</p>
</div>

                        <input id="mod-funding_rounds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-funding_rounds-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">1</span></a><span class="sd">&quot;&quot;&quot;Funding rounds agent module.&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">FundingRoundsAgent</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">5</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FundingRoundsAgent&quot;</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="FundingRoundsAgent">
                            <input id="FundingRoundsAgent-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FundingRoundsAgent</span><wbr>(<span class="base"><a href="../core/agent_base.html#AgentBase">src.core.agent_base.AgentBase</a></span>):

                <label class="view-source-button" for="FundingRoundsAgent-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FundingRoundsAgent"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FundingRoundsAgent-43"><a href="#FundingRoundsAgent-43"><span class="linenos">  43</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FundingRoundsAgent</span><span class="p">(</span><span class="n">AgentBase</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-44"><a href="#FundingRoundsAgent-44"><span class="linenos">  44</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Agent specialized in handling funding round-related queries and data retrieval.</span>
</span><span id="FundingRoundsAgent-45"><a href="#FundingRoundsAgent-45"><span class="linenos">  45</span></a>
</span><span id="FundingRoundsAgent-46"><a href="#FundingRoundsAgent-46"><span class="linenos">  46</span></a><span class="sd">    This agent uses LLM reasoning to understand user queries about funding rounds</span>
</span><span id="FundingRoundsAgent-47"><a href="#FundingRoundsAgent-47"><span class="linenos">  47</span></a><span class="sd">    and calls the get_funding_rounds tool to retrieve relevant data from the database.</span>
</span><span id="FundingRoundsAgent-48"><a href="#FundingRoundsAgent-48"><span class="linenos">  48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-49"><a href="#FundingRoundsAgent-49"><span class="linenos">  49</span></a>
</span><span id="FundingRoundsAgent-50"><a href="#FundingRoundsAgent-50"><span class="linenos">  50</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-51"><a href="#FundingRoundsAgent-51"><span class="linenos">  51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the funding rounds agent.</span>
</span><span id="FundingRoundsAgent-52"><a href="#FundingRoundsAgent-52"><span class="linenos">  52</span></a>
</span><span id="FundingRoundsAgent-53"><a href="#FundingRoundsAgent-53"><span class="linenos">  53</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-54"><a href="#FundingRoundsAgent-54"><span class="linenos">  54</span></a><span class="sd">            config_path: Path to the agent&#39;s YAML config file.</span>
</span><span id="FundingRoundsAgent-55"><a href="#FundingRoundsAgent-55"><span class="linenos">  55</span></a><span class="sd">                If None, will attempt to find it automatically.</span>
</span><span id="FundingRoundsAgent-56"><a href="#FundingRoundsAgent-56"><span class="linenos">  56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-57"><a href="#FundingRoundsAgent-57"><span class="linenos">  57</span></a>        <span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-58"><a href="#FundingRoundsAgent-58"><span class="linenos">  58</span></a>            <span class="c1"># Default to funding_rounds_agent.yaml in configs/agents</span>
</span><span id="FundingRoundsAgent-59"><a href="#FundingRoundsAgent-59"><span class="linenos">  59</span></a>            <span class="n">src_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span><span id="FundingRoundsAgent-60"><a href="#FundingRoundsAgent-60"><span class="linenos">  60</span></a>            <span class="n">config_path</span> <span class="o">=</span> <span class="n">src_base</span> <span class="o">/</span> <span class="s2">&quot;configs&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;funding_rounds_agent.yaml&quot;</span>
</span><span id="FundingRoundsAgent-61"><a href="#FundingRoundsAgent-61"><span class="linenos">  61</span></a>
</span><span id="FundingRoundsAgent-62"><a href="#FundingRoundsAgent-62"><span class="linenos">  62</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-63"><a href="#FundingRoundsAgent-63"><span class="linenos">  63</span></a>
</span><span id="FundingRoundsAgent-64"><a href="#FundingRoundsAgent-64"><span class="linenos">  64</span></a>        <span class="c1"># Store base prompts as instance variables for reuse</span>
</span><span id="FundingRoundsAgent-65"><a href="#FundingRoundsAgent-65"><span class="linenos">  65</span></a>        <span class="c1"># Base prompt for company name and sector identification</span>
</span><span id="FundingRoundsAgent-66"><a href="#FundingRoundsAgent-66"><span class="linenos">  66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_identify_companies_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are analyzing a query about funding rounds. Your job is to identify:</span>
</span><span id="FundingRoundsAgent-67"><a href="#FundingRoundsAgent-67"><span class="linenos">  67</span></a><span class="s2">1. Specific company names mentioned in the query</span>
</span><span id="FundingRoundsAgent-68"><a href="#FundingRoundsAgent-68"><span class="linenos">  68</span></a><span class="s2">2. Sector/industry names mentioned in the query (for semantic search)</span>
</span><span id="FundingRoundsAgent-69"><a href="#FundingRoundsAgent-69"><span class="linenos">  69</span></a>
</span><span id="FundingRoundsAgent-70"><a href="#FundingRoundsAgent-70"><span class="linenos">  70</span></a><span class="s2">IMPORTANT: The semantic_search_organizations tool is designed to query by SECTOR/INDUSTRY names, not specific company names. For specific company names, use get_organizations with name/name_ilike parameter.</span>
</span><span id="FundingRoundsAgent-71"><a href="#FundingRoundsAgent-71"><span class="linenos">  71</span></a>
</span><span id="FundingRoundsAgent-72"><a href="#FundingRoundsAgent-72"><span class="linenos">  72</span></a><span class="s2">Examples:</span>
</span><span id="FundingRoundsAgent-73"><a href="#FundingRoundsAgent-73"><span class="linenos">  73</span></a><span class="s2">- &quot;What funding rounds did Google raise?&quot; → company_name: &quot;Google&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent-74"><a href="#FundingRoundsAgent-74"><span class="linenos">  74</span></a><span class="s2">- &quot;Show me funding rounds for Microsoft&quot; → company_name: &quot;Microsoft&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent-75"><a href="#FundingRoundsAgent-75"><span class="linenos">  75</span></a><span class="s2">- &quot;Tell me about funding rounds for AI startups&quot; → company_name: None, sector_name: &quot;AI startups&quot;</span>
</span><span id="FundingRoundsAgent-76"><a href="#FundingRoundsAgent-76"><span class="linenos">  76</span></a><span class="s2">- &quot;Funding rounds for GitHub&quot; → company_name: &quot;GitHub&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent-77"><a href="#FundingRoundsAgent-77"><span class="linenos">  77</span></a><span class="s2">- &quot;Funding rounds for healthcare companies&quot; → company_name: None, sector_name: &quot;healthcare companies&quot;</span>
</span><span id="FundingRoundsAgent-78"><a href="#FundingRoundsAgent-78"><span class="linenos">  78</span></a>
</span><span id="FundingRoundsAgent-79"><a href="#FundingRoundsAgent-79"><span class="linenos">  79</span></a><span class="s2">Only identify names that are clearly company names or sector/industry names. Leave fields as null if not mentioned.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-80"><a href="#FundingRoundsAgent-80"><span class="linenos">  80</span></a>
</span><span id="FundingRoundsAgent-81"><a href="#FundingRoundsAgent-81"><span class="linenos">  81</span></a>        <span class="c1"># Base prompt for parameter extraction</span>
</span><span id="FundingRoundsAgent-82"><a href="#FundingRoundsAgent-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a funding rounds search assistant. Your job is to analyze user queries about funding rounds and extract relevant search parameters.</span>
</span><span id="FundingRoundsAgent-83"><a href="#FundingRoundsAgent-83"><span class="linenos">  83</span></a>
</span><span id="FundingRoundsAgent-84"><a href="#FundingRoundsAgent-84"><span class="linenos">  84</span></a><span class="s2">Rules:</span>
</span><span id="FundingRoundsAgent-85"><a href="#FundingRoundsAgent-85"><span class="linenos">  85</span></a><span class="s2">- Only extract parameters that are explicitly mentioned or clearly implied in the query</span>
</span><span id="FundingRoundsAgent-86"><a href="#FundingRoundsAgent-86"><span class="linenos">  86</span></a><span class="s2">- For date ranges, convert relative terms (e.g., &quot;last year&quot;, &quot;2023&quot;) to ISO format dates</span>
</span><span id="FundingRoundsAgent-87"><a href="#FundingRoundsAgent-87"><span class="linenos">  87</span></a><span class="s2">- For amounts, convert mentions like &quot;over $1M&quot; to fundraise_amount_usd_min</span>
</span><span id="FundingRoundsAgent-88"><a href="#FundingRoundsAgent-88"><span class="linenos">  88</span></a><span class="s2">- Company names have already been resolved to UUIDs - use the provided UUIDs if available</span>
</span><span id="FundingRoundsAgent-89"><a href="#FundingRoundsAgent-89"><span class="linenos">  89</span></a><span class="s2">- Set a reasonable limit (default 10) if the user doesn&#39;t specify</span>
</span><span id="FundingRoundsAgent-90"><a href="#FundingRoundsAgent-90"><span class="linenos">  90</span></a><span class="s2">- Leave parameters as None/null if not mentioned in the query</span>
</span><span id="FundingRoundsAgent-91"><a href="#FundingRoundsAgent-91"><span class="linenos">  91</span></a><span class="s2">- Be conservative - only extract what you&#39;re confident about&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-92"><a href="#FundingRoundsAgent-92"><span class="linenos">  92</span></a>
</span><span id="FundingRoundsAgent-93"><a href="#FundingRoundsAgent-93"><span class="linenos">  93</span></a>        <span class="c1"># Register prompts with prompt manager for consistency and potential reuse</span>
</span><span id="FundingRoundsAgent-94"><a href="#FundingRoundsAgent-94"><span class="linenos">  94</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-95"><a href="#FundingRoundsAgent-95"><span class="linenos">  95</span></a>        <span class="n">prompt_manager</span><span class="o">.</span><span class="n">register_agent_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-96"><a href="#FundingRoundsAgent-96"><span class="linenos">  96</span></a>            <span class="n">agent_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_identify_companies&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-97"><a href="#FundingRoundsAgent-97"><span class="linenos">  97</span></a>            <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identify_companies_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-98"><a href="#FundingRoundsAgent-98"><span class="linenos">  98</span></a>            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-99"><a href="#FundingRoundsAgent-99"><span class="linenos">  99</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-100"><a href="#FundingRoundsAgent-100"><span class="linenos"> 100</span></a>        <span class="n">prompt_manager</span><span class="o">.</span><span class="n">register_agent_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-101"><a href="#FundingRoundsAgent-101"><span class="linenos"> 101</span></a>            <span class="n">agent_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_extract_params&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-102"><a href="#FundingRoundsAgent-102"><span class="linenos"> 102</span></a>            <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-103"><a href="#FundingRoundsAgent-103"><span class="linenos"> 103</span></a>            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-104"><a href="#FundingRoundsAgent-104"><span class="linenos"> 104</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-105"><a href="#FundingRoundsAgent-105"><span class="linenos"> 105</span></a>
</span><span id="FundingRoundsAgent-106"><a href="#FundingRoundsAgent-106"><span class="linenos"> 106</span></a>    <span class="nd">@observe</span><span class="p">(</span><span class="n">as_type</span><span class="o">=</span><span class="s2">&quot;agent&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-107"><a href="#FundingRoundsAgent-107"><span class="linenos"> 107</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-108"><a href="#FundingRoundsAgent-108"><span class="linenos"> 108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the funding rounds agent to handle funding round-related queries.</span>
</span><span id="FundingRoundsAgent-109"><a href="#FundingRoundsAgent-109"><span class="linenos"> 109</span></a>
</span><span id="FundingRoundsAgent-110"><a href="#FundingRoundsAgent-110"><span class="linenos"> 110</span></a><span class="sd">        This method:</span>
</span><span id="FundingRoundsAgent-111"><a href="#FundingRoundsAgent-111"><span class="linenos"> 111</span></a><span class="sd">        1. Analyzes the user query to identify company names mentioned</span>
</span><span id="FundingRoundsAgent-112"><a href="#FundingRoundsAgent-112"><span class="linenos"> 112</span></a><span class="sd">        2. Resolves company names to UUIDs using semantic_search_organizations</span>
</span><span id="FundingRoundsAgent-113"><a href="#FundingRoundsAgent-113"><span class="linenos"> 113</span></a><span class="sd">        3. Extracts other search parameters (dates, amounts, investors, stages, etc.)</span>
</span><span id="FundingRoundsAgent-114"><a href="#FundingRoundsAgent-114"><span class="linenos"> 114</span></a><span class="sd">        4. Calls the get_funding_rounds tool with resolved UUIDs and parameters</span>
</span><span id="FundingRoundsAgent-115"><a href="#FundingRoundsAgent-115"><span class="linenos"> 115</span></a><span class="sd">        5. Formats the results into a natural language response</span>
</span><span id="FundingRoundsAgent-116"><a href="#FundingRoundsAgent-116"><span class="linenos"> 116</span></a><span class="sd">        6. Returns a structured response with tool calls tracked</span>
</span><span id="FundingRoundsAgent-117"><a href="#FundingRoundsAgent-117"><span class="linenos"> 117</span></a>
</span><span id="FundingRoundsAgent-118"><a href="#FundingRoundsAgent-118"><span class="linenos"> 118</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-119"><a href="#FundingRoundsAgent-119"><span class="linenos"> 119</span></a><span class="sd">            context: The agent context containing the user query and metadata.</span>
</span><span id="FundingRoundsAgent-120"><a href="#FundingRoundsAgent-120"><span class="linenos"> 120</span></a>
</span><span id="FundingRoundsAgent-121"><a href="#FundingRoundsAgent-121"><span class="linenos"> 121</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-122"><a href="#FundingRoundsAgent-122"><span class="linenos"> 122</span></a><span class="sd">            AgentOutput containing:</span>
</span><span id="FundingRoundsAgent-123"><a href="#FundingRoundsAgent-123"><span class="linenos"> 123</span></a><span class="sd">            - content: Natural language response with funding round information</span>
</span><span id="FundingRoundsAgent-124"><a href="#FundingRoundsAgent-124"><span class="linenos"> 124</span></a><span class="sd">            - status: SUCCESS if query processed successfully</span>
</span><span id="FundingRoundsAgent-125"><a href="#FundingRoundsAgent-125"><span class="linenos"> 125</span></a><span class="sd">            - metadata: Information about the search and results</span>
</span><span id="FundingRoundsAgent-126"><a href="#FundingRoundsAgent-126"><span class="linenos"> 126</span></a><span class="sd">            - tool_calls: List of tool calls made during execution</span>
</span><span id="FundingRoundsAgent-127"><a href="#FundingRoundsAgent-127"><span class="linenos"> 127</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-128"><a href="#FundingRoundsAgent-128"><span class="linenos"> 128</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-129"><a href="#FundingRoundsAgent-129"><span class="linenos"> 129</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Funding rounds agent processing query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-130"><a href="#FundingRoundsAgent-130"><span class="linenos"> 130</span></a>
</span><span id="FundingRoundsAgent-131"><a href="#FundingRoundsAgent-131"><span class="linenos"> 131</span></a>            <span class="c1"># Prefer pre-extracted intent if available</span>
</span><span id="FundingRoundsAgent-132"><a href="#FundingRoundsAgent-132"><span class="linenos"> 132</span></a>            <span class="n">extracted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;extracted_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-133"><a href="#FundingRoundsAgent-133"><span class="linenos"> 133</span></a>            <span class="n">query_intent</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_intent&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-134"><a href="#FundingRoundsAgent-134"><span class="linenos"> 134</span></a>
</span><span id="FundingRoundsAgent-135"><a href="#FundingRoundsAgent-135"><span class="linenos"> 135</span></a>            <span class="k">if</span> <span class="n">query_intent</span> <span class="o">==</span> <span class="s2">&quot;find_investor_portfolio&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-136"><a href="#FundingRoundsAgent-136"><span class="linenos"> 136</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_investor_portfolio_query</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-137"><a href="#FundingRoundsAgent-137"><span class="linenos"> 137</span></a>
</span><span id="FundingRoundsAgent-138"><a href="#FundingRoundsAgent-138"><span class="linenos"> 138</span></a>            <span class="c1"># Fallback to LLM classification if intent not provided</span>
</span><span id="FundingRoundsAgent-139"><a href="#FundingRoundsAgent-139"><span class="linenos"> 139</span></a>            <span class="n">query_type</span> <span class="o">=</span> <span class="n">query_intent</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_query_type</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-140"><a href="#FundingRoundsAgent-140"><span class="linenos"> 140</span></a>
</span><span id="FundingRoundsAgent-141"><a href="#FundingRoundsAgent-141"><span class="linenos"> 141</span></a>            <span class="k">if</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;investor_portfolio&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-142"><a href="#FundingRoundsAgent-142"><span class="linenos"> 142</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_investor_portfolio_query</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-143"><a href="#FundingRoundsAgent-143"><span class="linenos"> 143</span></a>
</span><span id="FundingRoundsAgent-144"><a href="#FundingRoundsAgent-144"><span class="linenos"> 144</span></a>            <span class="c1"># Step 2: Identify and resolve company names to UUIDs</span>
</span><span id="FundingRoundsAgent-145"><a href="#FundingRoundsAgent-145"><span class="linenos"> 145</span></a>            <span class="n">resolved_uuids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_company_names</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-146"><a href="#FundingRoundsAgent-146"><span class="linenos"> 146</span></a>
</span><span id="FundingRoundsAgent-147"><a href="#FundingRoundsAgent-147"><span class="linenos"> 147</span></a>            <span class="c1"># Step 3: Extract other search parameters from the query</span>
</span><span id="FundingRoundsAgent-148"><a href="#FundingRoundsAgent-148"><span class="linenos"> 148</span></a>            <span class="n">search_params</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_search_parameters</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">resolved_uuids</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-149"><a href="#FundingRoundsAgent-149"><span class="linenos"> 149</span></a>
</span><span id="FundingRoundsAgent-150"><a href="#FundingRoundsAgent-150"><span class="linenos"> 150</span></a>            <span class="c1"># Step 4: Call get_funding_rounds tool with extracted parameters</span>
</span><span id="FundingRoundsAgent-151"><a href="#FundingRoundsAgent-151"><span class="linenos"> 151</span></a>            <span class="c1"># Always include organizations for better insights</span>
</span><span id="FundingRoundsAgent-152"><a href="#FundingRoundsAgent-152"><span class="linenos"> 152</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;include_organizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FundingRoundsAgent-153"><a href="#FundingRoundsAgent-153"><span class="linenos"> 153</span></a>
</span><span id="FundingRoundsAgent-154"><a href="#FundingRoundsAgent-154"><span class="linenos"> 154</span></a>            <span class="c1"># Fan-out when multiple companies and no single org_uuid filter</span>
</span><span id="FundingRoundsAgent-155"><a href="#FundingRoundsAgent-155"><span class="linenos"> 155</span></a>            <span class="n">funding_rounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-156"><a href="#FundingRoundsAgent-156"><span class="linenos"> 156</span></a>            <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-157"><a href="#FundingRoundsAgent-157"><span class="linenos"> 157</span></a>            <span class="n">funding_rounds_output</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent-158"><a href="#FundingRoundsAgent-158"><span class="linenos"> 158</span></a>
</span><span id="FundingRoundsAgent-159"><a href="#FundingRoundsAgent-159"><span class="linenos"> 159</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-160"><a href="#FundingRoundsAgent-160"><span class="linenos"> 160</span></a>                <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;company_pool&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-161"><a href="#FundingRoundsAgent-161"><span class="linenos"> 161</span></a>                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="FundingRoundsAgent-162"><a href="#FundingRoundsAgent-162"><span class="linenos"> 162</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-163"><a href="#FundingRoundsAgent-163"><span class="linenos"> 163</span></a>            <span class="p">):</span>
</span><span id="FundingRoundsAgent-164"><a href="#FundingRoundsAgent-164"><span class="linenos"> 164</span></a>                <span class="n">funding_rounds</span><span class="p">,</span> <span class="n">fanout_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fanout_funding_rounds</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-165"><a href="#FundingRoundsAgent-165"><span class="linenos"> 165</span></a>                    <span class="n">company_pool</span><span class="o">=</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-166"><a href="#FundingRoundsAgent-166"><span class="linenos"> 166</span></a>                    <span class="n">base_params</span><span class="o">=</span><span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-167"><a href="#FundingRoundsAgent-167"><span class="linenos"> 167</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-168"><a href="#FundingRoundsAgent-168"><span class="linenos"> 168</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fanout_calls</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-169"><a href="#FundingRoundsAgent-169"><span class="linenos"> 169</span></a>                <span class="c1"># If all fan-out calls failed, return early with error</span>
</span><span id="FundingRoundsAgent-170"><a href="#FundingRoundsAgent-170"><span class="linenos"> 170</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">funding_rounds</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-171"><a href="#FundingRoundsAgent-171"><span class="linenos"> 171</span></a>                    <span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">fanout_calls</span>
</span><span id="FundingRoundsAgent-172"><a href="#FundingRoundsAgent-172"><span class="linenos"> 172</span></a>                <span class="p">):</span>
</span><span id="FundingRoundsAgent-173"><a href="#FundingRoundsAgent-173"><span class="linenos"> 173</span></a>                    <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-174"><a href="#FundingRoundsAgent-174"><span class="linenos"> 174</span></a>                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-175"><a href="#FundingRoundsAgent-175"><span class="linenos"> 175</span></a>                        <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-176"><a href="#FundingRoundsAgent-176"><span class="linenos"> 176</span></a>                        <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-177"><a href="#FundingRoundsAgent-177"><span class="linenos"> 177</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-178"><a href="#FundingRoundsAgent-178"><span class="linenos"> 178</span></a>                        <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve funding rounds for all companies in fan-out.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-179"><a href="#FundingRoundsAgent-179"><span class="linenos"> 179</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-180"><a href="#FundingRoundsAgent-180"><span class="linenos"> 180</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-181"><a href="#FundingRoundsAgent-181"><span class="linenos"> 181</span></a>                <span class="n">funding_rounds_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_funding_rounds</span><span class="p">(</span><span class="o">**</span><span class="n">search_params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-182"><a href="#FundingRoundsAgent-182"><span class="linenos"> 182</span></a>
</span><span id="FundingRoundsAgent-183"><a href="#FundingRoundsAgent-183"><span class="linenos"> 183</span></a>                <span class="c1"># Check if tool execution was successful</span>
</span><span id="FundingRoundsAgent-184"><a href="#FundingRoundsAgent-184"><span class="linenos"> 184</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-185"><a href="#FundingRoundsAgent-185"><span class="linenos"> 185</span></a>                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Failed to retrieve funding rounds&quot;</span>
</span><span id="FundingRoundsAgent-186"><a href="#FundingRoundsAgent-186"><span class="linenos"> 186</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_funding_rounds tool failed: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-187"><a href="#FundingRoundsAgent-187"><span class="linenos"> 187</span></a>                    <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-188"><a href="#FundingRoundsAgent-188"><span class="linenos"> 188</span></a>                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-189"><a href="#FundingRoundsAgent-189"><span class="linenos"> 189</span></a>                        <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-190"><a href="#FundingRoundsAgent-190"><span class="linenos"> 190</span></a>                        <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-191"><a href="#FundingRoundsAgent-191"><span class="linenos"> 191</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-192"><a href="#FundingRoundsAgent-192"><span class="linenos"> 192</span></a>                        <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve funding rounds: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-193"><a href="#FundingRoundsAgent-193"><span class="linenos"> 193</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-194"><a href="#FundingRoundsAgent-194"><span class="linenos"> 194</span></a>
</span><span id="FundingRoundsAgent-195"><a href="#FundingRoundsAgent-195"><span class="linenos"> 195</span></a>                <span class="c1"># Extract result from ToolOutput</span>
</span><span id="FundingRoundsAgent-196"><a href="#FundingRoundsAgent-196"><span class="linenos"> 196</span></a>                <span class="n">funding_rounds</span> <span class="o">=</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">result</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-197"><a href="#FundingRoundsAgent-197"><span class="linenos"> 197</span></a>
</span><span id="FundingRoundsAgent-198"><a href="#FundingRoundsAgent-198"><span class="linenos"> 198</span></a>            <span class="c1"># Step 5: Format results into natural language response</span>
</span><span id="FundingRoundsAgent-199"><a href="#FundingRoundsAgent-199"><span class="linenos"> 199</span></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">funding_rounds</span><span class="p">,</span> <span class="n">search_params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-200"><a href="#FundingRoundsAgent-200"><span class="linenos"> 200</span></a>
</span><span id="FundingRoundsAgent-201"><a href="#FundingRoundsAgent-201"><span class="linenos"> 201</span></a>            <span class="c1"># Track all tool calls</span>
</span><span id="FundingRoundsAgent-202"><a href="#FundingRoundsAgent-202"><span class="linenos"> 202</span></a>            <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-203"><a href="#FundingRoundsAgent-203"><span class="linenos"> 203</span></a>                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent-204"><a href="#FundingRoundsAgent-204"><span class="linenos"> 204</span></a>                    <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-205"><a href="#FundingRoundsAgent-205"><span class="linenos"> 205</span></a>                        <span class="p">{</span>
</span><span id="FundingRoundsAgent-206"><a href="#FundingRoundsAgent-206"><span class="linenos"> 206</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;semantic_search_organizations&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-207"><a href="#FundingRoundsAgent-207"><span class="linenos"> 207</span></a>                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-208"><a href="#FundingRoundsAgent-208"><span class="linenos"> 208</span></a>                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-209"><a href="#FundingRoundsAgent-209"><span class="linenos"> 209</span></a>                        <span class="p">}</span>
</span><span id="FundingRoundsAgent-210"><a href="#FundingRoundsAgent-210"><span class="linenos"> 210</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-211"><a href="#FundingRoundsAgent-211"><span class="linenos"> 211</span></a>            <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-212"><a href="#FundingRoundsAgent-212"><span class="linenos"> 212</span></a>                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent-213"><a href="#FundingRoundsAgent-213"><span class="linenos"> 213</span></a>                    <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-214"><a href="#FundingRoundsAgent-214"><span class="linenos"> 214</span></a>                        <span class="p">{</span>
</span><span id="FundingRoundsAgent-215"><a href="#FundingRoundsAgent-215"><span class="linenos"> 215</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_organizations&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-216"><a href="#FundingRoundsAgent-216"><span class="linenos"> 216</span></a>                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-217"><a href="#FundingRoundsAgent-217"><span class="linenos"> 217</span></a>                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-218"><a href="#FundingRoundsAgent-218"><span class="linenos"> 218</span></a>                        <span class="p">}</span>
</span><span id="FundingRoundsAgent-219"><a href="#FundingRoundsAgent-219"><span class="linenos"> 219</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-220"><a href="#FundingRoundsAgent-220"><span class="linenos"> 220</span></a>
</span><span id="FundingRoundsAgent-221"><a href="#FundingRoundsAgent-221"><span class="linenos"> 221</span></a>            <span class="c1"># If we did single-call path, add that call metadata</span>
</span><span id="FundingRoundsAgent-222"><a href="#FundingRoundsAgent-222"><span class="linenos"> 222</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-223"><a href="#FundingRoundsAgent-223"><span class="linenos"> 223</span></a>                <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;get_funding_rounds&quot;</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-224"><a href="#FundingRoundsAgent-224"><span class="linenos"> 224</span></a>                <span class="ow">and</span> <span class="n">funding_rounds_output</span>
</span><span id="FundingRoundsAgent-225"><a href="#FundingRoundsAgent-225"><span class="linenos"> 225</span></a>            <span class="p">):</span>
</span><span id="FundingRoundsAgent-226"><a href="#FundingRoundsAgent-226"><span class="linenos"> 226</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-227"><a href="#FundingRoundsAgent-227"><span class="linenos"> 227</span></a>                    <span class="p">{</span>
</span><span id="FundingRoundsAgent-228"><a href="#FundingRoundsAgent-228"><span class="linenos"> 228</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-229"><a href="#FundingRoundsAgent-229"><span class="linenos"> 229</span></a>                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-230"><a href="#FundingRoundsAgent-230"><span class="linenos"> 230</span></a>                        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-231"><a href="#FundingRoundsAgent-231"><span class="linenos"> 231</span></a>                            <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-232"><a href="#FundingRoundsAgent-232"><span class="linenos"> 232</span></a>                            <span class="s2">&quot;sample_ids&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-233"><a href="#FundingRoundsAgent-233"><span class="linenos"> 233</span></a>                                <span class="p">[</span><span class="n">fr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funding_round_uuid&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">funding_rounds</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="FundingRoundsAgent-234"><a href="#FundingRoundsAgent-234"><span class="linenos"> 234</span></a>                                <span class="k">if</span> <span class="n">funding_rounds</span>
</span><span id="FundingRoundsAgent-235"><a href="#FundingRoundsAgent-235"><span class="linenos"> 235</span></a>                                <span class="k">else</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-236"><a href="#FundingRoundsAgent-236"><span class="linenos"> 236</span></a>                            <span class="p">),</span>
</span><span id="FundingRoundsAgent-237"><a href="#FundingRoundsAgent-237"><span class="linenos"> 237</span></a>                            <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-238"><a href="#FundingRoundsAgent-238"><span class="linenos"> 238</span></a>                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-239"><a href="#FundingRoundsAgent-239"><span class="linenos"> 239</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-240"><a href="#FundingRoundsAgent-240"><span class="linenos"> 240</span></a>                    <span class="p">}</span>
</span><span id="FundingRoundsAgent-241"><a href="#FundingRoundsAgent-241"><span class="linenos"> 241</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-242"><a href="#FundingRoundsAgent-242"><span class="linenos"> 242</span></a>
</span><span id="FundingRoundsAgent-243"><a href="#FundingRoundsAgent-243"><span class="linenos"> 243</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-244"><a href="#FundingRoundsAgent-244"><span class="linenos"> 244</span></a>                <span class="sa">f</span><span class="s2">&quot;Funding rounds agent completed: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">)</span><span class="si">}</span><span class="s2"> funding round(s)&quot;</span>
</span><span id="FundingRoundsAgent-245"><a href="#FundingRoundsAgent-245"><span class="linenos"> 245</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-246"><a href="#FundingRoundsAgent-246"><span class="linenos"> 246</span></a>
</span><span id="FundingRoundsAgent-247"><a href="#FundingRoundsAgent-247"><span class="linenos"> 247</span></a>            <span class="c1"># Return AgentOutput using contract helper</span>
</span><span id="FundingRoundsAgent-248"><a href="#FundingRoundsAgent-248"><span class="linenos"> 248</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-249"><a href="#FundingRoundsAgent-249"><span class="linenos"> 249</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-250"><a href="#FundingRoundsAgent-250"><span class="linenos"> 250</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-251"><a href="#FundingRoundsAgent-251"><span class="linenos"> 251</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-252"><a href="#FundingRoundsAgent-252"><span class="linenos"> 252</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-253"><a href="#FundingRoundsAgent-253"><span class="linenos"> 253</span></a>                <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-254"><a href="#FundingRoundsAgent-254"><span class="linenos"> 254</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-255"><a href="#FundingRoundsAgent-255"><span class="linenos"> 255</span></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-256"><a href="#FundingRoundsAgent-256"><span class="linenos"> 256</span></a>                    <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-257"><a href="#FundingRoundsAgent-257"><span class="linenos"> 257</span></a>                    <span class="s2">&quot;search_parameters&quot;</span><span class="p">:</span> <span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-258"><a href="#FundingRoundsAgent-258"><span class="linenos"> 258</span></a>                    <span class="s2">&quot;resolved_companies&quot;</span><span class="p">:</span> <span class="n">resolved_uuids</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-259"><a href="#FundingRoundsAgent-259"><span class="linenos"> 259</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-260"><a href="#FundingRoundsAgent-260"><span class="linenos"> 260</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-261"><a href="#FundingRoundsAgent-261"><span class="linenos"> 261</span></a>
</span><span id="FundingRoundsAgent-262"><a href="#FundingRoundsAgent-262"><span class="linenos"> 262</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-263"><a href="#FundingRoundsAgent-263"><span class="linenos"> 263</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Funding rounds agent failed to process query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-264"><a href="#FundingRoundsAgent-264"><span class="linenos"> 264</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-265"><a href="#FundingRoundsAgent-265"><span class="linenos"> 265</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-266"><a href="#FundingRoundsAgent-266"><span class="linenos"> 266</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-267"><a href="#FundingRoundsAgent-267"><span class="linenos"> 267</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-268"><a href="#FundingRoundsAgent-268"><span class="linenos"> 268</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-269"><a href="#FundingRoundsAgent-269"><span class="linenos"> 269</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-270"><a href="#FundingRoundsAgent-270"><span class="linenos"> 270</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-271"><a href="#FundingRoundsAgent-271"><span class="linenos"> 271</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-272"><a href="#FundingRoundsAgent-272"><span class="linenos"> 272</span></a>
</span><span id="FundingRoundsAgent-273"><a href="#FundingRoundsAgent-273"><span class="linenos"> 273</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_company_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent-274"><a href="#FundingRoundsAgent-274"><span class="linenos"> 274</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify company names in the query and resolve them to UUIDs.</span>
</span><span id="FundingRoundsAgent-275"><a href="#FundingRoundsAgent-275"><span class="linenos"> 275</span></a>
</span><span id="FundingRoundsAgent-276"><a href="#FundingRoundsAgent-276"><span class="linenos"> 276</span></a><span class="sd">        This method uses LLM to identify company names mentioned in the query,</span>
</span><span id="FundingRoundsAgent-277"><a href="#FundingRoundsAgent-277"><span class="linenos"> 277</span></a><span class="sd">        then uses semantic_search_organizations to find their UUIDs.</span>
</span><span id="FundingRoundsAgent-278"><a href="#FundingRoundsAgent-278"><span class="linenos"> 278</span></a>
</span><span id="FundingRoundsAgent-279"><a href="#FundingRoundsAgent-279"><span class="linenos"> 279</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-280"><a href="#FundingRoundsAgent-280"><span class="linenos"> 280</span></a><span class="sd">            context: The agent context containing the user query.</span>
</span><span id="FundingRoundsAgent-281"><a href="#FundingRoundsAgent-281"><span class="linenos"> 281</span></a>
</span><span id="FundingRoundsAgent-282"><a href="#FundingRoundsAgent-282"><span class="linenos"> 282</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-283"><a href="#FundingRoundsAgent-283"><span class="linenos"> 283</span></a><span class="sd">            Dictionary containing:</span>
</span><span id="FundingRoundsAgent-284"><a href="#FundingRoundsAgent-284"><span class="linenos"> 284</span></a><span class="sd">            - org_uuid: UUID of the organization (if found)</span>
</span><span id="FundingRoundsAgent-285"><a href="#FundingRoundsAgent-285"><span class="linenos"> 285</span></a><span class="sd">            - semantic_search_calls: List of semantic search tool calls made</span>
</span><span id="FundingRoundsAgent-286"><a href="#FundingRoundsAgent-286"><span class="linenos"> 286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-287"><a href="#FundingRoundsAgent-287"><span class="linenos"> 287</span></a>        <span class="c1"># Use pre-extracted companies if available</span>
</span><span id="FundingRoundsAgent-288"><a href="#FundingRoundsAgent-288"><span class="linenos"> 288</span></a>        <span class="n">extracted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;extracted_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-289"><a href="#FundingRoundsAgent-289"><span class="linenos"> 289</span></a>        <span class="n">companies_data</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;companies&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-290"><a href="#FundingRoundsAgent-290"><span class="linenos"> 290</span></a>
</span><span id="FundingRoundsAgent-291"><a href="#FundingRoundsAgent-291"><span class="linenos"> 291</span></a>        <span class="c1"># Handle both dict and list formats (defensive coding)</span>
</span><span id="FundingRoundsAgent-292"><a href="#FundingRoundsAgent-292"><span class="linenos"> 292</span></a>        <span class="c1"># Sometimes LLM returns companies as a list instead of dict when validation fails</span>
</span><span id="FundingRoundsAgent-293"><a href="#FundingRoundsAgent-293"><span class="linenos"> 293</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-294"><a href="#FundingRoundsAgent-294"><span class="linenos"> 294</span></a>            <span class="c1"># If it&#39;s a list, treat it as a list of company names</span>
</span><span id="FundingRoundsAgent-295"><a href="#FundingRoundsAgent-295"><span class="linenos"> 295</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-296"><a href="#FundingRoundsAgent-296"><span class="linenos"> 296</span></a>                <span class="sa">f</span><span class="s2">&quot;companies_data is a list instead of dict, converting to dict format. &quot;</span>
</span><span id="FundingRoundsAgent-297"><a href="#FundingRoundsAgent-297"><span class="linenos"> 297</span></a>                <span class="sa">f</span><span class="s2">&quot;List: </span><span class="si">{</span><span class="n">companies_data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-298"><a href="#FundingRoundsAgent-298"><span class="linenos"> 298</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-299"><a href="#FundingRoundsAgent-299"><span class="linenos"> 299</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="n">companies_data</span> <span class="k">if</span> <span class="n">companies_data</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-300"><a href="#FundingRoundsAgent-300"><span class="linenos"> 300</span></a>            <span class="n">company_uuids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-301"><a href="#FundingRoundsAgent-301"><span class="linenos"> 301</span></a>            <span class="n">companies_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-302"><a href="#FundingRoundsAgent-302"><span class="linenos"> 302</span></a>                <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">company_names</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-303"><a href="#FundingRoundsAgent-303"><span class="linenos"> 303</span></a>                <span class="s2">&quot;uuids&quot;</span><span class="p">:</span> <span class="n">company_uuids</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-304"><a href="#FundingRoundsAgent-304"><span class="linenos"> 304</span></a>                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-305"><a href="#FundingRoundsAgent-305"><span class="linenos"> 305</span></a>            <span class="p">}</span>
</span><span id="FundingRoundsAgent-306"><a href="#FundingRoundsAgent-306"><span class="linenos"> 306</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-307"><a href="#FundingRoundsAgent-307"><span class="linenos"> 307</span></a>            <span class="c1"># Normal case: dict with names, uuids, context</span>
</span><span id="FundingRoundsAgent-308"><a href="#FundingRoundsAgent-308"><span class="linenos"> 308</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="n">companies_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="FundingRoundsAgent-309"><a href="#FundingRoundsAgent-309"><span class="linenos"> 309</span></a>            <span class="n">company_uuids</span> <span class="o">=</span> <span class="n">companies_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uuids&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="FundingRoundsAgent-310"><a href="#FundingRoundsAgent-310"><span class="linenos"> 310</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-311"><a href="#FundingRoundsAgent-311"><span class="linenos"> 311</span></a>            <span class="c1"># Fallback: empty dict structure</span>
</span><span id="FundingRoundsAgent-312"><a href="#FundingRoundsAgent-312"><span class="linenos"> 312</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-313"><a href="#FundingRoundsAgent-313"><span class="linenos"> 313</span></a>                <span class="sa">f</span><span class="s2">&quot;companies_data is unexpected type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">companies_data</span><span class="p">)</span><span class="si">}</span><span class="s2">, using empty structure&quot;</span>
</span><span id="FundingRoundsAgent-314"><a href="#FundingRoundsAgent-314"><span class="linenos"> 314</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-315"><a href="#FundingRoundsAgent-315"><span class="linenos"> 315</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-316"><a href="#FundingRoundsAgent-316"><span class="linenos"> 316</span></a>            <span class="n">company_uuids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-317"><a href="#FundingRoundsAgent-317"><span class="linenos"> 317</span></a>            <span class="n">companies_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;uuids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-318"><a href="#FundingRoundsAgent-318"><span class="linenos"> 318</span></a>
</span><span id="FundingRoundsAgent-319"><a href="#FundingRoundsAgent-319"><span class="linenos"> 319</span></a>        <span class="n">company_pool</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-320"><a href="#FundingRoundsAgent-320"><span class="linenos"> 320</span></a>
</span><span id="FundingRoundsAgent-321"><a href="#FundingRoundsAgent-321"><span class="linenos"> 321</span></a>        <span class="k">if</span> <span class="n">company_names</span> <span class="ow">or</span> <span class="n">company_uuids</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-322"><a href="#FundingRoundsAgent-322"><span class="linenos"> 322</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using pre-extracted companies for funding rounds agent&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-323"><a href="#FundingRoundsAgent-323"><span class="linenos"> 323</span></a>            <span class="n">org_uuid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent-324"><a href="#FundingRoundsAgent-324"><span class="linenos"> 324</span></a>
</span><span id="FundingRoundsAgent-325"><a href="#FundingRoundsAgent-325"><span class="linenos"> 325</span></a>            <span class="c1"># Check context to determine if this is a comparison query</span>
</span><span id="FundingRoundsAgent-326"><a href="#FundingRoundsAgent-326"><span class="linenos"> 326</span></a>            <span class="n">company_context</span> <span class="o">=</span> <span class="n">companies_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-327"><a href="#FundingRoundsAgent-327"><span class="linenos"> 327</span></a>            <span class="n">is_comparison</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-328"><a href="#FundingRoundsAgent-328"><span class="linenos"> 328</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">company_context</span>
</span><span id="FundingRoundsAgent-329"><a href="#FundingRoundsAgent-329"><span class="linenos"> 329</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="FundingRoundsAgent-330"><a href="#FundingRoundsAgent-330"><span class="linenos"> 330</span></a>                    <span class="s2">&quot;compar&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-331"><a href="#FundingRoundsAgent-331"><span class="linenos"> 331</span></a>                    <span class="s2">&quot;compare&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-332"><a href="#FundingRoundsAgent-332"><span class="linenos"> 332</span></a>                    <span class="s2">&quot;both&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-333"><a href="#FundingRoundsAgent-333"><span class="linenos"> 333</span></a>                    <span class="s2">&quot;multiple&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-334"><a href="#FundingRoundsAgent-334"><span class="linenos"> 334</span></a>                    <span class="s2">&quot;versus&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-335"><a href="#FundingRoundsAgent-335"><span class="linenos"> 335</span></a>                    <span class="s2">&quot;vs&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-336"><a href="#FundingRoundsAgent-336"><span class="linenos"> 336</span></a>                    <span class="s2">&quot;and&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-337"><a href="#FundingRoundsAgent-337"><span class="linenos"> 337</span></a>                <span class="p">]</span>
</span><span id="FundingRoundsAgent-338"><a href="#FundingRoundsAgent-338"><span class="linenos"> 338</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-339"><a href="#FundingRoundsAgent-339"><span class="linenos"> 339</span></a>            <span class="n">is_directed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-340"><a href="#FundingRoundsAgent-340"><span class="linenos"> 340</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">company_context</span>
</span><span id="FundingRoundsAgent-341"><a href="#FundingRoundsAgent-341"><span class="linenos"> 341</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;specific&quot;</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;the company&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-342"><a href="#FundingRoundsAgent-342"><span class="linenos"> 342</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-343"><a href="#FundingRoundsAgent-343"><span class="linenos"> 343</span></a>
</span><span id="FundingRoundsAgent-344"><a href="#FundingRoundsAgent-344"><span class="linenos"> 344</span></a>            <span class="c1"># For comparison queries or when multiple companies without explicit single-company context,</span>
</span><span id="FundingRoundsAgent-345"><a href="#FundingRoundsAgent-345"><span class="linenos"> 345</span></a>            <span class="c1"># don&#39;t assign org_uuid - use company_pool for fan-out</span>
</span><span id="FundingRoundsAgent-346"><a href="#FundingRoundsAgent-346"><span class="linenos"> 346</span></a>            <span class="n">should_assign_single</span> <span class="o">=</span> <span class="n">is_directed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_comparison</span>
</span><span id="FundingRoundsAgent-347"><a href="#FundingRoundsAgent-347"><span class="linenos"> 347</span></a>
</span><span id="FundingRoundsAgent-348"><a href="#FundingRoundsAgent-348"><span class="linenos"> 348</span></a>            <span class="k">if</span> <span class="n">is_comparison</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-349"><a href="#FundingRoundsAgent-349"><span class="linenos"> 349</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-350"><a href="#FundingRoundsAgent-350"><span class="linenos"> 350</span></a>                    <span class="sa">f</span><span class="s2">&quot;Comparison query detected (context: &#39;</span><span class="si">{</span><span class="n">company_context</span><span class="si">}</span><span class="s2">&#39;), &quot;</span>
</span><span id="FundingRoundsAgent-351"><a href="#FundingRoundsAgent-351"><span class="linenos"> 351</span></a>                    <span class="sa">f</span><span class="s2">&quot;using company_pool for fan-out instead of single org_uuid&quot;</span>
</span><span id="FundingRoundsAgent-352"><a href="#FundingRoundsAgent-352"><span class="linenos"> 352</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-353"><a href="#FundingRoundsAgent-353"><span class="linenos"> 353</span></a>            <span class="k">elif</span> <span class="n">should_assign_single</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-354"><a href="#FundingRoundsAgent-354"><span class="linenos"> 354</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-355"><a href="#FundingRoundsAgent-355"><span class="linenos"> 355</span></a>                    <span class="sa">f</span><span class="s2">&quot;Single company query detected (context: &#39;</span><span class="si">{</span><span class="n">company_context</span><span class="si">}</span><span class="s2">&#39;), &quot;</span>
</span><span id="FundingRoundsAgent-356"><a href="#FundingRoundsAgent-356"><span class="linenos"> 356</span></a>                    <span class="sa">f</span><span class="s2">&quot;assigning org_uuid&quot;</span>
</span><span id="FundingRoundsAgent-357"><a href="#FundingRoundsAgent-357"><span class="linenos"> 357</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-358"><a href="#FundingRoundsAgent-358"><span class="linenos"> 358</span></a>
</span><span id="FundingRoundsAgent-359"><a href="#FundingRoundsAgent-359"><span class="linenos"> 359</span></a>            <span class="k">if</span> <span class="n">company_uuids</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-360"><a href="#FundingRoundsAgent-360"><span class="linenos"> 360</span></a>                <span class="c1"># Add all UUIDs to company_pool</span>
</span><span id="FundingRoundsAgent-361"><a href="#FundingRoundsAgent-361"><span class="linenos"> 361</span></a>                <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">company_uuids</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-362"><a href="#FundingRoundsAgent-362"><span class="linenos"> 362</span></a>                    <span class="k">if</span> <span class="n">uuid</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-363"><a href="#FundingRoundsAgent-363"><span class="linenos"> 363</span></a>                        <span class="n">company_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">))</span>
</span><span id="FundingRoundsAgent-364"><a href="#FundingRoundsAgent-364"><span class="linenos"> 364</span></a>
</span><span id="FundingRoundsAgent-365"><a href="#FundingRoundsAgent-365"><span class="linenos"> 365</span></a>                <span class="c1"># Only assign single org_uuid if context indicates single company query</span>
</span><span id="FundingRoundsAgent-366"><a href="#FundingRoundsAgent-366"><span class="linenos"> 366</span></a>                <span class="k">if</span> <span class="n">should_assign_single</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_uuids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-367"><a href="#FundingRoundsAgent-367"><span class="linenos"> 367</span></a>                    <span class="n">org_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">company_uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="FundingRoundsAgent-368"><a href="#FundingRoundsAgent-368"><span class="linenos"> 368</span></a>            <span class="k">elif</span> <span class="n">company_names</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-369"><a href="#FundingRoundsAgent-369"><span class="linenos"> 369</span></a>                <span class="c1"># Resolve all company names and add to pool</span>
</span><span id="FundingRoundsAgent-370"><a href="#FundingRoundsAgent-370"><span class="linenos"> 370</span></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">company_names</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-371"><a href="#FundingRoundsAgent-371"><span class="linenos"> 371</span></a>                    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-372"><a href="#FundingRoundsAgent-372"><span class="linenos"> 372</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-373"><a href="#FundingRoundsAgent-373"><span class="linenos"> 373</span></a>                            <span class="n">orgs_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_organizations</span><span class="p">(</span><span class="n">name_ilike</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-374"><a href="#FundingRoundsAgent-374"><span class="linenos"> 374</span></a>                            <span class="k">if</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-375"><a href="#FundingRoundsAgent-375"><span class="linenos"> 375</span></a>                                <span class="n">resolved_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">))</span>
</span><span id="FundingRoundsAgent-376"><a href="#FundingRoundsAgent-376"><span class="linenos"> 376</span></a>                                <span class="k">if</span> <span class="n">resolved_uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">company_pool</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-377"><a href="#FundingRoundsAgent-377"><span class="linenos"> 377</span></a>                                    <span class="n">company_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resolved_uuid</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-378"><a href="#FundingRoundsAgent-378"><span class="linenos"> 378</span></a>
</span><span id="FundingRoundsAgent-379"><a href="#FundingRoundsAgent-379"><span class="linenos"> 379</span></a>                                <span class="c1"># Only assign to org_uuid if single company query and first name</span>
</span><span id="FundingRoundsAgent-380"><a href="#FundingRoundsAgent-380"><span class="linenos"> 380</span></a>                                <span class="k">if</span> <span class="n">should_assign_single</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">org_uuid</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-381"><a href="#FundingRoundsAgent-381"><span class="linenos"> 381</span></a>                                    <span class="n">org_uuid</span> <span class="o">=</span> <span class="n">resolved_uuid</span>
</span><span id="FundingRoundsAgent-382"><a href="#FundingRoundsAgent-382"><span class="linenos"> 382</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-383"><a href="#FundingRoundsAgent-383"><span class="linenos"> 383</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to resolve company &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-384"><a href="#FundingRoundsAgent-384"><span class="linenos"> 384</span></a>
</span><span id="FundingRoundsAgent-385"><a href="#FundingRoundsAgent-385"><span class="linenos"> 385</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-386"><a href="#FundingRoundsAgent-386"><span class="linenos"> 386</span></a>                <span class="s2">&quot;org_uuid&quot;</span><span class="p">:</span> <span class="n">org_uuid</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-387"><a href="#FundingRoundsAgent-387"><span class="linenos"> 387</span></a>                <span class="s2">&quot;company_pool&quot;</span><span class="p">:</span> <span class="n">company_pool</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-388"><a href="#FundingRoundsAgent-388"><span class="linenos"> 388</span></a>                <span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-389"><a href="#FundingRoundsAgent-389"><span class="linenos"> 389</span></a>                <span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-390"><a href="#FundingRoundsAgent-390"><span class="linenos"> 390</span></a>            <span class="p">}</span>
</span><span id="FundingRoundsAgent-391"><a href="#FundingRoundsAgent-391"><span class="linenos"> 391</span></a>
</span><span id="FundingRoundsAgent-392"><a href="#FundingRoundsAgent-392"><span class="linenos"> 392</span></a>        <span class="c1"># Use LLM to identify company names and sectors in the query</span>
</span><span id="FundingRoundsAgent-393"><a href="#FundingRoundsAgent-393"><span class="linenos"> 393</span></a>        <span class="n">identify_companies_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-394"><a href="#FundingRoundsAgent-394"><span class="linenos"> 394</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-395"><a href="#FundingRoundsAgent-395"><span class="linenos"> 395</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-396"><a href="#FundingRoundsAgent-396"><span class="linenos"> 396</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;identify_company_names&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-397"><a href="#FundingRoundsAgent-397"><span class="linenos"> 397</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Identify company names and sector/industry names mentioned in the query.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-398"><a href="#FundingRoundsAgent-398"><span class="linenos"> 398</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-399"><a href="#FundingRoundsAgent-399"><span class="linenos"> 399</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-400"><a href="#FundingRoundsAgent-400"><span class="linenos"> 400</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-401"><a href="#FundingRoundsAgent-401"><span class="linenos"> 401</span></a>                        <span class="s2">&quot;company_name&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-402"><a href="#FundingRoundsAgent-402"><span class="linenos"> 402</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-403"><a href="#FundingRoundsAgent-403"><span class="linenos"> 403</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of a specific company/organization mentioned in the query (e.g., &#39;Google&#39;, &#39;Microsoft&#39;)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-404"><a href="#FundingRoundsAgent-404"><span class="linenos"> 404</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-405"><a href="#FundingRoundsAgent-405"><span class="linenos"> 405</span></a>                        <span class="s2">&quot;sector_name&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-406"><a href="#FundingRoundsAgent-406"><span class="linenos"> 406</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-407"><a href="#FundingRoundsAgent-407"><span class="linenos"> 407</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sector or industry name mentioned in the query (e.g., &#39;AI startups&#39;, &#39;healthcare companies&#39;, &#39;fintech&#39;)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-408"><a href="#FundingRoundsAgent-408"><span class="linenos"> 408</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-409"><a href="#FundingRoundsAgent-409"><span class="linenos"> 409</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-410"><a href="#FundingRoundsAgent-410"><span class="linenos"> 410</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-411"><a href="#FundingRoundsAgent-411"><span class="linenos"> 411</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-412"><a href="#FundingRoundsAgent-412"><span class="linenos"> 412</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-413"><a href="#FundingRoundsAgent-413"><span class="linenos"> 413</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-414"><a href="#FundingRoundsAgent-414"><span class="linenos"> 414</span></a>
</span><span id="FundingRoundsAgent-415"><a href="#FundingRoundsAgent-415"><span class="linenos"> 415</span></a>        <span class="c1"># Build system prompt using prompt manager</span>
</span><span id="FundingRoundsAgent-416"><a href="#FundingRoundsAgent-416"><span class="linenos"> 416</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-417"><a href="#FundingRoundsAgent-417"><span class="linenos"> 417</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_system_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-418"><a href="#FundingRoundsAgent-418"><span class="linenos"> 418</span></a>            <span class="n">base_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identify_companies_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-419"><a href="#FundingRoundsAgent-419"><span class="linenos"> 419</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_markdown_instructions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-420"><a href="#FundingRoundsAgent-420"><span class="linenos"> 420</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-421"><a href="#FundingRoundsAgent-421"><span class="linenos"> 421</span></a>
</span><span id="FundingRoundsAgent-422"><a href="#FundingRoundsAgent-422"><span class="linenos"> 422</span></a>        <span class="c1"># Build user prompt using prompt manager</span>
</span><span id="FundingRoundsAgent-423"><a href="#FundingRoundsAgent-423"><span class="linenos"> 423</span></a>        <span class="n">user_prompt_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-424"><a href="#FundingRoundsAgent-424"><span class="linenos"> 424</span></a>
</span><span id="FundingRoundsAgent-425"><a href="#FundingRoundsAgent-425"><span class="linenos"> 425</span></a><span class="s2">Identify any company names mentioned in this query.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-426"><a href="#FundingRoundsAgent-426"><span class="linenos"> 426</span></a>
</span><span id="FundingRoundsAgent-427"><a href="#FundingRoundsAgent-427"><span class="linenos"> 427</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_user_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-428"><a href="#FundingRoundsAgent-428"><span class="linenos"> 428</span></a>            <span class="n">user_query</span><span class="o">=</span><span class="n">user_prompt_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-429"><a href="#FundingRoundsAgent-429"><span class="linenos"> 429</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-430"><a href="#FundingRoundsAgent-430"><span class="linenos"> 430</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-431"><a href="#FundingRoundsAgent-431"><span class="linenos"> 431</span></a>
</span><span id="FundingRoundsAgent-432"><a href="#FundingRoundsAgent-432"><span class="linenos"> 432</span></a>        <span class="n">resolved_uuids</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-433"><a href="#FundingRoundsAgent-433"><span class="linenos"> 433</span></a>            <span class="s2">&quot;org_uuid&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-434"><a href="#FundingRoundsAgent-434"><span class="linenos"> 434</span></a>            <span class="s2">&quot;company_pool&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-435"><a href="#FundingRoundsAgent-435"><span class="linenos"> 435</span></a>            <span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-436"><a href="#FundingRoundsAgent-436"><span class="linenos"> 436</span></a>            <span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-437"><a href="#FundingRoundsAgent-437"><span class="linenos"> 437</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-438"><a href="#FundingRoundsAgent-438"><span class="linenos"> 438</span></a>
</span><span id="FundingRoundsAgent-439"><a href="#FundingRoundsAgent-439"><span class="linenos"> 439</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-440"><a href="#FundingRoundsAgent-440"><span class="linenos"> 440</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-441"><a href="#FundingRoundsAgent-441"><span class="linenos"> 441</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-442"><a href="#FundingRoundsAgent-442"><span class="linenos"> 442</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">identify_companies_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-443"><a href="#FundingRoundsAgent-443"><span class="linenos"> 443</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-444"><a href="#FundingRoundsAgent-444"><span class="linenos"> 444</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-445"><a href="#FundingRoundsAgent-445"><span class="linenos"> 445</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-446"><a href="#FundingRoundsAgent-446"><span class="linenos"> 446</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-447"><a href="#FundingRoundsAgent-447"><span class="linenos"> 447</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-448"><a href="#FundingRoundsAgent-448"><span class="linenos"> 448</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;identify_company_names&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-449"><a href="#FundingRoundsAgent-449"><span class="linenos"> 449</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-450"><a href="#FundingRoundsAgent-450"><span class="linenos"> 450</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-451"><a href="#FundingRoundsAgent-451"><span class="linenos"> 451</span></a>
</span><span id="FundingRoundsAgent-452"><a href="#FundingRoundsAgent-452"><span class="linenos"> 452</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-453"><a href="#FundingRoundsAgent-453"><span class="linenos"> 453</span></a>                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;function_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;identify_company_names&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-454"><a href="#FundingRoundsAgent-454"><span class="linenos"> 454</span></a>                    <span class="n">args</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-455"><a href="#FundingRoundsAgent-455"><span class="linenos"> 455</span></a>                    <span class="n">company_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;company_name&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-456"><a href="#FundingRoundsAgent-456"><span class="linenos"> 456</span></a>                    <span class="n">sector_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sector_name&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-457"><a href="#FundingRoundsAgent-457"><span class="linenos"> 457</span></a>
</span><span id="FundingRoundsAgent-458"><a href="#FundingRoundsAgent-458"><span class="linenos"> 458</span></a>                    <span class="c1"># If specific company name provided, use get_organizations</span>
</span><span id="FundingRoundsAgent-459"><a href="#FundingRoundsAgent-459"><span class="linenos"> 459</span></a>                    <span class="k">if</span> <span class="n">company_name</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-460"><a href="#FundingRoundsAgent-460"><span class="linenos"> 460</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-461"><a href="#FundingRoundsAgent-461"><span class="linenos"> 461</span></a>                            <span class="n">orgs_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_organizations</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-462"><a href="#FundingRoundsAgent-462"><span class="linenos"> 462</span></a>                                <span class="n">name_ilike</span><span class="o">=</span><span class="n">company_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-463"><a href="#FundingRoundsAgent-463"><span class="linenos"> 463</span></a>                                <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Get top 3 matches</span>
</span><span id="FundingRoundsAgent-464"><a href="#FundingRoundsAgent-464"><span class="linenos"> 464</span></a>                            <span class="p">)</span>
</span><span id="FundingRoundsAgent-465"><a href="#FundingRoundsAgent-465"><span class="linenos"> 465</span></a>                            <span class="k">if</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-466"><a href="#FundingRoundsAgent-466"><span class="linenos"> 466</span></a>                                <span class="n">orgs</span> <span class="o">=</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span>
</span><span id="FundingRoundsAgent-467"><a href="#FundingRoundsAgent-467"><span class="linenos"> 467</span></a>                                <span class="k">if</span> <span class="n">orgs</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-468"><a href="#FundingRoundsAgent-468"><span class="linenos"> 468</span></a>                                    <span class="c1"># Use the top match - convert UUID to string</span>
</span><span id="FundingRoundsAgent-469"><a href="#FundingRoundsAgent-469"><span class="linenos"> 469</span></a>                                    <span class="n">org_uuid</span> <span class="o">=</span> <span class="n">orgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-470"><a href="#FundingRoundsAgent-470"><span class="linenos"> 470</span></a>                                    <span class="n">resolved_uuid_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">org_uuid</span><span class="p">)</span> <span class="k">if</span> <span class="n">org_uuid</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent-471"><a href="#FundingRoundsAgent-471"><span class="linenos"> 471</span></a>                                    <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_uuid_str</span>
</span><span id="FundingRoundsAgent-472"><a href="#FundingRoundsAgent-472"><span class="linenos"> 472</span></a>                                    <span class="k">if</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-473"><a href="#FundingRoundsAgent-473"><span class="linenos"> 473</span></a>                                        <span class="n">resolved_uuid_str</span>
</span><span id="FundingRoundsAgent-474"><a href="#FundingRoundsAgent-474"><span class="linenos"> 474</span></a>                                        <span class="ow">and</span> <span class="n">resolved_uuid_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-475"><a href="#FundingRoundsAgent-475"><span class="linenos"> 475</span></a>                                    <span class="p">):</span>
</span><span id="FundingRoundsAgent-476"><a href="#FundingRoundsAgent-476"><span class="linenos"> 476</span></a>                                        <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resolved_uuid_str</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-477"><a href="#FundingRoundsAgent-477"><span class="linenos"> 477</span></a>                                    <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-478"><a href="#FundingRoundsAgent-478"><span class="linenos"> 478</span></a>                                        <span class="p">{</span>
</span><span id="FundingRoundsAgent-479"><a href="#FundingRoundsAgent-479"><span class="linenos"> 479</span></a>                                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-480"><a href="#FundingRoundsAgent-480"><span class="linenos"> 480</span></a>                                                <span class="s2">&quot;name_ilike&quot;</span><span class="p">:</span> <span class="n">company_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-481"><a href="#FundingRoundsAgent-481"><span class="linenos"> 481</span></a>                                                <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-482"><a href="#FundingRoundsAgent-482"><span class="linenos"> 482</span></a>                                            <span class="p">},</span>
</span><span id="FundingRoundsAgent-483"><a href="#FundingRoundsAgent-483"><span class="linenos"> 483</span></a>                                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-484"><a href="#FundingRoundsAgent-484"><span class="linenos"> 484</span></a>                                                <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orgs</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-485"><a href="#FundingRoundsAgent-485"><span class="linenos"> 485</span></a>                                                <span class="s2">&quot;matched_uuid&quot;</span><span class="p">:</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-486"><a href="#FundingRoundsAgent-486"><span class="linenos"> 486</span></a>                                                <span class="s2">&quot;matched_name&quot;</span><span class="p">:</span> <span class="n">orgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-487"><a href="#FundingRoundsAgent-487"><span class="linenos"> 487</span></a>                                                <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-488"><a href="#FundingRoundsAgent-488"><span class="linenos"> 488</span></a>                                            <span class="p">},</span>
</span><span id="FundingRoundsAgent-489"><a href="#FundingRoundsAgent-489"><span class="linenos"> 489</span></a>                                        <span class="p">}</span>
</span><span id="FundingRoundsAgent-490"><a href="#FundingRoundsAgent-490"><span class="linenos"> 490</span></a>                                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-491"><a href="#FundingRoundsAgent-491"><span class="linenos"> 491</span></a>                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-492"><a href="#FundingRoundsAgent-492"><span class="linenos"> 492</span></a>                                        <span class="sa">f</span><span class="s2">&quot;Resolved organization &#39;</span><span class="si">{</span><span class="n">company_name</span><span class="si">}</span><span class="s2">&#39; to UUID: </span><span class="si">{</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s1">&#39;org_uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-493"><a href="#FundingRoundsAgent-493"><span class="linenos"> 493</span></a>                                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-494"><a href="#FundingRoundsAgent-494"><span class="linenos"> 494</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-495"><a href="#FundingRoundsAgent-495"><span class="linenos"> 495</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-496"><a href="#FundingRoundsAgent-496"><span class="linenos"> 496</span></a>                                    <span class="sa">f</span><span class="s2">&quot;get_organizations failed for organization &#39;</span><span class="si">{</span><span class="n">company_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">orgs_output</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-497"><a href="#FundingRoundsAgent-497"><span class="linenos"> 497</span></a>                                <span class="p">)</span>
</span><span id="FundingRoundsAgent-498"><a href="#FundingRoundsAgent-498"><span class="linenos"> 498</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-499"><a href="#FundingRoundsAgent-499"><span class="linenos"> 499</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-500"><a href="#FundingRoundsAgent-500"><span class="linenos"> 500</span></a>                                <span class="sa">f</span><span class="s2">&quot;Failed to resolve organization name &#39;</span><span class="si">{</span><span class="n">company_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-501"><a href="#FundingRoundsAgent-501"><span class="linenos"> 501</span></a>                            <span class="p">)</span>
</span><span id="FundingRoundsAgent-502"><a href="#FundingRoundsAgent-502"><span class="linenos"> 502</span></a>
</span><span id="FundingRoundsAgent-503"><a href="#FundingRoundsAgent-503"><span class="linenos"> 503</span></a>                    <span class="c1"># If sector name provided, use semantic search (but don&#39;t resolve to UUID - this is for sector queries)</span>
</span><span id="FundingRoundsAgent-504"><a href="#FundingRoundsAgent-504"><span class="linenos"> 504</span></a>                    <span class="k">if</span> <span class="n">sector_name</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-505"><a href="#FundingRoundsAgent-505"><span class="linenos"> 505</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-506"><a href="#FundingRoundsAgent-506"><span class="linenos"> 506</span></a>                            <span class="n">orgs_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">semantic_search_organizations</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-507"><a href="#FundingRoundsAgent-507"><span class="linenos"> 507</span></a>                                <span class="n">text</span><span class="o">=</span><span class="n">sector_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-508"><a href="#FundingRoundsAgent-508"><span class="linenos"> 508</span></a>                                <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Get more results for sector queries</span>
</span><span id="FundingRoundsAgent-509"><a href="#FundingRoundsAgent-509"><span class="linenos"> 509</span></a>                            <span class="p">)</span>
</span><span id="FundingRoundsAgent-510"><a href="#FundingRoundsAgent-510"><span class="linenos"> 510</span></a>                            <span class="k">if</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-511"><a href="#FundingRoundsAgent-511"><span class="linenos"> 511</span></a>                                <span class="n">orgs</span> <span class="o">=</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">result</span>
</span><span id="FundingRoundsAgent-512"><a href="#FundingRoundsAgent-512"><span class="linenos"> 512</span></a>                                <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-513"><a href="#FundingRoundsAgent-513"><span class="linenos"> 513</span></a>                                    <span class="p">{</span>
</span><span id="FundingRoundsAgent-514"><a href="#FundingRoundsAgent-514"><span class="linenos"> 514</span></a>                                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-515"><a href="#FundingRoundsAgent-515"><span class="linenos"> 515</span></a>                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">sector_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-516"><a href="#FundingRoundsAgent-516"><span class="linenos"> 516</span></a>                                            <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-517"><a href="#FundingRoundsAgent-517"><span class="linenos"> 517</span></a>                                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-518"><a href="#FundingRoundsAgent-518"><span class="linenos"> 518</span></a>                                        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-519"><a href="#FundingRoundsAgent-519"><span class="linenos"> 519</span></a>                                            <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orgs</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-520"><a href="#FundingRoundsAgent-520"><span class="linenos"> 520</span></a>                                            <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">orgs_output</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-521"><a href="#FundingRoundsAgent-521"><span class="linenos"> 521</span></a>                                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-522"><a href="#FundingRoundsAgent-522"><span class="linenos"> 522</span></a>                                    <span class="p">}</span>
</span><span id="FundingRoundsAgent-523"><a href="#FundingRoundsAgent-523"><span class="linenos"> 523</span></a>                                <span class="p">)</span>
</span><span id="FundingRoundsAgent-524"><a href="#FundingRoundsAgent-524"><span class="linenos"> 524</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-525"><a href="#FundingRoundsAgent-525"><span class="linenos"> 525</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">orgs</span><span class="p">)</span><span class="si">}</span><span class="s2"> organizations in sector &#39;</span><span class="si">{</span><span class="n">sector_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="FundingRoundsAgent-526"><a href="#FundingRoundsAgent-526"><span class="linenos"> 526</span></a>                                <span class="p">)</span>
</span><span id="FundingRoundsAgent-527"><a href="#FundingRoundsAgent-527"><span class="linenos"> 527</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-528"><a href="#FundingRoundsAgent-528"><span class="linenos"> 528</span></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-529"><a href="#FundingRoundsAgent-529"><span class="linenos"> 529</span></a>                                    <span class="sa">f</span><span class="s2">&quot;Semantic search failed for sector &#39;</span><span class="si">{</span><span class="n">sector_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">orgs_output</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-530"><a href="#FundingRoundsAgent-530"><span class="linenos"> 530</span></a>                                <span class="p">)</span>
</span><span id="FundingRoundsAgent-531"><a href="#FundingRoundsAgent-531"><span class="linenos"> 531</span></a>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-532"><a href="#FundingRoundsAgent-532"><span class="linenos"> 532</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to search sector &#39;</span><span class="si">{</span><span class="n">sector_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-533"><a href="#FundingRoundsAgent-533"><span class="linenos"> 533</span></a>
</span><span id="FundingRoundsAgent-534"><a href="#FundingRoundsAgent-534"><span class="linenos"> 534</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-535"><a href="#FundingRoundsAgent-535"><span class="linenos"> 535</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to identify/resolve company names: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-536"><a href="#FundingRoundsAgent-536"><span class="linenos"> 536</span></a>            <span class="c1"># Continue without resolved UUIDs - agent can still search by other criteria</span>
</span><span id="FundingRoundsAgent-537"><a href="#FundingRoundsAgent-537"><span class="linenos"> 537</span></a>
</span><span id="FundingRoundsAgent-538"><a href="#FundingRoundsAgent-538"><span class="linenos"> 538</span></a>        <span class="k">return</span> <span class="n">resolved_uuids</span>
</span><span id="FundingRoundsAgent-539"><a href="#FundingRoundsAgent-539"><span class="linenos"> 539</span></a>
</span><span id="FundingRoundsAgent-540"><a href="#FundingRoundsAgent-540"><span class="linenos"> 540</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fanout_funding_rounds</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-541"><a href="#FundingRoundsAgent-541"><span class="linenos"> 541</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-542"><a href="#FundingRoundsAgent-542"><span class="linenos"> 542</span></a>        <span class="n">company_pool</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-543"><a href="#FundingRoundsAgent-543"><span class="linenos"> 543</span></a>        <span class="n">base_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-544"><a href="#FundingRoundsAgent-544"><span class="linenos"> 544</span></a>        <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-545"><a href="#FundingRoundsAgent-545"><span class="linenos"> 545</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span id="FundingRoundsAgent-546"><a href="#FundingRoundsAgent-546"><span class="linenos"> 546</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute get_funding_rounds per company concurrently with bounded fan-out.</span>
</span><span id="FundingRoundsAgent-547"><a href="#FundingRoundsAgent-547"><span class="linenos"> 547</span></a>
</span><span id="FundingRoundsAgent-548"><a href="#FundingRoundsAgent-548"><span class="linenos"> 548</span></a><span class="sd">        Returns a tuple of (flattened_funding_rounds, tool_calls_metadata).</span>
</span><span id="FundingRoundsAgent-549"><a href="#FundingRoundsAgent-549"><span class="linenos"> 549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-550"><a href="#FundingRoundsAgent-550"><span class="linenos"> 550</span></a>        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-551"><a href="#FundingRoundsAgent-551"><span class="linenos"> 551</span></a>        <span class="n">funding_rounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-552"><a href="#FundingRoundsAgent-552"><span class="linenos"> 552</span></a>        <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-553"><a href="#FundingRoundsAgent-553"><span class="linenos"> 553</span></a>
</span><span id="FundingRoundsAgent-554"><a href="#FundingRoundsAgent-554"><span class="linenos"> 554</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="n">company_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-555"><a href="#FundingRoundsAgent-555"><span class="linenos"> 555</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">base_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;org_uuid&quot;</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-556"><a href="#FundingRoundsAgent-556"><span class="linenos"> 556</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">company_uuid</span>
</span><span id="FundingRoundsAgent-557"><a href="#FundingRoundsAgent-557"><span class="linenos"> 557</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;include_organizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FundingRoundsAgent-558"><a href="#FundingRoundsAgent-558"><span class="linenos"> 558</span></a>
</span><span id="FundingRoundsAgent-559"><a href="#FundingRoundsAgent-559"><span class="linenos"> 559</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-560"><a href="#FundingRoundsAgent-560"><span class="linenos"> 560</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_funding_rounds</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-561"><a href="#FundingRoundsAgent-561"><span class="linenos"> 561</span></a>
</span><span id="FundingRoundsAgent-562"><a href="#FundingRoundsAgent-562"><span class="linenos"> 562</span></a>            <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-563"><a href="#FundingRoundsAgent-563"><span class="linenos"> 563</span></a>                <span class="p">{</span>
</span><span id="FundingRoundsAgent-564"><a href="#FundingRoundsAgent-564"><span class="linenos"> 564</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-565"><a href="#FundingRoundsAgent-565"><span class="linenos"> 565</span></a>                    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-566"><a href="#FundingRoundsAgent-566"><span class="linenos"> 566</span></a>                    <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-567"><a href="#FundingRoundsAgent-567"><span class="linenos"> 567</span></a>                        <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-568"><a href="#FundingRoundsAgent-568"><span class="linenos"> 568</span></a>                        <span class="s2">&quot;sample_ids&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-569"><a href="#FundingRoundsAgent-569"><span class="linenos"> 569</span></a>                            <span class="p">[</span><span class="n">fr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funding_round_uuid&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="ow">or</span> <span class="p">[])[:</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="FundingRoundsAgent-570"><a href="#FundingRoundsAgent-570"><span class="linenos"> 570</span></a>                            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span>
</span><span id="FundingRoundsAgent-571"><a href="#FundingRoundsAgent-571"><span class="linenos"> 571</span></a>                            <span class="k">else</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-572"><a href="#FundingRoundsAgent-572"><span class="linenos"> 572</span></a>                        <span class="p">),</span>
</span><span id="FundingRoundsAgent-573"><a href="#FundingRoundsAgent-573"><span class="linenos"> 573</span></a>                        <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-574"><a href="#FundingRoundsAgent-574"><span class="linenos"> 574</span></a>                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-575"><a href="#FundingRoundsAgent-575"><span class="linenos"> 575</span></a>                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-576"><a href="#FundingRoundsAgent-576"><span class="linenos"> 576</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-577"><a href="#FundingRoundsAgent-577"><span class="linenos"> 577</span></a>                    <span class="s2">&quot;source_company_uuid&quot;</span><span class="p">:</span> <span class="n">company_uuid</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-578"><a href="#FundingRoundsAgent-578"><span class="linenos"> 578</span></a>                <span class="p">}</span>
</span><span id="FundingRoundsAgent-579"><a href="#FundingRoundsAgent-579"><span class="linenos"> 579</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-580"><a href="#FundingRoundsAgent-580"><span class="linenos"> 580</span></a>
</span><span id="FundingRoundsAgent-581"><a href="#FundingRoundsAgent-581"><span class="linenos"> 581</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-582"><a href="#FundingRoundsAgent-582"><span class="linenos"> 582</span></a>                <span class="n">funding_rounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-583"><a href="#FundingRoundsAgent-583"><span class="linenos"> 583</span></a>
</span><span id="FundingRoundsAgent-584"><a href="#FundingRoundsAgent-584"><span class="linenos"> 584</span></a>        <span class="c1"># Deduplicate company UUIDs to avoid double calls</span>
</span><span id="FundingRoundsAgent-585"><a href="#FundingRoundsAgent-585"><span class="linenos"> 585</span></a>        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-586"><a href="#FundingRoundsAgent-586"><span class="linenos"> 586</span></a>        <span class="n">unique_pool</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-587"><a href="#FundingRoundsAgent-587"><span class="linenos"> 587</span></a>        <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">company_pool</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-588"><a href="#FundingRoundsAgent-588"><span class="linenos"> 588</span></a>            <span class="k">if</span> <span class="n">uuid</span> <span class="ow">and</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-589"><a href="#FundingRoundsAgent-589"><span class="linenos"> 589</span></a>                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-590"><a href="#FundingRoundsAgent-590"><span class="linenos"> 590</span></a>                <span class="n">unique_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-591"><a href="#FundingRoundsAgent-591"><span class="linenos"> 591</span></a>
</span><span id="FundingRoundsAgent-592"><a href="#FundingRoundsAgent-592"><span class="linenos"> 592</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_run</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span> <span class="k">for</span> <span class="n">uuid</span> <span class="ow">in</span> <span class="n">unique_pool</span><span class="p">])</span>
</span><span id="FundingRoundsAgent-593"><a href="#FundingRoundsAgent-593"><span class="linenos"> 593</span></a>
</span><span id="FundingRoundsAgent-594"><a href="#FundingRoundsAgent-594"><span class="linenos"> 594</span></a>        <span class="k">return</span> <span class="n">funding_rounds</span><span class="p">,</span> <span class="n">tool_calls</span>
</span><span id="FundingRoundsAgent-595"><a href="#FundingRoundsAgent-595"><span class="linenos"> 595</span></a>
</span><span id="FundingRoundsAgent-596"><a href="#FundingRoundsAgent-596"><span class="linenos"> 596</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_classify_query_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-597"><a href="#FundingRoundsAgent-597"><span class="linenos"> 597</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Use LLM to classify the query type.</span>
</span><span id="FundingRoundsAgent-598"><a href="#FundingRoundsAgent-598"><span class="linenos"> 598</span></a>
</span><span id="FundingRoundsAgent-599"><a href="#FundingRoundsAgent-599"><span class="linenos"> 599</span></a><span class="sd">        Determines whether the query is asking for:</span>
</span><span id="FundingRoundsAgent-600"><a href="#FundingRoundsAgent-600"><span class="linenos"> 600</span></a><span class="sd">        - investor_portfolio: Finding companies an investor has funded (portfolio query)</span>
</span><span id="FundingRoundsAgent-601"><a href="#FundingRoundsAgent-601"><span class="linenos"> 601</span></a><span class="sd">        - funding_rounds: Finding funding rounds for companies or other funding round queries</span>
</span><span id="FundingRoundsAgent-602"><a href="#FundingRoundsAgent-602"><span class="linenos"> 602</span></a>
</span><span id="FundingRoundsAgent-603"><a href="#FundingRoundsAgent-603"><span class="linenos"> 603</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-604"><a href="#FundingRoundsAgent-604"><span class="linenos"> 604</span></a><span class="sd">            context: The agent context containing the user query.</span>
</span><span id="FundingRoundsAgent-605"><a href="#FundingRoundsAgent-605"><span class="linenos"> 605</span></a>
</span><span id="FundingRoundsAgent-606"><a href="#FundingRoundsAgent-606"><span class="linenos"> 606</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-607"><a href="#FundingRoundsAgent-607"><span class="linenos"> 607</span></a><span class="sd">            &quot;investor_portfolio&quot; if the query is about finding an investor&#39;s portfolio,</span>
</span><span id="FundingRoundsAgent-608"><a href="#FundingRoundsAgent-608"><span class="linenos"> 608</span></a><span class="sd">            &quot;funding_rounds&quot; otherwise.</span>
</span><span id="FundingRoundsAgent-609"><a href="#FundingRoundsAgent-609"><span class="linenos"> 609</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-610"><a href="#FundingRoundsAgent-610"><span class="linenos"> 610</span></a>        <span class="n">classify_query_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-611"><a href="#FundingRoundsAgent-611"><span class="linenos"> 611</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-612"><a href="#FundingRoundsAgent-612"><span class="linenos"> 612</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-613"><a href="#FundingRoundsAgent-613"><span class="linenos"> 613</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;classify_funding_query&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-614"><a href="#FundingRoundsAgent-614"><span class="linenos"> 614</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Classify a funding-related query to determine the appropriate tool to use.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-615"><a href="#FundingRoundsAgent-615"><span class="linenos"> 615</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-616"><a href="#FundingRoundsAgent-616"><span class="linenos"> 616</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-617"><a href="#FundingRoundsAgent-617"><span class="linenos"> 617</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-618"><a href="#FundingRoundsAgent-618"><span class="linenos"> 618</span></a>                        <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-619"><a href="#FundingRoundsAgent-619"><span class="linenos"> 619</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-620"><a href="#FundingRoundsAgent-620"><span class="linenos"> 620</span></a>                            <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;investor_portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_rounds&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-621"><a href="#FundingRoundsAgent-621"><span class="linenos"> 621</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Type of query: &#39;investor_portfolio&#39; if asking about companies an investor has funded (e.g., &#39;What companies has Sequoia invested in?&#39;, &#39;Show me Y Combinator&#39;s portfolio&#39;), &#39;funding_rounds&#39; for queries about funding rounds for companies, funding amounts, stages, dates, etc. (e.g., &#39;What funding rounds did Google raise?&#39;, &#39;Show me Series A rounds in 2023&#39;).&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-622"><a href="#FundingRoundsAgent-622"><span class="linenos"> 622</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-623"><a href="#FundingRoundsAgent-623"><span class="linenos"> 623</span></a>                        <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-624"><a href="#FundingRoundsAgent-624"><span class="linenos"> 624</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-625"><a href="#FundingRoundsAgent-625"><span class="linenos"> 625</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Brief explanation of why this query type was chosen.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-626"><a href="#FundingRoundsAgent-626"><span class="linenos"> 626</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-627"><a href="#FundingRoundsAgent-627"><span class="linenos"> 627</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-628"><a href="#FundingRoundsAgent-628"><span class="linenos"> 628</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;query_type&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-629"><a href="#FundingRoundsAgent-629"><span class="linenos"> 629</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-630"><a href="#FundingRoundsAgent-630"><span class="linenos"> 630</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-631"><a href="#FundingRoundsAgent-631"><span class="linenos"> 631</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-632"><a href="#FundingRoundsAgent-632"><span class="linenos"> 632</span></a>
</span><span id="FundingRoundsAgent-633"><a href="#FundingRoundsAgent-633"><span class="linenos"> 633</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a query classifier for a funding rounds analysis system. Your job is to determine whether a query is asking for:</span>
</span><span id="FundingRoundsAgent-634"><a href="#FundingRoundsAgent-634"><span class="linenos"> 634</span></a><span class="s2">1. An investor&#39;s portfolio (companies they&#39;ve invested in) - use &quot;investor_portfolio&quot;</span>
</span><span id="FundingRoundsAgent-635"><a href="#FundingRoundsAgent-635"><span class="linenos"> 635</span></a><span class="s2">2. Funding rounds information (rounds for companies, amounts, stages, dates) - use &quot;funding_rounds&quot;</span>
</span><span id="FundingRoundsAgent-636"><a href="#FundingRoundsAgent-636"><span class="linenos"> 636</span></a>
</span><span id="FundingRoundsAgent-637"><a href="#FundingRoundsAgent-637"><span class="linenos"> 637</span></a><span class="s2">Key distinctions:</span>
</span><span id="FundingRoundsAgent-638"><a href="#FundingRoundsAgent-638"><span class="linenos"> 638</span></a><span class="s2">- &quot;What companies has [investor] invested in?&quot; → investor_portfolio</span>
</span><span id="FundingRoundsAgent-639"><a href="#FundingRoundsAgent-639"><span class="linenos"> 639</span></a><span class="s2">- &quot;[Investor] portfolio&quot; → investor_portfolio</span>
</span><span id="FundingRoundsAgent-640"><a href="#FundingRoundsAgent-640"><span class="linenos"> 640</span></a><span class="s2">- &quot;Companies [investor] has funded&quot; → investor_portfolio</span>
</span><span id="FundingRoundsAgent-641"><a href="#FundingRoundsAgent-641"><span class="linenos"> 641</span></a><span class="s2">- &quot;What funding rounds did [company] raise?&quot; → funding_rounds</span>
</span><span id="FundingRoundsAgent-642"><a href="#FundingRoundsAgent-642"><span class="linenos"> 642</span></a><span class="s2">- &quot;Show me Series A rounds&quot; → funding_rounds</span>
</span><span id="FundingRoundsAgent-643"><a href="#FundingRoundsAgent-643"><span class="linenos"> 643</span></a><span class="s2">- &quot;Funding rounds in 2023&quot; → funding_rounds</span>
</span><span id="FundingRoundsAgent-644"><a href="#FundingRoundsAgent-644"><span class="linenos"> 644</span></a><span class="s2">- &quot;How much did [company] raise?&quot; → funding_rounds</span>
</span><span id="FundingRoundsAgent-645"><a href="#FundingRoundsAgent-645"><span class="linenos"> 645</span></a>
</span><span id="FundingRoundsAgent-646"><a href="#FundingRoundsAgent-646"><span class="linenos"> 646</span></a><span class="s2">When in doubt, prefer &quot;funding_rounds&quot; as it&#39;s the more general case.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-647"><a href="#FundingRoundsAgent-647"><span class="linenos"> 647</span></a>
</span><span id="FundingRoundsAgent-648"><a href="#FundingRoundsAgent-648"><span class="linenos"> 648</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Classify this query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-649"><a href="#FundingRoundsAgent-649"><span class="linenos"> 649</span></a>
</span><span id="FundingRoundsAgent-650"><a href="#FundingRoundsAgent-650"><span class="linenos"> 650</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-651"><a href="#FundingRoundsAgent-651"><span class="linenos"> 651</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-652"><a href="#FundingRoundsAgent-652"><span class="linenos"> 652</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-653"><a href="#FundingRoundsAgent-653"><span class="linenos"> 653</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">classify_query_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-654"><a href="#FundingRoundsAgent-654"><span class="linenos"> 654</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-655"><a href="#FundingRoundsAgent-655"><span class="linenos"> 655</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-656"><a href="#FundingRoundsAgent-656"><span class="linenos"> 656</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Low temperature for consistent classification</span>
</span><span id="FundingRoundsAgent-657"><a href="#FundingRoundsAgent-657"><span class="linenos"> 657</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-658"><a href="#FundingRoundsAgent-658"><span class="linenos"> 658</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-659"><a href="#FundingRoundsAgent-659"><span class="linenos"> 659</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;classify_funding_query&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-660"><a href="#FundingRoundsAgent-660"><span class="linenos"> 660</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-661"><a href="#FundingRoundsAgent-661"><span class="linenos"> 661</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-662"><a href="#FundingRoundsAgent-662"><span class="linenos"> 662</span></a>
</span><span id="FundingRoundsAgent-663"><a href="#FundingRoundsAgent-663"><span class="linenos"> 663</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-664"><a href="#FundingRoundsAgent-664"><span class="linenos"> 664</span></a>                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;function_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;classify_funding_query&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-665"><a href="#FundingRoundsAgent-665"><span class="linenos"> 665</span></a>                    <span class="n">query_type</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_type&quot;</span><span class="p">,</span> <span class="s2">&quot;funding_rounds&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-666"><a href="#FundingRoundsAgent-666"><span class="linenos"> 666</span></a>                    <span class="n">reasoning</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-667"><a href="#FundingRoundsAgent-667"><span class="linenos"> 667</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query classified as &#39;</span><span class="si">{</span><span class="n">query_type</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">reasoning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-668"><a href="#FundingRoundsAgent-668"><span class="linenos"> 668</span></a>                    <span class="k">return</span> <span class="n">query_type</span>
</span><span id="FundingRoundsAgent-669"><a href="#FundingRoundsAgent-669"><span class="linenos"> 669</span></a>
</span><span id="FundingRoundsAgent-670"><a href="#FundingRoundsAgent-670"><span class="linenos"> 670</span></a>            <span class="c1"># Default to funding_rounds if classification fails</span>
</span><span id="FundingRoundsAgent-671"><a href="#FundingRoundsAgent-671"><span class="linenos"> 671</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Query classification failed, defaulting to funding_rounds&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-672"><a href="#FundingRoundsAgent-672"><span class="linenos"> 672</span></a>            <span class="k">return</span> <span class="s2">&quot;funding_rounds&quot;</span>
</span><span id="FundingRoundsAgent-673"><a href="#FundingRoundsAgent-673"><span class="linenos"> 673</span></a>
</span><span id="FundingRoundsAgent-674"><a href="#FundingRoundsAgent-674"><span class="linenos"> 674</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-675"><a href="#FundingRoundsAgent-675"><span class="linenos"> 675</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-676"><a href="#FundingRoundsAgent-676"><span class="linenos"> 676</span></a>                <span class="sa">f</span><span class="s2">&quot;Query classification error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, defaulting to funding_rounds&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-677"><a href="#FundingRoundsAgent-677"><span class="linenos"> 677</span></a>                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-678"><a href="#FundingRoundsAgent-678"><span class="linenos"> 678</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-679"><a href="#FundingRoundsAgent-679"><span class="linenos"> 679</span></a>            <span class="k">return</span> <span class="s2">&quot;funding_rounds&quot;</span>
</span><span id="FundingRoundsAgent-680"><a href="#FundingRoundsAgent-680"><span class="linenos"> 680</span></a>
</span><span id="FundingRoundsAgent-681"><a href="#FundingRoundsAgent-681"><span class="linenos"> 681</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fanout_investor_portfolios</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-682"><a href="#FundingRoundsAgent-682"><span class="linenos"> 682</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-683"><a href="#FundingRoundsAgent-683"><span class="linenos"> 683</span></a>        <span class="n">investor_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-684"><a href="#FundingRoundsAgent-684"><span class="linenos"> 684</span></a>        <span class="n">base_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-685"><a href="#FundingRoundsAgent-685"><span class="linenos"> 685</span></a>        <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-686"><a href="#FundingRoundsAgent-686"><span class="linenos"> 686</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
</span><span id="FundingRoundsAgent-687"><a href="#FundingRoundsAgent-687"><span class="linenos"> 687</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute find_investor_portfolio per investor concurrently with bounded fan-out.</span>
</span><span id="FundingRoundsAgent-688"><a href="#FundingRoundsAgent-688"><span class="linenos"> 688</span></a>
</span><span id="FundingRoundsAgent-689"><a href="#FundingRoundsAgent-689"><span class="linenos"> 689</span></a><span class="sd">        Returns a tuple of (portfolio_results, tool_calls_metadata).</span>
</span><span id="FundingRoundsAgent-690"><a href="#FundingRoundsAgent-690"><span class="linenos"> 690</span></a><span class="sd">        Each portfolio_result is a dict with &#39;investor_name&#39; and &#39;portfolio_data&#39;.</span>
</span><span id="FundingRoundsAgent-691"><a href="#FundingRoundsAgent-691"><span class="linenos"> 691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-692"><a href="#FundingRoundsAgent-692"><span class="linenos"> 692</span></a>        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-693"><a href="#FundingRoundsAgent-693"><span class="linenos"> 693</span></a>        <span class="n">portfolio_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-694"><a href="#FundingRoundsAgent-694"><span class="linenos"> 694</span></a>        <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-695"><a href="#FundingRoundsAgent-695"><span class="linenos"> 695</span></a>
</span><span id="FundingRoundsAgent-696"><a href="#FundingRoundsAgent-696"><span class="linenos"> 696</span></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="n">investor_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-697"><a href="#FundingRoundsAgent-697"><span class="linenos"> 697</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-698"><a href="#FundingRoundsAgent-698"><span class="linenos"> 698</span></a>                <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-699"><a href="#FundingRoundsAgent-699"><span class="linenos"> 699</span></a>                <span class="s2">&quot;time_period_start&quot;</span><span class="p">:</span> <span class="n">base_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period_start&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-700"><a href="#FundingRoundsAgent-700"><span class="linenos"> 700</span></a>                <span class="s2">&quot;time_period_end&quot;</span><span class="p">:</span> <span class="n">base_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period_end&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-701"><a href="#FundingRoundsAgent-701"><span class="linenos"> 701</span></a>                <span class="s2">&quot;include_lead_only&quot;</span><span class="p">:</span> <span class="n">base_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_lead_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-702"><a href="#FundingRoundsAgent-702"><span class="linenos"> 702</span></a>            <span class="p">}</span>
</span><span id="FundingRoundsAgent-703"><a href="#FundingRoundsAgent-703"><span class="linenos"> 703</span></a>
</span><span id="FundingRoundsAgent-704"><a href="#FundingRoundsAgent-704"><span class="linenos"> 704</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-705"><a href="#FundingRoundsAgent-705"><span class="linenos"> 705</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">find_investor_portfolio</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-706"><a href="#FundingRoundsAgent-706"><span class="linenos"> 706</span></a>
</span><span id="FundingRoundsAgent-707"><a href="#FundingRoundsAgent-707"><span class="linenos"> 707</span></a>            <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-708"><a href="#FundingRoundsAgent-708"><span class="linenos"> 708</span></a>                <span class="p">{</span>
</span><span id="FundingRoundsAgent-709"><a href="#FundingRoundsAgent-709"><span class="linenos"> 709</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;find_investor_portfolio&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-710"><a href="#FundingRoundsAgent-710"><span class="linenos"> 710</span></a>                    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-711"><a href="#FundingRoundsAgent-711"><span class="linenos"> 711</span></a>                    <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-712"><a href="#FundingRoundsAgent-712"><span class="linenos"> 712</span></a>                        <span class="s2">&quot;num_companies&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-713"><a href="#FundingRoundsAgent-713"><span class="linenos"> 713</span></a>                            <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-714"><a href="#FundingRoundsAgent-714"><span class="linenos"> 714</span></a>                            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span>
</span><span id="FundingRoundsAgent-715"><a href="#FundingRoundsAgent-715"><span class="linenos"> 715</span></a>                            <span class="k">else</span> <span class="mi">0</span>
</span><span id="FundingRoundsAgent-716"><a href="#FundingRoundsAgent-716"><span class="linenos"> 716</span></a>                        <span class="p">),</span>
</span><span id="FundingRoundsAgent-717"><a href="#FundingRoundsAgent-717"><span class="linenos"> 717</span></a>                        <span class="s2">&quot;num_investments&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-718"><a href="#FundingRoundsAgent-718"><span class="linenos"> 718</span></a>                            <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_investments&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-719"><a href="#FundingRoundsAgent-719"><span class="linenos"> 719</span></a>                            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span>
</span><span id="FundingRoundsAgent-720"><a href="#FundingRoundsAgent-720"><span class="linenos"> 720</span></a>                            <span class="k">else</span> <span class="mi">0</span>
</span><span id="FundingRoundsAgent-721"><a href="#FundingRoundsAgent-721"><span class="linenos"> 721</span></a>                        <span class="p">),</span>
</span><span id="FundingRoundsAgent-722"><a href="#FundingRoundsAgent-722"><span class="linenos"> 722</span></a>                        <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-723"><a href="#FundingRoundsAgent-723"><span class="linenos"> 723</span></a>                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-724"><a href="#FundingRoundsAgent-724"><span class="linenos"> 724</span></a>                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-725"><a href="#FundingRoundsAgent-725"><span class="linenos"> 725</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-726"><a href="#FundingRoundsAgent-726"><span class="linenos"> 726</span></a>                    <span class="s2">&quot;source_investor_name&quot;</span><span class="p">:</span> <span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-727"><a href="#FundingRoundsAgent-727"><span class="linenos"> 727</span></a>                <span class="p">}</span>
</span><span id="FundingRoundsAgent-728"><a href="#FundingRoundsAgent-728"><span class="linenos"> 728</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-729"><a href="#FundingRoundsAgent-729"><span class="linenos"> 729</span></a>
</span><span id="FundingRoundsAgent-730"><a href="#FundingRoundsAgent-730"><span class="linenos"> 730</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-731"><a href="#FundingRoundsAgent-731"><span class="linenos"> 731</span></a>                <span class="n">portfolio_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-732"><a href="#FundingRoundsAgent-732"><span class="linenos"> 732</span></a>                    <span class="p">{</span>
</span><span id="FundingRoundsAgent-733"><a href="#FundingRoundsAgent-733"><span class="linenos"> 733</span></a>                        <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-734"><a href="#FundingRoundsAgent-734"><span class="linenos"> 734</span></a>                        <span class="s2">&quot;portfolio_data&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-735"><a href="#FundingRoundsAgent-735"><span class="linenos"> 735</span></a>                    <span class="p">}</span>
</span><span id="FundingRoundsAgent-736"><a href="#FundingRoundsAgent-736"><span class="linenos"> 736</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-737"><a href="#FundingRoundsAgent-737"><span class="linenos"> 737</span></a>
</span><span id="FundingRoundsAgent-738"><a href="#FundingRoundsAgent-738"><span class="linenos"> 738</span></a>        <span class="c1"># Deduplicate investor names to avoid double calls</span>
</span><span id="FundingRoundsAgent-739"><a href="#FundingRoundsAgent-739"><span class="linenos"> 739</span></a>        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-740"><a href="#FundingRoundsAgent-740"><span class="linenos"> 740</span></a>        <span class="n">unique_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-741"><a href="#FundingRoundsAgent-741"><span class="linenos"> 741</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">investor_names</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-742"><a href="#FundingRoundsAgent-742"><span class="linenos"> 742</span></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-743"><a href="#FundingRoundsAgent-743"><span class="linenos"> 743</span></a>                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span><span id="FundingRoundsAgent-744"><a href="#FundingRoundsAgent-744"><span class="linenos"> 744</span></a>                <span class="n">unique_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-745"><a href="#FundingRoundsAgent-745"><span class="linenos"> 745</span></a>
</span><span id="FundingRoundsAgent-746"><a href="#FundingRoundsAgent-746"><span class="linenos"> 746</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_run</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unique_names</span><span class="p">])</span>
</span><span id="FundingRoundsAgent-747"><a href="#FundingRoundsAgent-747"><span class="linenos"> 747</span></a>
</span><span id="FundingRoundsAgent-748"><a href="#FundingRoundsAgent-748"><span class="linenos"> 748</span></a>        <span class="k">return</span> <span class="n">portfolio_results</span><span class="p">,</span> <span class="n">tool_calls</span>
</span><span id="FundingRoundsAgent-749"><a href="#FundingRoundsAgent-749"><span class="linenos"> 749</span></a>
</span><span id="FundingRoundsAgent-750"><a href="#FundingRoundsAgent-750"><span class="linenos"> 750</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_multi_investor_portfolio_query</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-751"><a href="#FundingRoundsAgent-751"><span class="linenos"> 751</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-752"><a href="#FundingRoundsAgent-752"><span class="linenos"> 752</span></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-753"><a href="#FundingRoundsAgent-753"><span class="linenos"> 753</span></a>        <span class="n">investor_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-754"><a href="#FundingRoundsAgent-754"><span class="linenos"> 754</span></a>        <span class="n">time_period_start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-755"><a href="#FundingRoundsAgent-755"><span class="linenos"> 755</span></a>        <span class="n">time_period_end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-756"><a href="#FundingRoundsAgent-756"><span class="linenos"> 756</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-757"><a href="#FundingRoundsAgent-757"><span class="linenos"> 757</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle queries about multiple investor portfolios with fan-out.</span>
</span><span id="FundingRoundsAgent-758"><a href="#FundingRoundsAgent-758"><span class="linenos"> 758</span></a>
</span><span id="FundingRoundsAgent-759"><a href="#FundingRoundsAgent-759"><span class="linenos"> 759</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-760"><a href="#FundingRoundsAgent-760"><span class="linenos"> 760</span></a><span class="sd">            context: The agent context containing the user query.</span>
</span><span id="FundingRoundsAgent-761"><a href="#FundingRoundsAgent-761"><span class="linenos"> 761</span></a><span class="sd">            investor_names: List of investor/company names to query.</span>
</span><span id="FundingRoundsAgent-762"><a href="#FundingRoundsAgent-762"><span class="linenos"> 762</span></a><span class="sd">            time_period_start: Optional start date for filtering.</span>
</span><span id="FundingRoundsAgent-763"><a href="#FundingRoundsAgent-763"><span class="linenos"> 763</span></a><span class="sd">            time_period_end: Optional end date for filtering.</span>
</span><span id="FundingRoundsAgent-764"><a href="#FundingRoundsAgent-764"><span class="linenos"> 764</span></a>
</span><span id="FundingRoundsAgent-765"><a href="#FundingRoundsAgent-765"><span class="linenos"> 765</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-766"><a href="#FundingRoundsAgent-766"><span class="linenos"> 766</span></a><span class="sd">            AgentOutput with aggregated investor portfolio information.</span>
</span><span id="FundingRoundsAgent-767"><a href="#FundingRoundsAgent-767"><span class="linenos"> 767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-768"><a href="#FundingRoundsAgent-768"><span class="linenos"> 768</span></a>        <span class="n">base_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-769"><a href="#FundingRoundsAgent-769"><span class="linenos"> 769</span></a>            <span class="s2">&quot;time_period_start&quot;</span><span class="p">:</span> <span class="n">time_period_start</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-770"><a href="#FundingRoundsAgent-770"><span class="linenos"> 770</span></a>            <span class="s2">&quot;time_period_end&quot;</span><span class="p">:</span> <span class="n">time_period_end</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-771"><a href="#FundingRoundsAgent-771"><span class="linenos"> 771</span></a>            <span class="s2">&quot;include_lead_only&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-772"><a href="#FundingRoundsAgent-772"><span class="linenos"> 772</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-773"><a href="#FundingRoundsAgent-773"><span class="linenos"> 773</span></a>
</span><span id="FundingRoundsAgent-774"><a href="#FundingRoundsAgent-774"><span class="linenos"> 774</span></a>        <span class="n">portfolio_results</span><span class="p">,</span> <span class="n">tool_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fanout_investor_portfolios</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-775"><a href="#FundingRoundsAgent-775"><span class="linenos"> 775</span></a>            <span class="n">investor_names</span><span class="o">=</span><span class="n">investor_names</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-776"><a href="#FundingRoundsAgent-776"><span class="linenos"> 776</span></a>            <span class="n">base_params</span><span class="o">=</span><span class="n">base_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-777"><a href="#FundingRoundsAgent-777"><span class="linenos"> 777</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-778"><a href="#FundingRoundsAgent-778"><span class="linenos"> 778</span></a>
</span><span id="FundingRoundsAgent-779"><a href="#FundingRoundsAgent-779"><span class="linenos"> 779</span></a>        <span class="c1"># If all fan-out calls failed, return early with error</span>
</span><span id="FundingRoundsAgent-780"><a href="#FundingRoundsAgent-780"><span class="linenos"> 780</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">portfolio_results</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-781"><a href="#FundingRoundsAgent-781"><span class="linenos"> 781</span></a>            <span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span>
</span><span id="FundingRoundsAgent-782"><a href="#FundingRoundsAgent-782"><span class="linenos"> 782</span></a>        <span class="p">):</span>
</span><span id="FundingRoundsAgent-783"><a href="#FundingRoundsAgent-783"><span class="linenos"> 783</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-784"><a href="#FundingRoundsAgent-784"><span class="linenos"> 784</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-785"><a href="#FundingRoundsAgent-785"><span class="linenos"> 785</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-786"><a href="#FundingRoundsAgent-786"><span class="linenos"> 786</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-787"><a href="#FundingRoundsAgent-787"><span class="linenos"> 787</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-788"><a href="#FundingRoundsAgent-788"><span class="linenos"> 788</span></a>                <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve investor portfolios for all investors in fan-out.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-789"><a href="#FundingRoundsAgent-789"><span class="linenos"> 789</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-790"><a href="#FundingRoundsAgent-790"><span class="linenos"> 790</span></a>
</span><span id="FundingRoundsAgent-791"><a href="#FundingRoundsAgent-791"><span class="linenos"> 791</span></a>        <span class="c1"># Format the aggregated portfolio response</span>
</span><span id="FundingRoundsAgent-792"><a href="#FundingRoundsAgent-792"><span class="linenos"> 792</span></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_multi_portfolio_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">portfolio_results</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-793"><a href="#FundingRoundsAgent-793"><span class="linenos"> 793</span></a>
</span><span id="FundingRoundsAgent-794"><a href="#FundingRoundsAgent-794"><span class="linenos"> 794</span></a>        <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-795"><a href="#FundingRoundsAgent-795"><span class="linenos"> 795</span></a>            <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-796"><a href="#FundingRoundsAgent-796"><span class="linenos"> 796</span></a>            <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-797"><a href="#FundingRoundsAgent-797"><span class="linenos"> 797</span></a>            <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-798"><a href="#FundingRoundsAgent-798"><span class="linenos"> 798</span></a>            <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-799"><a href="#FundingRoundsAgent-799"><span class="linenos"> 799</span></a>            <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-800"><a href="#FundingRoundsAgent-800"><span class="linenos"> 800</span></a>            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-801"><a href="#FundingRoundsAgent-801"><span class="linenos"> 801</span></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-802"><a href="#FundingRoundsAgent-802"><span class="linenos"> 802</span></a>                <span class="s2">&quot;investor_names&quot;</span><span class="p">:</span> <span class="n">investor_names</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-803"><a href="#FundingRoundsAgent-803"><span class="linenos"> 803</span></a>                <span class="s2">&quot;num_investors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio_results</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-804"><a href="#FundingRoundsAgent-804"><span class="linenos"> 804</span></a>                <span class="s2">&quot;portfolio_summaries&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="FundingRoundsAgent-805"><a href="#FundingRoundsAgent-805"><span class="linenos"> 805</span></a>                    <span class="p">{</span>
</span><span id="FundingRoundsAgent-806"><a href="#FundingRoundsAgent-806"><span class="linenos"> 806</span></a>                        <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="n">pr</span><span class="p">[</span><span class="s2">&quot;investor_name&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-807"><a href="#FundingRoundsAgent-807"><span class="linenos"> 807</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">pr</span><span class="p">[</span><span class="s2">&quot;portfolio_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="FundingRoundsAgent-808"><a href="#FundingRoundsAgent-808"><span class="linenos"> 808</span></a>                    <span class="p">}</span>
</span><span id="FundingRoundsAgent-809"><a href="#FundingRoundsAgent-809"><span class="linenos"> 809</span></a>                    <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">portfolio_results</span>
</span><span id="FundingRoundsAgent-810"><a href="#FundingRoundsAgent-810"><span class="linenos"> 810</span></a>                <span class="p">],</span>
</span><span id="FundingRoundsAgent-811"><a href="#FundingRoundsAgent-811"><span class="linenos"> 811</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-812"><a href="#FundingRoundsAgent-812"><span class="linenos"> 812</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-813"><a href="#FundingRoundsAgent-813"><span class="linenos"> 813</span></a>
</span><span id="FundingRoundsAgent-814"><a href="#FundingRoundsAgent-814"><span class="linenos"> 814</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_investor_portfolio_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-815"><a href="#FundingRoundsAgent-815"><span class="linenos"> 815</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle queries about investor portfolios.</span>
</span><span id="FundingRoundsAgent-816"><a href="#FundingRoundsAgent-816"><span class="linenos"> 816</span></a>
</span><span id="FundingRoundsAgent-817"><a href="#FundingRoundsAgent-817"><span class="linenos"> 817</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-818"><a href="#FundingRoundsAgent-818"><span class="linenos"> 818</span></a><span class="sd">            context: The agent context containing the user query.</span>
</span><span id="FundingRoundsAgent-819"><a href="#FundingRoundsAgent-819"><span class="linenos"> 819</span></a>
</span><span id="FundingRoundsAgent-820"><a href="#FundingRoundsAgent-820"><span class="linenos"> 820</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-821"><a href="#FundingRoundsAgent-821"><span class="linenos"> 821</span></a><span class="sd">            AgentOutput with investor portfolio information.</span>
</span><span id="FundingRoundsAgent-822"><a href="#FundingRoundsAgent-822"><span class="linenos"> 822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-823"><a href="#FundingRoundsAgent-823"><span class="linenos"> 823</span></a>        <span class="c1"># Check for pre-extracted companies first</span>
</span><span id="FundingRoundsAgent-824"><a href="#FundingRoundsAgent-824"><span class="linenos"> 824</span></a>        <span class="n">extracted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;extracted_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-825"><a href="#FundingRoundsAgent-825"><span class="linenos"> 825</span></a>        <span class="n">companies_data</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;companies&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-826"><a href="#FundingRoundsAgent-826"><span class="linenos"> 826</span></a>
</span><span id="FundingRoundsAgent-827"><a href="#FundingRoundsAgent-827"><span class="linenos"> 827</span></a>        <span class="c1"># Handle both dict and list formats (defensive coding)</span>
</span><span id="FundingRoundsAgent-828"><a href="#FundingRoundsAgent-828"><span class="linenos"> 828</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-829"><a href="#FundingRoundsAgent-829"><span class="linenos"> 829</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="n">companies_data</span> <span class="k">if</span> <span class="n">companies_data</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-830"><a href="#FundingRoundsAgent-830"><span class="linenos"> 830</span></a>            <span class="n">companies_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">company_names</span><span class="p">,</span> <span class="s2">&quot;uuids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-831"><a href="#FundingRoundsAgent-831"><span class="linenos"> 831</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-832"><a href="#FundingRoundsAgent-832"><span class="linenos"> 832</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="n">companies_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="FundingRoundsAgent-833"><a href="#FundingRoundsAgent-833"><span class="linenos"> 833</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-834"><a href="#FundingRoundsAgent-834"><span class="linenos"> 834</span></a>            <span class="n">company_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-835"><a href="#FundingRoundsAgent-835"><span class="linenos"> 835</span></a>            <span class="n">companies_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;uuids&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-836"><a href="#FundingRoundsAgent-836"><span class="linenos"> 836</span></a>
</span><span id="FundingRoundsAgent-837"><a href="#FundingRoundsAgent-837"><span class="linenos"> 837</span></a>        <span class="c1"># Time period from extracted entities</span>
</span><span id="FundingRoundsAgent-838"><a href="#FundingRoundsAgent-838"><span class="linenos"> 838</span></a>        <span class="n">time_period</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-839"><a href="#FundingRoundsAgent-839"><span class="linenos"> 839</span></a>        <span class="n">time_period_start</span> <span class="o">=</span> <span class="n">time_period</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-840"><a href="#FundingRoundsAgent-840"><span class="linenos"> 840</span></a>        <span class="n">time_period_end</span> <span class="o">=</span> <span class="n">time_period</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-841"><a href="#FundingRoundsAgent-841"><span class="linenos"> 841</span></a>
</span><span id="FundingRoundsAgent-842"><a href="#FundingRoundsAgent-842"><span class="linenos"> 842</span></a>        <span class="c1"># If multiple companies identified, use fan-out</span>
</span><span id="FundingRoundsAgent-843"><a href="#FundingRoundsAgent-843"><span class="linenos"> 843</span></a>        <span class="k">if</span> <span class="n">company_names</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-844"><a href="#FundingRoundsAgent-844"><span class="linenos"> 844</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-845"><a href="#FundingRoundsAgent-845"><span class="linenos"> 845</span></a>                <span class="sa">f</span><span class="s2">&quot;Multiple investors detected (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">company_names</span><span class="p">)</span><span class="si">}</span><span class="s2">), using fan-out for investor portfolios&quot;</span>
</span><span id="FundingRoundsAgent-846"><a href="#FundingRoundsAgent-846"><span class="linenos"> 846</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-847"><a href="#FundingRoundsAgent-847"><span class="linenos"> 847</span></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_multi_investor_portfolio_query</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-848"><a href="#FundingRoundsAgent-848"><span class="linenos"> 848</span></a>                <span class="n">context</span><span class="p">,</span> <span class="n">company_names</span><span class="p">,</span> <span class="n">time_period_start</span><span class="p">,</span> <span class="n">time_period_end</span>
</span><span id="FundingRoundsAgent-849"><a href="#FundingRoundsAgent-849"><span class="linenos"> 849</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-850"><a href="#FundingRoundsAgent-850"><span class="linenos"> 850</span></a>
</span><span id="FundingRoundsAgent-851"><a href="#FundingRoundsAgent-851"><span class="linenos"> 851</span></a>        <span class="c1"># If single company identified, use it directly</span>
</span><span id="FundingRoundsAgent-852"><a href="#FundingRoundsAgent-852"><span class="linenos"> 852</span></a>        <span class="n">investor_name</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent-853"><a href="#FundingRoundsAgent-853"><span class="linenos"> 853</span></a>        <span class="k">if</span> <span class="n">company_names</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">company_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-854"><a href="#FundingRoundsAgent-854"><span class="linenos"> 854</span></a>            <span class="n">investor_name</span> <span class="o">=</span> <span class="n">company_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-855"><a href="#FundingRoundsAgent-855"><span class="linenos"> 855</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using pre-extracted investor name: </span><span class="si">{</span><span class="n">investor_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-856"><a href="#FundingRoundsAgent-856"><span class="linenos"> 856</span></a>
</span><span id="FundingRoundsAgent-857"><a href="#FundingRoundsAgent-857"><span class="linenos"> 857</span></a>        <span class="c1"># Use LLM to extract investor name and parameters if not pre-extracted</span>
</span><span id="FundingRoundsAgent-858"><a href="#FundingRoundsAgent-858"><span class="linenos"> 858</span></a>        <span class="n">extract_investor_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-859"><a href="#FundingRoundsAgent-859"><span class="linenos"> 859</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-860"><a href="#FundingRoundsAgent-860"><span class="linenos"> 860</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-861"><a href="#FundingRoundsAgent-861"><span class="linenos"> 861</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;extract_investor_query_params&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-862"><a href="#FundingRoundsAgent-862"><span class="linenos"> 862</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Extract investor name and parameters from a query about investor portfolios.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-863"><a href="#FundingRoundsAgent-863"><span class="linenos"> 863</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-864"><a href="#FundingRoundsAgent-864"><span class="linenos"> 864</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-865"><a href="#FundingRoundsAgent-865"><span class="linenos"> 865</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-866"><a href="#FundingRoundsAgent-866"><span class="linenos"> 866</span></a>                        <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-867"><a href="#FundingRoundsAgent-867"><span class="linenos"> 867</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-868"><a href="#FundingRoundsAgent-868"><span class="linenos"> 868</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Name of the investor mentioned in the query (e.g., &#39;Sequoia Capital&#39;, &#39;Andreessen Horowitz&#39;)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-869"><a href="#FundingRoundsAgent-869"><span class="linenos"> 869</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-870"><a href="#FundingRoundsAgent-870"><span class="linenos"> 870</span></a>                        <span class="s2">&quot;time_period_start&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-871"><a href="#FundingRoundsAgent-871"><span class="linenos"> 871</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-872"><a href="#FundingRoundsAgent-872"><span class="linenos"> 872</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Start date for filtering investments (ISO format, e.g., &#39;2018-01-01T00:00:00&#39;). Leave null if not mentioned.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-873"><a href="#FundingRoundsAgent-873"><span class="linenos"> 873</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-874"><a href="#FundingRoundsAgent-874"><span class="linenos"> 874</span></a>                        <span class="s2">&quot;time_period_end&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-875"><a href="#FundingRoundsAgent-875"><span class="linenos"> 875</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-876"><a href="#FundingRoundsAgent-876"><span class="linenos"> 876</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;End date for filtering investments (ISO format, e.g., &#39;2024-12-31T23:59:59&#39;). Leave null if not mentioned.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-877"><a href="#FundingRoundsAgent-877"><span class="linenos"> 877</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-878"><a href="#FundingRoundsAgent-878"><span class="linenos"> 878</span></a>                        <span class="s2">&quot;include_lead_only&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-879"><a href="#FundingRoundsAgent-879"><span class="linenos"> 879</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-880"><a href="#FundingRoundsAgent-880"><span class="linenos"> 880</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;If true, only include rounds where investor was lead. Leave null if not mentioned.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-881"><a href="#FundingRoundsAgent-881"><span class="linenos"> 881</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-882"><a href="#FundingRoundsAgent-882"><span class="linenos"> 882</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-883"><a href="#FundingRoundsAgent-883"><span class="linenos"> 883</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;investor_name&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-884"><a href="#FundingRoundsAgent-884"><span class="linenos"> 884</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-885"><a href="#FundingRoundsAgent-885"><span class="linenos"> 885</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-886"><a href="#FundingRoundsAgent-886"><span class="linenos"> 886</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-887"><a href="#FundingRoundsAgent-887"><span class="linenos"> 887</span></a>
</span><span id="FundingRoundsAgent-888"><a href="#FundingRoundsAgent-888"><span class="linenos"> 888</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are analyzing a query about an investor&#39;s portfolio. Extract the investor name and any time period or filtering criteria mentioned in the query.</span>
</span><span id="FundingRoundsAgent-889"><a href="#FundingRoundsAgent-889"><span class="linenos"> 889</span></a><span class="s2">        </span>
</span><span id="FundingRoundsAgent-890"><a href="#FundingRoundsAgent-890"><span class="linenos"> 890</span></a><span class="s2">Examples:</span>
</span><span id="FundingRoundsAgent-891"><a href="#FundingRoundsAgent-891"><span class="linenos"> 891</span></a><span class="s2">- &quot;What companies has Sequoia Capital invested in?&quot; → investor_name: &quot;Sequoia Capital&quot;</span>
</span><span id="FundingRoundsAgent-892"><a href="#FundingRoundsAgent-892"><span class="linenos"> 892</span></a><span class="s2">- &quot;Show me Andreessen Horowitz&#39;s portfolio from 2020 to 2024&quot; → investor_name: &quot;Andreessen Horowitz&quot;, time_period_start: &quot;2020-01-01T00:00:00&quot;, time_period_end: &quot;2024-12-31T23:59:59&quot;</span>
</span><span id="FundingRoundsAgent-893"><a href="#FundingRoundsAgent-893"><span class="linenos"> 893</span></a><span class="s2">- &quot;What companies did Y Combinator lead invest in?&quot; → investor_name: &quot;Y Combinator&quot;, include_lead_only: true&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-894"><a href="#FundingRoundsAgent-894"><span class="linenos"> 894</span></a>
</span><span id="FundingRoundsAgent-895"><a href="#FundingRoundsAgent-895"><span class="linenos"> 895</span></a>        <span class="c1"># If we already have investor_name from pre-extracted entities, skip LLM extraction</span>
</span><span id="FundingRoundsAgent-896"><a href="#FundingRoundsAgent-896"><span class="linenos"> 896</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">investor_name</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-897"><a href="#FundingRoundsAgent-897"><span class="linenos"> 897</span></a>            <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-898"><a href="#FundingRoundsAgent-898"><span class="linenos"> 898</span></a>
</span><span id="FundingRoundsAgent-899"><a href="#FundingRoundsAgent-899"><span class="linenos"> 899</span></a><span class="s2">Extract the investor name and any parameters from this query.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-900"><a href="#FundingRoundsAgent-900"><span class="linenos"> 900</span></a>
</span><span id="FundingRoundsAgent-901"><a href="#FundingRoundsAgent-901"><span class="linenos"> 901</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-902"><a href="#FundingRoundsAgent-902"><span class="linenos"> 902</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-903"><a href="#FundingRoundsAgent-903"><span class="linenos"> 903</span></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-904"><a href="#FundingRoundsAgent-904"><span class="linenos"> 904</span></a>                    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">extract_investor_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-905"><a href="#FundingRoundsAgent-905"><span class="linenos"> 905</span></a>                    <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-906"><a href="#FundingRoundsAgent-906"><span class="linenos"> 906</span></a>                    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-907"><a href="#FundingRoundsAgent-907"><span class="linenos"> 907</span></a>                    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-908"><a href="#FundingRoundsAgent-908"><span class="linenos"> 908</span></a>                    <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-909"><a href="#FundingRoundsAgent-909"><span class="linenos"> 909</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-910"><a href="#FundingRoundsAgent-910"><span class="linenos"> 910</span></a>                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;extract_investor_query_params&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-911"><a href="#FundingRoundsAgent-911"><span class="linenos"> 911</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-912"><a href="#FundingRoundsAgent-912"><span class="linenos"> 912</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-913"><a href="#FundingRoundsAgent-913"><span class="linenos"> 913</span></a>
</span><span id="FundingRoundsAgent-914"><a href="#FundingRoundsAgent-914"><span class="linenos"> 914</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-915"><a href="#FundingRoundsAgent-915"><span class="linenos"> 915</span></a>                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;function_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;extract_investor_query_params&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-916"><a href="#FundingRoundsAgent-916"><span class="linenos"> 916</span></a>                        <span class="n">args</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-917"><a href="#FundingRoundsAgent-917"><span class="linenos"> 917</span></a>                        <span class="n">investor_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;investor_name&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-918"><a href="#FundingRoundsAgent-918"><span class="linenos"> 918</span></a>                        <span class="c1"># Use LLM-extracted time period if not already set from pre-extracted</span>
</span><span id="FundingRoundsAgent-919"><a href="#FundingRoundsAgent-919"><span class="linenos"> 919</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_period_start</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-920"><a href="#FundingRoundsAgent-920"><span class="linenos"> 920</span></a>                            <span class="n">time_period_start</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period_start&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-921"><a href="#FundingRoundsAgent-921"><span class="linenos"> 921</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_period_end</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-922"><a href="#FundingRoundsAgent-922"><span class="linenos"> 922</span></a>                            <span class="n">time_period_end</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period_end&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-923"><a href="#FundingRoundsAgent-923"><span class="linenos"> 923</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-924"><a href="#FundingRoundsAgent-924"><span class="linenos"> 924</span></a>                    <span class="c1"># LLM extraction failed, try fallback</span>
</span><span id="FundingRoundsAgent-925"><a href="#FundingRoundsAgent-925"><span class="linenos"> 925</span></a>                    <span class="n">investor_name</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent-926"><a href="#FundingRoundsAgent-926"><span class="linenos"> 926</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-927"><a href="#FundingRoundsAgent-927"><span class="linenos"> 927</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-928"><a href="#FundingRoundsAgent-928"><span class="linenos"> 928</span></a>                    <span class="sa">f</span><span class="s2">&quot;LLM investor extraction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, using pre-extracted if available&quot;</span>
</span><span id="FundingRoundsAgent-929"><a href="#FundingRoundsAgent-929"><span class="linenos"> 929</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-930"><a href="#FundingRoundsAgent-930"><span class="linenos"> 930</span></a>
</span><span id="FundingRoundsAgent-931"><a href="#FundingRoundsAgent-931"><span class="linenos"> 931</span></a>        <span class="c1"># Now proceed with single investor query</span>
</span><span id="FundingRoundsAgent-932"><a href="#FundingRoundsAgent-932"><span class="linenos"> 932</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">investor_name</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-933"><a href="#FundingRoundsAgent-933"><span class="linenos"> 933</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-934"><a href="#FundingRoundsAgent-934"><span class="linenos"> 934</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-935"><a href="#FundingRoundsAgent-935"><span class="linenos"> 935</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-936"><a href="#FundingRoundsAgent-936"><span class="linenos"> 936</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-937"><a href="#FundingRoundsAgent-937"><span class="linenos"> 937</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-938"><a href="#FundingRoundsAgent-938"><span class="linenos"> 938</span></a>                <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Could not identify investor name in the query.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-939"><a href="#FundingRoundsAgent-939"><span class="linenos"> 939</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-940"><a href="#FundingRoundsAgent-940"><span class="linenos"> 940</span></a>
</span><span id="FundingRoundsAgent-941"><a href="#FundingRoundsAgent-941"><span class="linenos"> 941</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-942"><a href="#FundingRoundsAgent-942"><span class="linenos"> 942</span></a>            <span class="c1"># Call find_investor_portfolio tool</span>
</span><span id="FundingRoundsAgent-943"><a href="#FundingRoundsAgent-943"><span class="linenos"> 943</span></a>            <span class="n">portfolio_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">find_investor_portfolio</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-944"><a href="#FundingRoundsAgent-944"><span class="linenos"> 944</span></a>                <span class="n">investor_name</span><span class="o">=</span><span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-945"><a href="#FundingRoundsAgent-945"><span class="linenos"> 945</span></a>                <span class="n">time_period_start</span><span class="o">=</span><span class="n">time_period_start</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-946"><a href="#FundingRoundsAgent-946"><span class="linenos"> 946</span></a>                <span class="n">time_period_end</span><span class="o">=</span><span class="n">time_period_end</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-947"><a href="#FundingRoundsAgent-947"><span class="linenos"> 947</span></a>                <span class="n">include_lead_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Default to False unless specified</span>
</span><span id="FundingRoundsAgent-948"><a href="#FundingRoundsAgent-948"><span class="linenos"> 948</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-949"><a href="#FundingRoundsAgent-949"><span class="linenos"> 949</span></a>
</span><span id="FundingRoundsAgent-950"><a href="#FundingRoundsAgent-950"><span class="linenos"> 950</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">portfolio_output</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-951"><a href="#FundingRoundsAgent-951"><span class="linenos"> 951</span></a>                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">portfolio_output</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Failed to retrieve investor portfolio&quot;</span>
</span><span id="FundingRoundsAgent-952"><a href="#FundingRoundsAgent-952"><span class="linenos"> 952</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;find_investor_portfolio tool failed: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-953"><a href="#FundingRoundsAgent-953"><span class="linenos"> 953</span></a>                <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-954"><a href="#FundingRoundsAgent-954"><span class="linenos"> 954</span></a>                    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-955"><a href="#FundingRoundsAgent-955"><span class="linenos"> 955</span></a>                    <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-956"><a href="#FundingRoundsAgent-956"><span class="linenos"> 956</span></a>                    <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-957"><a href="#FundingRoundsAgent-957"><span class="linenos"> 957</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-958"><a href="#FundingRoundsAgent-958"><span class="linenos"> 958</span></a>                    <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve investor portfolio: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-959"><a href="#FundingRoundsAgent-959"><span class="linenos"> 959</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-960"><a href="#FundingRoundsAgent-960"><span class="linenos"> 960</span></a>
</span><span id="FundingRoundsAgent-961"><a href="#FundingRoundsAgent-961"><span class="linenos"> 961</span></a>            <span class="c1"># Format the portfolio response</span>
</span><span id="FundingRoundsAgent-962"><a href="#FundingRoundsAgent-962"><span class="linenos"> 962</span></a>            <span class="n">portfolio_data</span> <span class="o">=</span> <span class="n">portfolio_output</span><span class="o">.</span><span class="n">result</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="FundingRoundsAgent-963"><a href="#FundingRoundsAgent-963"><span class="linenos"> 963</span></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_portfolio_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">portfolio_data</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-964"><a href="#FundingRoundsAgent-964"><span class="linenos"> 964</span></a>
</span><span id="FundingRoundsAgent-965"><a href="#FundingRoundsAgent-965"><span class="linenos"> 965</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-966"><a href="#FundingRoundsAgent-966"><span class="linenos"> 966</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-967"><a href="#FundingRoundsAgent-967"><span class="linenos"> 967</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-968"><a href="#FundingRoundsAgent-968"><span class="linenos"> 968</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-969"><a href="#FundingRoundsAgent-969"><span class="linenos"> 969</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-970"><a href="#FundingRoundsAgent-970"><span class="linenos"> 970</span></a>                <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span>
</span><span id="FundingRoundsAgent-971"><a href="#FundingRoundsAgent-971"><span class="linenos"> 971</span></a>                    <span class="p">{</span>
</span><span id="FundingRoundsAgent-972"><a href="#FundingRoundsAgent-972"><span class="linenos"> 972</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;find_investor_portfolio&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-973"><a href="#FundingRoundsAgent-973"><span class="linenos"> 973</span></a>                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-974"><a href="#FundingRoundsAgent-974"><span class="linenos"> 974</span></a>                            <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-975"><a href="#FundingRoundsAgent-975"><span class="linenos"> 975</span></a>                            <span class="s2">&quot;time_period_start&quot;</span><span class="p">:</span> <span class="n">time_period_start</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-976"><a href="#FundingRoundsAgent-976"><span class="linenos"> 976</span></a>                            <span class="s2">&quot;time_period_end&quot;</span><span class="p">:</span> <span class="n">time_period_end</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-977"><a href="#FundingRoundsAgent-977"><span class="linenos"> 977</span></a>                            <span class="s2">&quot;include_lead_only&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-978"><a href="#FundingRoundsAgent-978"><span class="linenos"> 978</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-979"><a href="#FundingRoundsAgent-979"><span class="linenos"> 979</span></a>                        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-980"><a href="#FundingRoundsAgent-980"><span class="linenos"> 980</span></a>                            <span class="s2">&quot;num_companies&quot;</span><span class="p">:</span> <span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-981"><a href="#FundingRoundsAgent-981"><span class="linenos"> 981</span></a>                                <span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="FundingRoundsAgent-982"><a href="#FundingRoundsAgent-982"><span class="linenos"> 982</span></a>                            <span class="p">),</span>
</span><span id="FundingRoundsAgent-983"><a href="#FundingRoundsAgent-983"><span class="linenos"> 983</span></a>                            <span class="s2">&quot;num_investments&quot;</span><span class="p">:</span> <span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-984"><a href="#FundingRoundsAgent-984"><span class="linenos"> 984</span></a>                                <span class="s2">&quot;total_investments&quot;</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="FundingRoundsAgent-985"><a href="#FundingRoundsAgent-985"><span class="linenos"> 985</span></a>                            <span class="p">),</span>
</span><span id="FundingRoundsAgent-986"><a href="#FundingRoundsAgent-986"><span class="linenos"> 986</span></a>                            <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">portfolio_output</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-987"><a href="#FundingRoundsAgent-987"><span class="linenos"> 987</span></a>                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">portfolio_output</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-988"><a href="#FundingRoundsAgent-988"><span class="linenos"> 988</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-989"><a href="#FundingRoundsAgent-989"><span class="linenos"> 989</span></a>                    <span class="p">}</span>
</span><span id="FundingRoundsAgent-990"><a href="#FundingRoundsAgent-990"><span class="linenos"> 990</span></a>                <span class="p">],</span>
</span><span id="FundingRoundsAgent-991"><a href="#FundingRoundsAgent-991"><span class="linenos"> 991</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-992"><a href="#FundingRoundsAgent-992"><span class="linenos"> 992</span></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-993"><a href="#FundingRoundsAgent-993"><span class="linenos"> 993</span></a>                    <span class="s2">&quot;investor_name&quot;</span><span class="p">:</span> <span class="n">investor_name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-994"><a href="#FundingRoundsAgent-994"><span class="linenos"> 994</span></a>                    <span class="s2">&quot;portfolio_summary&quot;</span><span class="p">:</span> <span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="FundingRoundsAgent-995"><a href="#FundingRoundsAgent-995"><span class="linenos"> 995</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-996"><a href="#FundingRoundsAgent-996"><span class="linenos"> 996</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-997"><a href="#FundingRoundsAgent-997"><span class="linenos"> 997</span></a>
</span><span id="FundingRoundsAgent-998"><a href="#FundingRoundsAgent-998"><span class="linenos"> 998</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-999"><a href="#FundingRoundsAgent-999"><span class="linenos"> 999</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to handle investor portfolio query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-1000"><a href="#FundingRoundsAgent-1000"><span class="linenos">1000</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1001"><a href="#FundingRoundsAgent-1001"><span class="linenos">1001</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1002"><a href="#FundingRoundsAgent-1002"><span class="linenos">1002</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1003"><a href="#FundingRoundsAgent-1003"><span class="linenos">1003</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1004"><a href="#FundingRoundsAgent-1004"><span class="linenos">1004</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1005"><a href="#FundingRoundsAgent-1005"><span class="linenos">1005</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1006"><a href="#FundingRoundsAgent-1006"><span class="linenos">1006</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1007"><a href="#FundingRoundsAgent-1007"><span class="linenos">1007</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1008"><a href="#FundingRoundsAgent-1008"><span class="linenos">1008</span></a>
</span><span id="FundingRoundsAgent-1009"><a href="#FundingRoundsAgent-1009"><span class="linenos">1009</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1010"><a href="#FundingRoundsAgent-1010"><span class="linenos">1010</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to handle investor portfolio query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent-1011"><a href="#FundingRoundsAgent-1011"><span class="linenos">1011</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1012"><a href="#FundingRoundsAgent-1012"><span class="linenos">1012</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1013"><a href="#FundingRoundsAgent-1013"><span class="linenos">1013</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1014"><a href="#FundingRoundsAgent-1014"><span class="linenos">1014</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1015"><a href="#FundingRoundsAgent-1015"><span class="linenos">1015</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1016"><a href="#FundingRoundsAgent-1016"><span class="linenos">1016</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1017"><a href="#FundingRoundsAgent-1017"><span class="linenos">1017</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1018"><a href="#FundingRoundsAgent-1018"><span class="linenos">1018</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1019"><a href="#FundingRoundsAgent-1019"><span class="linenos">1019</span></a>
</span><span id="FundingRoundsAgent-1020"><a href="#FundingRoundsAgent-1020"><span class="linenos">1020</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_format_portfolio_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1021"><a href="#FundingRoundsAgent-1021"><span class="linenos">1021</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span> <span class="n">portfolio_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1022"><a href="#FundingRoundsAgent-1022"><span class="linenos">1022</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInsight</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1023"><a href="#FundingRoundsAgent-1023"><span class="linenos">1023</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate domain insight from investor portfolio data using LLM.</span>
</span><span id="FundingRoundsAgent-1024"><a href="#FundingRoundsAgent-1024"><span class="linenos">1024</span></a>
</span><span id="FundingRoundsAgent-1025"><a href="#FundingRoundsAgent-1025"><span class="linenos">1025</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-1026"><a href="#FundingRoundsAgent-1026"><span class="linenos">1026</span></a><span class="sd">            context: The agent context.</span>
</span><span id="FundingRoundsAgent-1027"><a href="#FundingRoundsAgent-1027"><span class="linenos">1027</span></a><span class="sd">            portfolio_data: Portfolio data from find_investor_portfolio tool.</span>
</span><span id="FundingRoundsAgent-1028"><a href="#FundingRoundsAgent-1028"><span class="linenos">1028</span></a>
</span><span id="FundingRoundsAgent-1029"><a href="#FundingRoundsAgent-1029"><span class="linenos">1029</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-1030"><a href="#FundingRoundsAgent-1030"><span class="linenos">1030</span></a><span class="sd">            AgentInsight object with domain interpretation and reasoning.</span>
</span><span id="FundingRoundsAgent-1031"><a href="#FundingRoundsAgent-1031"><span class="linenos">1031</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1032"><a href="#FundingRoundsAgent-1032"><span class="linenos">1032</span></a>        <span class="n">generate_insight_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1033"><a href="#FundingRoundsAgent-1033"><span class="linenos">1033</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1034"><a href="#FundingRoundsAgent-1034"><span class="linenos">1034</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1035"><a href="#FundingRoundsAgent-1035"><span class="linenos">1035</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1036"><a href="#FundingRoundsAgent-1036"><span class="linenos">1036</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Generate domain insight from investor portfolio data&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1037"><a href="#FundingRoundsAgent-1037"><span class="linenos">1037</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1038"><a href="#FundingRoundsAgent-1038"><span class="linenos">1038</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1039"><a href="#FundingRoundsAgent-1039"><span class="linenos">1039</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1040"><a href="#FundingRoundsAgent-1040"><span class="linenos">1040</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1041"><a href="#FundingRoundsAgent-1041"><span class="linenos">1041</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1042"><a href="#FundingRoundsAgent-1042"><span class="linenos">1042</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Human-readable insight summary answering the user&#39;s query&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1043"><a href="#FundingRoundsAgent-1043"><span class="linenos">1043</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1044"><a href="#FundingRoundsAgent-1044"><span class="linenos">1044</span></a>                        <span class="s2">&quot;key_findings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1045"><a href="#FundingRoundsAgent-1045"><span class="linenos">1045</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1046"><a href="#FundingRoundsAgent-1046"><span class="linenos">1046</span></a>                            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1047"><a href="#FundingRoundsAgent-1047"><span class="linenos">1047</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Bullet points of key findings&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1048"><a href="#FundingRoundsAgent-1048"><span class="linenos">1048</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1049"><a href="#FundingRoundsAgent-1049"><span class="linenos">1049</span></a>                        <span class="s2">&quot;evidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1050"><a href="#FundingRoundsAgent-1050"><span class="linenos">1050</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1051"><a href="#FundingRoundsAgent-1051"><span class="linenos">1051</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Supporting data from tool calls&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1052"><a href="#FundingRoundsAgent-1052"><span class="linenos">1052</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1053"><a href="#FundingRoundsAgent-1053"><span class="linenos">1053</span></a>                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1054"><a href="#FundingRoundsAgent-1054"><span class="linenos">1054</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1055"><a href="#FundingRoundsAgent-1055"><span class="linenos">1055</span></a>                            <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1056"><a href="#FundingRoundsAgent-1056"><span class="linenos">1056</span></a>                            <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1057"><a href="#FundingRoundsAgent-1057"><span class="linenos">1057</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Confidence in the insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1058"><a href="#FundingRoundsAgent-1058"><span class="linenos">1058</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1059"><a href="#FundingRoundsAgent-1059"><span class="linenos">1059</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-1060"><a href="#FundingRoundsAgent-1060"><span class="linenos">1060</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1061"><a href="#FundingRoundsAgent-1061"><span class="linenos">1061</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1062"><a href="#FundingRoundsAgent-1062"><span class="linenos">1062</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-1063"><a href="#FundingRoundsAgent-1063"><span class="linenos">1063</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-1064"><a href="#FundingRoundsAgent-1064"><span class="linenos">1064</span></a>
</span><span id="FundingRoundsAgent-1065"><a href="#FundingRoundsAgent-1065"><span class="linenos">1065</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-1066"><a href="#FundingRoundsAgent-1066"><span class="linenos">1066</span></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are an investor portfolio analysis expert. Analyze the investor portfolio data and generate insights that directly answer the user&#39;s query.</span>
</span><span id="FundingRoundsAgent-1067"><a href="#FundingRoundsAgent-1067"><span class="linenos">1067</span></a>
</span><span id="FundingRoundsAgent-1068"><a href="#FundingRoundsAgent-1068"><span class="linenos">1068</span></a><span class="s2">Your task:</span>
</span><span id="FundingRoundsAgent-1069"><a href="#FundingRoundsAgent-1069"><span class="linenos">1069</span></a><span class="s2">- Summarize the investor&#39;s portfolio (number of companies, investments, capital deployed)</span>
</span><span id="FundingRoundsAgent-1070"><a href="#FundingRoundsAgent-1070"><span class="linenos">1070</span></a><span class="s2">- Highlight notable portfolio companies (by funding, stage, or other metrics)</span>
</span><span id="FundingRoundsAgent-1071"><a href="#FundingRoundsAgent-1071"><span class="linenos">1071</span></a><span class="s2">- Identify investment patterns (stages, sectors, time periods)</span>
</span><span id="FundingRoundsAgent-1072"><a href="#FundingRoundsAgent-1072"><span class="linenos">1072</span></a><span class="s2">- Compare portfolio size and activity if time periods are specified</span>
</span><span id="FundingRoundsAgent-1073"><a href="#FundingRoundsAgent-1073"><span class="linenos">1073</span></a><span class="s2">- State uncertainty where data is missing</span>
</span><span id="FundingRoundsAgent-1074"><a href="#FundingRoundsAgent-1074"><span class="linenos">1074</span></a><span class="s2">- Directly answer the user&#39;s query in the summary</span>
</span><span id="FundingRoundsAgent-1075"><a href="#FundingRoundsAgent-1075"><span class="linenos">1075</span></a>
</span><span id="FundingRoundsAgent-1076"><a href="#FundingRoundsAgent-1076"><span class="linenos">1076</span></a><span class="s2">If no portfolio companies are found, explain why (e.g., investor name not found, no investments in specified time period).&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1077"><a href="#FundingRoundsAgent-1077"><span class="linenos">1077</span></a>
</span><span id="FundingRoundsAgent-1078"><a href="#FundingRoundsAgent-1078"><span class="linenos">1078</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_system_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1079"><a href="#FundingRoundsAgent-1079"><span class="linenos">1079</span></a>            <span class="n">base_prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1080"><a href="#FundingRoundsAgent-1080"><span class="linenos">1080</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_markdown_instructions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1081"><a href="#FundingRoundsAgent-1081"><span class="linenos">1081</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1082"><a href="#FundingRoundsAgent-1082"><span class="linenos">1082</span></a>
</span><span id="FundingRoundsAgent-1083"><a href="#FundingRoundsAgent-1083"><span class="linenos">1083</span></a>        <span class="n">user_prompt_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1084"><a href="#FundingRoundsAgent-1084"><span class="linenos">1084</span></a>
</span><span id="FundingRoundsAgent-1085"><a href="#FundingRoundsAgent-1085"><span class="linenos">1085</span></a><span class="s2">Investor Portfolio Data (JSON):</span>
</span><span id="FundingRoundsAgent-1086"><a href="#FundingRoundsAgent-1086"><span class="linenos">1086</span></a><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">portfolio_data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1087"><a href="#FundingRoundsAgent-1087"><span class="linenos">1087</span></a>
</span><span id="FundingRoundsAgent-1088"><a href="#FundingRoundsAgent-1088"><span class="linenos">1088</span></a><span class="s2">Analyze this data and generate insights that directly answer the user&#39;s query. Call the generate_insight function with your analysis.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1089"><a href="#FundingRoundsAgent-1089"><span class="linenos">1089</span></a>
</span><span id="FundingRoundsAgent-1090"><a href="#FundingRoundsAgent-1090"><span class="linenos">1090</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_user_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1091"><a href="#FundingRoundsAgent-1091"><span class="linenos">1091</span></a>            <span class="n">user_query</span><span class="o">=</span><span class="n">user_prompt_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1092"><a href="#FundingRoundsAgent-1092"><span class="linenos">1092</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1093"><a href="#FundingRoundsAgent-1093"><span class="linenos">1093</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1094"><a href="#FundingRoundsAgent-1094"><span class="linenos">1094</span></a>
</span><span id="FundingRoundsAgent-1095"><a href="#FundingRoundsAgent-1095"><span class="linenos">1095</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1096"><a href="#FundingRoundsAgent-1096"><span class="linenos">1096</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1097"><a href="#FundingRoundsAgent-1097"><span class="linenos">1097</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1098"><a href="#FundingRoundsAgent-1098"><span class="linenos">1098</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">generate_insight_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1099"><a href="#FundingRoundsAgent-1099"><span class="linenos">1099</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1100"><a href="#FundingRoundsAgent-1100"><span class="linenos">1100</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1101"><a href="#FundingRoundsAgent-1101"><span class="linenos">1101</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1102"><a href="#FundingRoundsAgent-1102"><span class="linenos">1102</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-1103"><a href="#FundingRoundsAgent-1103"><span class="linenos">1103</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1104"><a href="#FundingRoundsAgent-1104"><span class="linenos">1104</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1105"><a href="#FundingRoundsAgent-1105"><span class="linenos">1105</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1106"><a href="#FundingRoundsAgent-1106"><span class="linenos">1106</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1107"><a href="#FundingRoundsAgent-1107"><span class="linenos">1107</span></a>
</span><span id="FundingRoundsAgent-1108"><a href="#FundingRoundsAgent-1108"><span class="linenos">1108</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1109"><a href="#FundingRoundsAgent-1109"><span class="linenos">1109</span></a>                <span class="n">args</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1110"><a href="#FundingRoundsAgent-1110"><span class="linenos">1110</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1111"><a href="#FundingRoundsAgent-1111"><span class="linenos">1111</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1112"><a href="#FundingRoundsAgent-1112"><span class="linenos">1112</span></a>                    <span class="n">key_findings</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_findings&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1113"><a href="#FundingRoundsAgent-1113"><span class="linenos">1113</span></a>                    <span class="n">evidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1114"><a href="#FundingRoundsAgent-1114"><span class="linenos">1114</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1115"><a href="#FundingRoundsAgent-1115"><span class="linenos">1115</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1116"><a href="#FundingRoundsAgent-1116"><span class="linenos">1116</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1117"><a href="#FundingRoundsAgent-1117"><span class="linenos">1117</span></a>                <span class="c1"># Fallback</span>
</span><span id="FundingRoundsAgent-1118"><a href="#FundingRoundsAgent-1118"><span class="linenos">1118</span></a>                <span class="n">summary</span> <span class="o">=</span> <span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1119"><a href="#FundingRoundsAgent-1119"><span class="linenos">1119</span></a>                <span class="n">num_companies</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1120"><a href="#FundingRoundsAgent-1120"><span class="linenos">1120</span></a>                <span class="k">if</span> <span class="n">num_companies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1121"><a href="#FundingRoundsAgent-1121"><span class="linenos">1121</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1122"><a href="#FundingRoundsAgent-1122"><span class="linenos">1122</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_companies</span><span class="si">}</span><span class="s2"> portfolio company/companies for </span><span class="si">{</span><span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;investor_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;the investor&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1123"><a href="#FundingRoundsAgent-1123"><span class="linenos">1123</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1124"><a href="#FundingRoundsAgent-1124"><span class="linenos">1124</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1125"><a href="#FundingRoundsAgent-1125"><span class="linenos">1125</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1126"><a href="#FundingRoundsAgent-1126"><span class="linenos">1126</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1127"><a href="#FundingRoundsAgent-1127"><span class="linenos">1127</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Could not find any portfolio companies for </span><span class="si">{</span><span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;investor_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;the specified investor&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1128"><a href="#FundingRoundsAgent-1128"><span class="linenos">1128</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1129"><a href="#FundingRoundsAgent-1129"><span class="linenos">1129</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1130"><a href="#FundingRoundsAgent-1130"><span class="linenos">1130</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1131"><a href="#FundingRoundsAgent-1131"><span class="linenos">1131</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate portfolio insight from LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1132"><a href="#FundingRoundsAgent-1132"><span class="linenos">1132</span></a>            <span class="n">summary</span> <span class="o">=</span> <span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1133"><a href="#FundingRoundsAgent-1133"><span class="linenos">1133</span></a>            <span class="n">num_companies</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1134"><a href="#FundingRoundsAgent-1134"><span class="linenos">1134</span></a>            <span class="k">if</span> <span class="n">num_companies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1135"><a href="#FundingRoundsAgent-1135"><span class="linenos">1135</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1136"><a href="#FundingRoundsAgent-1136"><span class="linenos">1136</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_companies</span><span class="si">}</span><span class="s2"> portfolio company/companies for </span><span class="si">{</span><span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;investor_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;the investor&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1137"><a href="#FundingRoundsAgent-1137"><span class="linenos">1137</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1138"><a href="#FundingRoundsAgent-1138"><span class="linenos">1138</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1139"><a href="#FundingRoundsAgent-1139"><span class="linenos">1139</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1140"><a href="#FundingRoundsAgent-1140"><span class="linenos">1140</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1141"><a href="#FundingRoundsAgent-1141"><span class="linenos">1141</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Could not find any portfolio companies for </span><span class="si">{</span><span class="n">portfolio_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;investor_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;the specified investor&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1142"><a href="#FundingRoundsAgent-1142"><span class="linenos">1142</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1143"><a href="#FundingRoundsAgent-1143"><span class="linenos">1143</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1144"><a href="#FundingRoundsAgent-1144"><span class="linenos">1144</span></a>
</span><span id="FundingRoundsAgent-1145"><a href="#FundingRoundsAgent-1145"><span class="linenos">1145</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_format_multi_portfolio_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1146"><a href="#FundingRoundsAgent-1146"><span class="linenos">1146</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1147"><a href="#FundingRoundsAgent-1147"><span class="linenos">1147</span></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1148"><a href="#FundingRoundsAgent-1148"><span class="linenos">1148</span></a>        <span class="n">portfolio_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="FundingRoundsAgent-1149"><a href="#FundingRoundsAgent-1149"><span class="linenos">1149</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInsight</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1150"><a href="#FundingRoundsAgent-1150"><span class="linenos">1150</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate domain insight from multiple investor portfolio data using LLM.</span>
</span><span id="FundingRoundsAgent-1151"><a href="#FundingRoundsAgent-1151"><span class="linenos">1151</span></a>
</span><span id="FundingRoundsAgent-1152"><a href="#FundingRoundsAgent-1152"><span class="linenos">1152</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-1153"><a href="#FundingRoundsAgent-1153"><span class="linenos">1153</span></a><span class="sd">            context: The agent context.</span>
</span><span id="FundingRoundsAgent-1154"><a href="#FundingRoundsAgent-1154"><span class="linenos">1154</span></a><span class="sd">            portfolio_results: List of dicts with &#39;investor_name&#39; and &#39;portfolio_data&#39;.</span>
</span><span id="FundingRoundsAgent-1155"><a href="#FundingRoundsAgent-1155"><span class="linenos">1155</span></a>
</span><span id="FundingRoundsAgent-1156"><a href="#FundingRoundsAgent-1156"><span class="linenos">1156</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-1157"><a href="#FundingRoundsAgent-1157"><span class="linenos">1157</span></a><span class="sd">            AgentInsight object with domain interpretation and reasoning.</span>
</span><span id="FundingRoundsAgent-1158"><a href="#FundingRoundsAgent-1158"><span class="linenos">1158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1159"><a href="#FundingRoundsAgent-1159"><span class="linenos">1159</span></a>        <span class="n">generate_insight_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1160"><a href="#FundingRoundsAgent-1160"><span class="linenos">1160</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1161"><a href="#FundingRoundsAgent-1161"><span class="linenos">1161</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1162"><a href="#FundingRoundsAgent-1162"><span class="linenos">1162</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1163"><a href="#FundingRoundsAgent-1163"><span class="linenos">1163</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Generate domain insight from multiple investor portfolio data&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1164"><a href="#FundingRoundsAgent-1164"><span class="linenos">1164</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1165"><a href="#FundingRoundsAgent-1165"><span class="linenos">1165</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1166"><a href="#FundingRoundsAgent-1166"><span class="linenos">1166</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1167"><a href="#FundingRoundsAgent-1167"><span class="linenos">1167</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1168"><a href="#FundingRoundsAgent-1168"><span class="linenos">1168</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1169"><a href="#FundingRoundsAgent-1169"><span class="linenos">1169</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Human-readable insight summary answering the user&#39;s query, comparing portfolios across investors&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1170"><a href="#FundingRoundsAgent-1170"><span class="linenos">1170</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1171"><a href="#FundingRoundsAgent-1171"><span class="linenos">1171</span></a>                        <span class="s2">&quot;key_findings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1172"><a href="#FundingRoundsAgent-1172"><span class="linenos">1172</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1173"><a href="#FundingRoundsAgent-1173"><span class="linenos">1173</span></a>                            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1174"><a href="#FundingRoundsAgent-1174"><span class="linenos">1174</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Bullet points of key findings comparing the portfolios&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1175"><a href="#FundingRoundsAgent-1175"><span class="linenos">1175</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1176"><a href="#FundingRoundsAgent-1176"><span class="linenos">1176</span></a>                        <span class="s2">&quot;evidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1177"><a href="#FundingRoundsAgent-1177"><span class="linenos">1177</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1178"><a href="#FundingRoundsAgent-1178"><span class="linenos">1178</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Supporting data from tool calls&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1179"><a href="#FundingRoundsAgent-1179"><span class="linenos">1179</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1180"><a href="#FundingRoundsAgent-1180"><span class="linenos">1180</span></a>                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1181"><a href="#FundingRoundsAgent-1181"><span class="linenos">1181</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1182"><a href="#FundingRoundsAgent-1182"><span class="linenos">1182</span></a>                            <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1183"><a href="#FundingRoundsAgent-1183"><span class="linenos">1183</span></a>                            <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1184"><a href="#FundingRoundsAgent-1184"><span class="linenos">1184</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Confidence in the insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1185"><a href="#FundingRoundsAgent-1185"><span class="linenos">1185</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1186"><a href="#FundingRoundsAgent-1186"><span class="linenos">1186</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-1187"><a href="#FundingRoundsAgent-1187"><span class="linenos">1187</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1188"><a href="#FundingRoundsAgent-1188"><span class="linenos">1188</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1189"><a href="#FundingRoundsAgent-1189"><span class="linenos">1189</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-1190"><a href="#FundingRoundsAgent-1190"><span class="linenos">1190</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-1191"><a href="#FundingRoundsAgent-1191"><span class="linenos">1191</span></a>
</span><span id="FundingRoundsAgent-1192"><a href="#FundingRoundsAgent-1192"><span class="linenos">1192</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-1193"><a href="#FundingRoundsAgent-1193"><span class="linenos">1193</span></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are an investor portfolio analysis expert. Analyze multiple investor portfolio data and generate insights that directly answer the user&#39;s query.</span>
</span><span id="FundingRoundsAgent-1194"><a href="#FundingRoundsAgent-1194"><span class="linenos">1194</span></a>
</span><span id="FundingRoundsAgent-1195"><a href="#FundingRoundsAgent-1195"><span class="linenos">1195</span></a><span class="s2">Your task:</span>
</span><span id="FundingRoundsAgent-1196"><a href="#FundingRoundsAgent-1196"><span class="linenos">1196</span></a><span class="s2">- Compare portfolios across all investors (number of companies, investments, capital deployed)</span>
</span><span id="FundingRoundsAgent-1197"><a href="#FundingRoundsAgent-1197"><span class="linenos">1197</span></a><span class="s2">- Highlight notable portfolio companies for each investor (by funding, stage, or other metrics)</span>
</span><span id="FundingRoundsAgent-1198"><a href="#FundingRoundsAgent-1198"><span class="linenos">1198</span></a><span class="s2">- Identify investment patterns and differences between investors (stages, sectors, time periods, investment sizes)</span>
</span><span id="FundingRoundsAgent-1199"><a href="#FundingRoundsAgent-1199"><span class="linenos">1199</span></a><span class="s2">- Compare portfolio sizes, activity levels, and strategic focus</span>
</span><span id="FundingRoundsAgent-1200"><a href="#FundingRoundsAgent-1200"><span class="linenos">1200</span></a><span class="s2">- State uncertainty where data is missing</span>
</span><span id="FundingRoundsAgent-1201"><a href="#FundingRoundsAgent-1201"><span class="linenos">1201</span></a><span class="s2">- Directly answer the user&#39;s query in the summary, providing a comprehensive comparison</span>
</span><span id="FundingRoundsAgent-1202"><a href="#FundingRoundsAgent-1202"><span class="linenos">1202</span></a>
</span><span id="FundingRoundsAgent-1203"><a href="#FundingRoundsAgent-1203"><span class="linenos">1203</span></a><span class="s2">If no portfolio companies are found for any investor, explain why (e.g., investor name not found, no investments in specified time period).&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1204"><a href="#FundingRoundsAgent-1204"><span class="linenos">1204</span></a>
</span><span id="FundingRoundsAgent-1205"><a href="#FundingRoundsAgent-1205"><span class="linenos">1205</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_system_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1206"><a href="#FundingRoundsAgent-1206"><span class="linenos">1206</span></a>            <span class="n">base_prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1207"><a href="#FundingRoundsAgent-1207"><span class="linenos">1207</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_markdown_instructions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1208"><a href="#FundingRoundsAgent-1208"><span class="linenos">1208</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1209"><a href="#FundingRoundsAgent-1209"><span class="linenos">1209</span></a>
</span><span id="FundingRoundsAgent-1210"><a href="#FundingRoundsAgent-1210"><span class="linenos">1210</span></a>        <span class="n">user_prompt_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1211"><a href="#FundingRoundsAgent-1211"><span class="linenos">1211</span></a>
</span><span id="FundingRoundsAgent-1212"><a href="#FundingRoundsAgent-1212"><span class="linenos">1212</span></a><span class="s2">Investor Portfolio Data (JSON):</span>
</span><span id="FundingRoundsAgent-1213"><a href="#FundingRoundsAgent-1213"><span class="linenos">1213</span></a><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">portfolio_results</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1214"><a href="#FundingRoundsAgent-1214"><span class="linenos">1214</span></a>
</span><span id="FundingRoundsAgent-1215"><a href="#FundingRoundsAgent-1215"><span class="linenos">1215</span></a><span class="s2">Analyze this data and generate insights that directly answer the user&#39;s query. Compare the portfolios across all investors. Call the generate_insight function with your analysis.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1216"><a href="#FundingRoundsAgent-1216"><span class="linenos">1216</span></a>
</span><span id="FundingRoundsAgent-1217"><a href="#FundingRoundsAgent-1217"><span class="linenos">1217</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_user_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1218"><a href="#FundingRoundsAgent-1218"><span class="linenos">1218</span></a>            <span class="n">user_query</span><span class="o">=</span><span class="n">user_prompt_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1219"><a href="#FundingRoundsAgent-1219"><span class="linenos">1219</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1220"><a href="#FundingRoundsAgent-1220"><span class="linenos">1220</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1221"><a href="#FundingRoundsAgent-1221"><span class="linenos">1221</span></a>
</span><span id="FundingRoundsAgent-1222"><a href="#FundingRoundsAgent-1222"><span class="linenos">1222</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1223"><a href="#FundingRoundsAgent-1223"><span class="linenos">1223</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1224"><a href="#FundingRoundsAgent-1224"><span class="linenos">1224</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1225"><a href="#FundingRoundsAgent-1225"><span class="linenos">1225</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">generate_insight_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1226"><a href="#FundingRoundsAgent-1226"><span class="linenos">1226</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1227"><a href="#FundingRoundsAgent-1227"><span class="linenos">1227</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1228"><a href="#FundingRoundsAgent-1228"><span class="linenos">1228</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1229"><a href="#FundingRoundsAgent-1229"><span class="linenos">1229</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-1230"><a href="#FundingRoundsAgent-1230"><span class="linenos">1230</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1231"><a href="#FundingRoundsAgent-1231"><span class="linenos">1231</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1232"><a href="#FundingRoundsAgent-1232"><span class="linenos">1232</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1233"><a href="#FundingRoundsAgent-1233"><span class="linenos">1233</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1234"><a href="#FundingRoundsAgent-1234"><span class="linenos">1234</span></a>
</span><span id="FundingRoundsAgent-1235"><a href="#FundingRoundsAgent-1235"><span class="linenos">1235</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1236"><a href="#FundingRoundsAgent-1236"><span class="linenos">1236</span></a>                <span class="n">args</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1237"><a href="#FundingRoundsAgent-1237"><span class="linenos">1237</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1238"><a href="#FundingRoundsAgent-1238"><span class="linenos">1238</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1239"><a href="#FundingRoundsAgent-1239"><span class="linenos">1239</span></a>                    <span class="n">key_findings</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_findings&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1240"><a href="#FundingRoundsAgent-1240"><span class="linenos">1240</span></a>                    <span class="n">evidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1241"><a href="#FundingRoundsAgent-1241"><span class="linenos">1241</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1242"><a href="#FundingRoundsAgent-1242"><span class="linenos">1242</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1243"><a href="#FundingRoundsAgent-1243"><span class="linenos">1243</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1244"><a href="#FundingRoundsAgent-1244"><span class="linenos">1244</span></a>                <span class="c1"># Fallback</span>
</span><span id="FundingRoundsAgent-1245"><a href="#FundingRoundsAgent-1245"><span class="linenos">1245</span></a>                <span class="n">total_companies</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1246"><a href="#FundingRoundsAgent-1246"><span class="linenos">1246</span></a>                    <span class="n">pr</span><span class="p">[</span><span class="s2">&quot;portfolio_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1247"><a href="#FundingRoundsAgent-1247"><span class="linenos">1247</span></a>                    <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">portfolio_results</span>
</span><span id="FundingRoundsAgent-1248"><a href="#FundingRoundsAgent-1248"><span class="linenos">1248</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1249"><a href="#FundingRoundsAgent-1249"><span class="linenos">1249</span></a>                <span class="n">investor_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">pr</span><span class="p">[</span><span class="s2">&quot;investor_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">portfolio_results</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1250"><a href="#FundingRoundsAgent-1250"><span class="linenos">1250</span></a>                <span class="k">if</span> <span class="n">total_companies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1251"><a href="#FundingRoundsAgent-1251"><span class="linenos">1251</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1252"><a href="#FundingRoundsAgent-1252"><span class="linenos">1252</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found portfolios for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">portfolio_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> investor(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">investor_names</span><span class="p">)</span><span class="si">}</span><span class="s2">. Total portfolio companies: </span><span class="si">{</span><span class="n">total_companies</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1253"><a href="#FundingRoundsAgent-1253"><span class="linenos">1253</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1254"><a href="#FundingRoundsAgent-1254"><span class="linenos">1254</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1255"><a href="#FundingRoundsAgent-1255"><span class="linenos">1255</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1256"><a href="#FundingRoundsAgent-1256"><span class="linenos">1256</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1257"><a href="#FundingRoundsAgent-1257"><span class="linenos">1257</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Could not find any portfolio companies for the specified investors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">investor_names</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1258"><a href="#FundingRoundsAgent-1258"><span class="linenos">1258</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1259"><a href="#FundingRoundsAgent-1259"><span class="linenos">1259</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1260"><a href="#FundingRoundsAgent-1260"><span class="linenos">1260</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1261"><a href="#FundingRoundsAgent-1261"><span class="linenos">1261</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1262"><a href="#FundingRoundsAgent-1262"><span class="linenos">1262</span></a>                <span class="sa">f</span><span class="s2">&quot;Failed to generate multi-portfolio insight from LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1263"><a href="#FundingRoundsAgent-1263"><span class="linenos">1263</span></a>                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1264"><a href="#FundingRoundsAgent-1264"><span class="linenos">1264</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1265"><a href="#FundingRoundsAgent-1265"><span class="linenos">1265</span></a>            <span class="n">total_companies</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1266"><a href="#FundingRoundsAgent-1266"><span class="linenos">1266</span></a>                <span class="n">pr</span><span class="p">[</span><span class="s2">&quot;portfolio_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_companies&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1267"><a href="#FundingRoundsAgent-1267"><span class="linenos">1267</span></a>                <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">portfolio_results</span>
</span><span id="FundingRoundsAgent-1268"><a href="#FundingRoundsAgent-1268"><span class="linenos">1268</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1269"><a href="#FundingRoundsAgent-1269"><span class="linenos">1269</span></a>            <span class="n">investor_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">pr</span><span class="p">[</span><span class="s2">&quot;investor_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">portfolio_results</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1270"><a href="#FundingRoundsAgent-1270"><span class="linenos">1270</span></a>            <span class="k">if</span> <span class="n">total_companies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1271"><a href="#FundingRoundsAgent-1271"><span class="linenos">1271</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1272"><a href="#FundingRoundsAgent-1272"><span class="linenos">1272</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found portfolios for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">portfolio_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> investor(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">investor_names</span><span class="p">)</span><span class="si">}</span><span class="s2">. Total portfolio companies: </span><span class="si">{</span><span class="n">total_companies</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1273"><a href="#FundingRoundsAgent-1273"><span class="linenos">1273</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1274"><a href="#FundingRoundsAgent-1274"><span class="linenos">1274</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1275"><a href="#FundingRoundsAgent-1275"><span class="linenos">1275</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1276"><a href="#FundingRoundsAgent-1276"><span class="linenos">1276</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1277"><a href="#FundingRoundsAgent-1277"><span class="linenos">1277</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Could not find any portfolio companies for the specified investors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">investor_names</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1278"><a href="#FundingRoundsAgent-1278"><span class="linenos">1278</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1279"><a href="#FundingRoundsAgent-1279"><span class="linenos">1279</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1280"><a href="#FundingRoundsAgent-1280"><span class="linenos">1280</span></a>
</span><span id="FundingRoundsAgent-1281"><a href="#FundingRoundsAgent-1281"><span class="linenos">1281</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_extract_search_parameters</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1282"><a href="#FundingRoundsAgent-1282"><span class="linenos">1282</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span> <span class="n">resolved_uuids</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1283"><a href="#FundingRoundsAgent-1283"><span class="linenos">1283</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent-1284"><a href="#FundingRoundsAgent-1284"><span class="linenos">1284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract search parameters from user query using LLM function calling.</span>
</span><span id="FundingRoundsAgent-1285"><a href="#FundingRoundsAgent-1285"><span class="linenos">1285</span></a>
</span><span id="FundingRoundsAgent-1286"><a href="#FundingRoundsAgent-1286"><span class="linenos">1286</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-1287"><a href="#FundingRoundsAgent-1287"><span class="linenos">1287</span></a><span class="sd">            context: The agent context containing the user query.</span>
</span><span id="FundingRoundsAgent-1288"><a href="#FundingRoundsAgent-1288"><span class="linenos">1288</span></a><span class="sd">            resolved_uuids: Dictionary with resolved organization UUIDs.</span>
</span><span id="FundingRoundsAgent-1289"><a href="#FundingRoundsAgent-1289"><span class="linenos">1289</span></a>
</span><span id="FundingRoundsAgent-1290"><a href="#FundingRoundsAgent-1290"><span class="linenos">1290</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-1291"><a href="#FundingRoundsAgent-1291"><span class="linenos">1291</span></a><span class="sd">            Dictionary of parameters to pass to get_funding_rounds tool.</span>
</span><span id="FundingRoundsAgent-1292"><a href="#FundingRoundsAgent-1292"><span class="linenos">1292</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1293"><a href="#FundingRoundsAgent-1293"><span class="linenos">1293</span></a>        <span class="c1"># First, use pre-extracted metadata when available to avoid redundant LLM calls</span>
</span><span id="FundingRoundsAgent-1294"><a href="#FundingRoundsAgent-1294"><span class="linenos">1294</span></a>        <span class="n">extracted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;extracted_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1295"><a href="#FundingRoundsAgent-1295"><span class="linenos">1295</span></a>        <span class="n">search_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="FundingRoundsAgent-1296"><a href="#FundingRoundsAgent-1296"><span class="linenos">1296</span></a>
</span><span id="FundingRoundsAgent-1297"><a href="#FundingRoundsAgent-1297"><span class="linenos">1297</span></a>        <span class="c1"># Use resolved org uuid if present</span>
</span><span id="FundingRoundsAgent-1298"><a href="#FundingRoundsAgent-1298"><span class="linenos">1298</span></a>        <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-1299"><a href="#FundingRoundsAgent-1299"><span class="linenos">1299</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1300"><a href="#FundingRoundsAgent-1300"><span class="linenos">1300</span></a>
</span><span id="FundingRoundsAgent-1301"><a href="#FundingRoundsAgent-1301"><span class="linenos">1301</span></a>        <span class="c1"># Time period</span>
</span><span id="FundingRoundsAgent-1302"><a href="#FundingRoundsAgent-1302"><span class="linenos">1302</span></a>        <span class="n">time_period</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_period&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1303"><a href="#FundingRoundsAgent-1303"><span class="linenos">1303</span></a>        <span class="k">if</span> <span class="n">time_period</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-1304"><a href="#FundingRoundsAgent-1304"><span class="linenos">1304</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;investment_date_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_period</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1305"><a href="#FundingRoundsAgent-1305"><span class="linenos">1305</span></a>        <span class="k">if</span> <span class="n">time_period</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-1306"><a href="#FundingRoundsAgent-1306"><span class="linenos">1306</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;investment_date_to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_period</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1307"><a href="#FundingRoundsAgent-1307"><span class="linenos">1307</span></a>
</span><span id="FundingRoundsAgent-1308"><a href="#FundingRoundsAgent-1308"><span class="linenos">1308</span></a>        <span class="c1"># Amounts</span>
</span><span id="FundingRoundsAgent-1309"><a href="#FundingRoundsAgent-1309"><span class="linenos">1309</span></a>        <span class="n">amounts</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1310"><a href="#FundingRoundsAgent-1310"><span class="linenos">1310</span></a>        <span class="k">if</span> <span class="n">amounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fundraise_min&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1311"><a href="#FundingRoundsAgent-1311"><span class="linenos">1311</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;fundraise_amount_usd_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="s2">&quot;fundraise_min&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1312"><a href="#FundingRoundsAgent-1312"><span class="linenos">1312</span></a>        <span class="k">if</span> <span class="n">amounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fundraise_max&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1313"><a href="#FundingRoundsAgent-1313"><span class="linenos">1313</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;fundraise_amount_usd_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="s2">&quot;fundraise_max&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1314"><a href="#FundingRoundsAgent-1314"><span class="linenos">1314</span></a>        <span class="k">if</span> <span class="n">amounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valuation_min&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1315"><a href="#FundingRoundsAgent-1315"><span class="linenos">1315</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;valuation_usd_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="s2">&quot;valuation_min&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1316"><a href="#FundingRoundsAgent-1316"><span class="linenos">1316</span></a>        <span class="k">if</span> <span class="n">amounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valuation_max&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1317"><a href="#FundingRoundsAgent-1317"><span class="linenos">1317</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;valuation_usd_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="s2">&quot;valuation_max&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1318"><a href="#FundingRoundsAgent-1318"><span class="linenos">1318</span></a>
</span><span id="FundingRoundsAgent-1319"><a href="#FundingRoundsAgent-1319"><span class="linenos">1319</span></a>        <span class="c1"># Funding stages</span>
</span><span id="FundingRoundsAgent-1320"><a href="#FundingRoundsAgent-1320"><span class="linenos">1320</span></a>        <span class="n">funding_stages</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funding_stages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="FundingRoundsAgent-1321"><a href="#FundingRoundsAgent-1321"><span class="linenos">1321</span></a>        <span class="k">if</span> <span class="n">funding_stages</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1322"><a href="#FundingRoundsAgent-1322"><span class="linenos">1322</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;general_funding_stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">funding_stages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1323"><a href="#FundingRoundsAgent-1323"><span class="linenos">1323</span></a>
</span><span id="FundingRoundsAgent-1324"><a href="#FundingRoundsAgent-1324"><span class="linenos">1324</span></a>        <span class="c1"># Investors</span>
</span><span id="FundingRoundsAgent-1325"><a href="#FundingRoundsAgent-1325"><span class="linenos">1325</span></a>        <span class="n">investors</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;investors&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent-1326"><a href="#FundingRoundsAgent-1326"><span class="linenos">1326</span></a>        <span class="n">investor_names</span> <span class="o">=</span> <span class="n">investors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="FundingRoundsAgent-1327"><a href="#FundingRoundsAgent-1327"><span class="linenos">1327</span></a>        <span class="k">if</span> <span class="n">investor_names</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1328"><a href="#FundingRoundsAgent-1328"><span class="linenos">1328</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;investors_contains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">investor_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1329"><a href="#FundingRoundsAgent-1329"><span class="linenos">1329</span></a>
</span><span id="FundingRoundsAgent-1330"><a href="#FundingRoundsAgent-1330"><span class="linenos">1330</span></a>        <span class="c1"># Apply defaults if we gathered any params from metadata</span>
</span><span id="FundingRoundsAgent-1331"><a href="#FundingRoundsAgent-1331"><span class="linenos">1331</span></a>        <span class="k">if</span> <span class="n">search_params</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1332"><a href="#FundingRoundsAgent-1332"><span class="linenos">1332</span></a>            <span class="k">if</span> <span class="s2">&quot;limit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">search_params</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1333"><a href="#FundingRoundsAgent-1333"><span class="linenos">1333</span></a>                <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="FundingRoundsAgent-1334"><a href="#FundingRoundsAgent-1334"><span class="linenos">1334</span></a>            <span class="k">return</span> <span class="n">search_params</span>
</span><span id="FundingRoundsAgent-1335"><a href="#FundingRoundsAgent-1335"><span class="linenos">1335</span></a>
</span><span id="FundingRoundsAgent-1336"><a href="#FundingRoundsAgent-1336"><span class="linenos">1336</span></a>        <span class="c1"># Define the function/tool schema for get_funding_rounds</span>
</span><span id="FundingRoundsAgent-1337"><a href="#FundingRoundsAgent-1337"><span class="linenos">1337</span></a>        <span class="n">get_funding_rounds_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1338"><a href="#FundingRoundsAgent-1338"><span class="linenos">1338</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1339"><a href="#FundingRoundsAgent-1339"><span class="linenos">1339</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1340"><a href="#FundingRoundsAgent-1340"><span class="linenos">1340</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1341"><a href="#FundingRoundsAgent-1341"><span class="linenos">1341</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Search for funding rounds by various criteria. Extract parameters from the user query to search the funding rounds database.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1342"><a href="#FundingRoundsAgent-1342"><span class="linenos">1342</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1343"><a href="#FundingRoundsAgent-1343"><span class="linenos">1343</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1344"><a href="#FundingRoundsAgent-1344"><span class="linenos">1344</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1345"><a href="#FundingRoundsAgent-1345"><span class="linenos">1345</span></a>                        <span class="s2">&quot;funding_round_uuid&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1346"><a href="#FundingRoundsAgent-1346"><span class="linenos">1346</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1347"><a href="#FundingRoundsAgent-1347"><span class="linenos">1347</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact UUID of a specific funding round (if mentioned)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1348"><a href="#FundingRoundsAgent-1348"><span class="linenos">1348</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1349"><a href="#FundingRoundsAgent-1349"><span class="linenos">1349</span></a>                        <span class="s2">&quot;org_uuid&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1350"><a href="#FundingRoundsAgent-1350"><span class="linenos">1350</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1351"><a href="#FundingRoundsAgent-1351"><span class="linenos">1351</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;UUID of the organization that raised the funding&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1352"><a href="#FundingRoundsAgent-1352"><span class="linenos">1352</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1353"><a href="#FundingRoundsAgent-1353"><span class="linenos">1353</span></a>                        <span class="s2">&quot;investment_date&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1354"><a href="#FundingRoundsAgent-1354"><span class="linenos">1354</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1355"><a href="#FundingRoundsAgent-1355"><span class="linenos">1355</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact investment date in ISO format (YYYY-MM-DDTHH:MM:SS)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1356"><a href="#FundingRoundsAgent-1356"><span class="linenos">1356</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1357"><a href="#FundingRoundsAgent-1357"><span class="linenos">1357</span></a>                        <span class="s2">&quot;investment_date_from&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1358"><a href="#FundingRoundsAgent-1358"><span class="linenos">1358</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1359"><a href="#FundingRoundsAgent-1359"><span class="linenos">1359</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Filter funding rounds on or after this date (ISO format)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1360"><a href="#FundingRoundsAgent-1360"><span class="linenos">1360</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1361"><a href="#FundingRoundsAgent-1361"><span class="linenos">1361</span></a>                        <span class="s2">&quot;investment_date_to&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1362"><a href="#FundingRoundsAgent-1362"><span class="linenos">1362</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1363"><a href="#FundingRoundsAgent-1363"><span class="linenos">1363</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Filter funding rounds on or before this date (ISO format)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1364"><a href="#FundingRoundsAgent-1364"><span class="linenos">1364</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1365"><a href="#FundingRoundsAgent-1365"><span class="linenos">1365</span></a>                        <span class="s2">&quot;general_funding_stage&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1366"><a href="#FundingRoundsAgent-1366"><span class="linenos">1366</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1367"><a href="#FundingRoundsAgent-1367"><span class="linenos">1367</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;General funding stage (e.g., &#39;seed&#39;, &#39;series_a&#39;, &#39;series_b&#39;, &#39;late_stage_venture&#39;, &#39;ipo&#39;)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1368"><a href="#FundingRoundsAgent-1368"><span class="linenos">1368</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1369"><a href="#FundingRoundsAgent-1369"><span class="linenos">1369</span></a>                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1370"><a href="#FundingRoundsAgent-1370"><span class="linenos">1370</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1371"><a href="#FundingRoundsAgent-1371"><span class="linenos">1371</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Specific funding stage&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1372"><a href="#FundingRoundsAgent-1372"><span class="linenos">1372</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1373"><a href="#FundingRoundsAgent-1373"><span class="linenos">1373</span></a>                        <span class="s2">&quot;investors_contains&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1374"><a href="#FundingRoundsAgent-1374"><span class="linenos">1374</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1375"><a href="#FundingRoundsAgent-1375"><span class="linenos">1375</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Check if investors array contains this value (investor name or UUID)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1376"><a href="#FundingRoundsAgent-1376"><span class="linenos">1376</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1377"><a href="#FundingRoundsAgent-1377"><span class="linenos">1377</span></a>                        <span class="s2">&quot;lead_investors_contains&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1378"><a href="#FundingRoundsAgent-1378"><span class="linenos">1378</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1379"><a href="#FundingRoundsAgent-1379"><span class="linenos">1379</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Check if lead_investors array contains this value (investor name or UUID)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1380"><a href="#FundingRoundsAgent-1380"><span class="linenos">1380</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1381"><a href="#FundingRoundsAgent-1381"><span class="linenos">1381</span></a>                        <span class="s2">&quot;fundraise_amount_usd&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1382"><a href="#FundingRoundsAgent-1382"><span class="linenos">1382</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1383"><a href="#FundingRoundsAgent-1383"><span class="linenos">1383</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact fundraise amount in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1384"><a href="#FundingRoundsAgent-1384"><span class="linenos">1384</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1385"><a href="#FundingRoundsAgent-1385"><span class="linenos">1385</span></a>                        <span class="s2">&quot;fundraise_amount_usd_min&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1386"><a href="#FundingRoundsAgent-1386"><span class="linenos">1386</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1387"><a href="#FundingRoundsAgent-1387"><span class="linenos">1387</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Minimum fundraise amount in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1388"><a href="#FundingRoundsAgent-1388"><span class="linenos">1388</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1389"><a href="#FundingRoundsAgent-1389"><span class="linenos">1389</span></a>                        <span class="s2">&quot;fundraise_amount_usd_max&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1390"><a href="#FundingRoundsAgent-1390"><span class="linenos">1390</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1391"><a href="#FundingRoundsAgent-1391"><span class="linenos">1391</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum fundraise amount in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1392"><a href="#FundingRoundsAgent-1392"><span class="linenos">1392</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1393"><a href="#FundingRoundsAgent-1393"><span class="linenos">1393</span></a>                        <span class="s2">&quot;valuation_usd&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1394"><a href="#FundingRoundsAgent-1394"><span class="linenos">1394</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1395"><a href="#FundingRoundsAgent-1395"><span class="linenos">1395</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Exact valuation in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1396"><a href="#FundingRoundsAgent-1396"><span class="linenos">1396</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1397"><a href="#FundingRoundsAgent-1397"><span class="linenos">1397</span></a>                        <span class="s2">&quot;valuation_usd_min&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1398"><a href="#FundingRoundsAgent-1398"><span class="linenos">1398</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1399"><a href="#FundingRoundsAgent-1399"><span class="linenos">1399</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Minimum valuation in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1400"><a href="#FundingRoundsAgent-1400"><span class="linenos">1400</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1401"><a href="#FundingRoundsAgent-1401"><span class="linenos">1401</span></a>                        <span class="s2">&quot;valuation_usd_max&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1402"><a href="#FundingRoundsAgent-1402"><span class="linenos">1402</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1403"><a href="#FundingRoundsAgent-1403"><span class="linenos">1403</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum valuation in USD&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1404"><a href="#FundingRoundsAgent-1404"><span class="linenos">1404</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1405"><a href="#FundingRoundsAgent-1405"><span class="linenos">1405</span></a>                        <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1406"><a href="#FundingRoundsAgent-1406"><span class="linenos">1406</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1407"><a href="#FundingRoundsAgent-1407"><span class="linenos">1407</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Maximum number of results to return (default: 10 if not specified)&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1408"><a href="#FundingRoundsAgent-1408"><span class="linenos">1408</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1409"><a href="#FundingRoundsAgent-1409"><span class="linenos">1409</span></a>                        <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1410"><a href="#FundingRoundsAgent-1410"><span class="linenos">1410</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1411"><a href="#FundingRoundsAgent-1411"><span class="linenos">1411</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Number of results to skip for pagination&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1412"><a href="#FundingRoundsAgent-1412"><span class="linenos">1412</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1413"><a href="#FundingRoundsAgent-1413"><span class="linenos">1413</span></a>                        <span class="s2">&quot;include_organizations&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1414"><a href="#FundingRoundsAgent-1414"><span class="linenos">1414</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1415"><a href="#FundingRoundsAgent-1415"><span class="linenos">1415</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Include nested organization details for the company, investors, and lead investors. Should be set to true to get full organization information for generating insights.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1416"><a href="#FundingRoundsAgent-1416"><span class="linenos">1416</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1417"><a href="#FundingRoundsAgent-1417"><span class="linenos">1417</span></a>                        <span class="s2">&quot;order_by&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1418"><a href="#FundingRoundsAgent-1418"><span class="linenos">1418</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1419"><a href="#FundingRoundsAgent-1419"><span class="linenos">1419</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Field to order results by. Must be one of: &#39;investment_date&#39;, &#39;fundraise_amount_usd&#39;, &#39;valuation_usd&#39;. Use &#39;investment_date&#39; for chronological ordering, &#39;fundraise_amount_usd&#39; for amount-based ordering, &#39;valuation_usd&#39; for valuation-based ordering. Defaults to &#39;investment_date&#39; if not specified.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1420"><a href="#FundingRoundsAgent-1420"><span class="linenos">1420</span></a>                            <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="FundingRoundsAgent-1421"><a href="#FundingRoundsAgent-1421"><span class="linenos">1421</span></a>                                <span class="s2">&quot;investment_date&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1422"><a href="#FundingRoundsAgent-1422"><span class="linenos">1422</span></a>                                <span class="s2">&quot;fundraise_amount_usd&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1423"><a href="#FundingRoundsAgent-1423"><span class="linenos">1423</span></a>                                <span class="s2">&quot;valuation_usd&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1424"><a href="#FundingRoundsAgent-1424"><span class="linenos">1424</span></a>                            <span class="p">],</span>
</span><span id="FundingRoundsAgent-1425"><a href="#FundingRoundsAgent-1425"><span class="linenos">1425</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1426"><a href="#FundingRoundsAgent-1426"><span class="linenos">1426</span></a>                        <span class="s2">&quot;order_direction&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1427"><a href="#FundingRoundsAgent-1427"><span class="linenos">1427</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1428"><a href="#FundingRoundsAgent-1428"><span class="linenos">1428</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Direction to order results. Use &#39;desc&#39; for descending (newest/highest first), &#39;asc&#39; for ascending (oldest/lowest first). Defaults to &#39;desc&#39; if not specified.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1429"><a href="#FundingRoundsAgent-1429"><span class="linenos">1429</span></a>                            <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;asc&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1430"><a href="#FundingRoundsAgent-1430"><span class="linenos">1430</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1431"><a href="#FundingRoundsAgent-1431"><span class="linenos">1431</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-1432"><a href="#FundingRoundsAgent-1432"><span class="linenos">1432</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="FundingRoundsAgent-1433"><a href="#FundingRoundsAgent-1433"><span class="linenos">1433</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1434"><a href="#FundingRoundsAgent-1434"><span class="linenos">1434</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-1435"><a href="#FundingRoundsAgent-1435"><span class="linenos">1435</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-1436"><a href="#FundingRoundsAgent-1436"><span class="linenos">1436</span></a>
</span><span id="FundingRoundsAgent-1437"><a href="#FundingRoundsAgent-1437"><span class="linenos">1437</span></a>        <span class="c1"># Build system prompt using prompt manager</span>
</span><span id="FundingRoundsAgent-1438"><a href="#FundingRoundsAgent-1438"><span class="linenos">1438</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-1439"><a href="#FundingRoundsAgent-1439"><span class="linenos">1439</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_system_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1440"><a href="#FundingRoundsAgent-1440"><span class="linenos">1440</span></a>            <span class="n">base_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1441"><a href="#FundingRoundsAgent-1441"><span class="linenos">1441</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_markdown_instructions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1442"><a href="#FundingRoundsAgent-1442"><span class="linenos">1442</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1443"><a href="#FundingRoundsAgent-1443"><span class="linenos">1443</span></a>
</span><span id="FundingRoundsAgent-1444"><a href="#FundingRoundsAgent-1444"><span class="linenos">1444</span></a>        <span class="c1"># Build prompt with resolved UUIDs if available</span>
</span><span id="FundingRoundsAgent-1445"><a href="#FundingRoundsAgent-1445"><span class="linenos">1445</span></a>        <span class="n">uuid_info</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent-1446"><a href="#FundingRoundsAgent-1446"><span class="linenos">1446</span></a>        <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-1447"><a href="#FundingRoundsAgent-1447"><span class="linenos">1447</span></a>            <span class="n">uuid_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Organization UUID (already resolved): </span><span class="si">{</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s1">&#39;org_uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1448"><a href="#FundingRoundsAgent-1448"><span class="linenos">1448</span></a>
</span><span id="FundingRoundsAgent-1449"><a href="#FundingRoundsAgent-1449"><span class="linenos">1449</span></a>        <span class="n">uuid_context</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent-1450"><a href="#FundingRoundsAgent-1450"><span class="linenos">1450</span></a>            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uuid_info</span><span class="p">)</span> <span class="k">if</span> <span class="n">uuid_info</span> <span class="k">else</span> <span class="s2">&quot;No company names were identified in the query.&quot;</span>
</span><span id="FundingRoundsAgent-1451"><a href="#FundingRoundsAgent-1451"><span class="linenos">1451</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1452"><a href="#FundingRoundsAgent-1452"><span class="linenos">1452</span></a>
</span><span id="FundingRoundsAgent-1453"><a href="#FundingRoundsAgent-1453"><span class="linenos">1453</span></a>        <span class="c1"># Build user prompt using prompt manager</span>
</span><span id="FundingRoundsAgent-1454"><a href="#FundingRoundsAgent-1454"><span class="linenos">1454</span></a>        <span class="n">user_prompt_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1455"><a href="#FundingRoundsAgent-1455"><span class="linenos">1455</span></a>
</span><span id="FundingRoundsAgent-1456"><a href="#FundingRoundsAgent-1456"><span class="linenos">1456</span></a><span class="s2">Resolved Organization UUIDs:</span>
</span><span id="FundingRoundsAgent-1457"><a href="#FundingRoundsAgent-1457"><span class="linenos">1457</span></a><span class="si">{</span><span class="n">uuid_context</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1458"><a href="#FundingRoundsAgent-1458"><span class="linenos">1458</span></a>
</span><span id="FundingRoundsAgent-1459"><a href="#FundingRoundsAgent-1459"><span class="linenos">1459</span></a><span class="s2">Analyze this query and extract the relevant search parameters for finding funding rounds. Use the resolved UUIDs above if they are available. Only include parameters that are clearly mentioned or implied in the query.</span>
</span><span id="FundingRoundsAgent-1460"><a href="#FundingRoundsAgent-1460"><span class="linenos">1460</span></a>
</span><span id="FundingRoundsAgent-1461"><a href="#FundingRoundsAgent-1461"><span class="linenos">1461</span></a><span class="s2">Call the get_funding_rounds function with the extracted parameters.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1462"><a href="#FundingRoundsAgent-1462"><span class="linenos">1462</span></a>
</span><span id="FundingRoundsAgent-1463"><a href="#FundingRoundsAgent-1463"><span class="linenos">1463</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_user_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1464"><a href="#FundingRoundsAgent-1464"><span class="linenos">1464</span></a>            <span class="n">user_query</span><span class="o">=</span><span class="n">user_prompt_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1465"><a href="#FundingRoundsAgent-1465"><span class="linenos">1465</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1466"><a href="#FundingRoundsAgent-1466"><span class="linenos">1466</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1467"><a href="#FundingRoundsAgent-1467"><span class="linenos">1467</span></a>
</span><span id="FundingRoundsAgent-1468"><a href="#FundingRoundsAgent-1468"><span class="linenos">1468</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1469"><a href="#FundingRoundsAgent-1469"><span class="linenos">1469</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1470"><a href="#FundingRoundsAgent-1470"><span class="linenos">1470</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1471"><a href="#FundingRoundsAgent-1471"><span class="linenos">1471</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_funding_rounds_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1472"><a href="#FundingRoundsAgent-1472"><span class="linenos">1472</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1473"><a href="#FundingRoundsAgent-1473"><span class="linenos">1473</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1474"><a href="#FundingRoundsAgent-1474"><span class="linenos">1474</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Lower temperature for more consistent parameter extraction</span>
</span><span id="FundingRoundsAgent-1475"><a href="#FundingRoundsAgent-1475"><span class="linenos">1475</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-1476"><a href="#FundingRoundsAgent-1476"><span class="linenos">1476</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1477"><a href="#FundingRoundsAgent-1477"><span class="linenos">1477</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1478"><a href="#FundingRoundsAgent-1478"><span class="linenos">1478</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1479"><a href="#FundingRoundsAgent-1479"><span class="linenos">1479</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1480"><a href="#FundingRoundsAgent-1480"><span class="linenos">1480</span></a>
</span><span id="FundingRoundsAgent-1481"><a href="#FundingRoundsAgent-1481"><span class="linenos">1481</span></a>            <span class="c1"># Check if we got a function call result</span>
</span><span id="FundingRoundsAgent-1482"><a href="#FundingRoundsAgent-1482"><span class="linenos">1482</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1483"><a href="#FundingRoundsAgent-1483"><span class="linenos">1483</span></a>                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;function_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1484"><a href="#FundingRoundsAgent-1484"><span class="linenos">1484</span></a>                    <span class="n">params</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1485"><a href="#FundingRoundsAgent-1485"><span class="linenos">1485</span></a>                    <span class="c1"># Filter out None values and set default limit</span>
</span><span id="FundingRoundsAgent-1486"><a href="#FundingRoundsAgent-1486"><span class="linenos">1486</span></a>                    <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-1487"><a href="#FundingRoundsAgent-1487"><span class="linenos">1487</span></a>
</span><span id="FundingRoundsAgent-1488"><a href="#FundingRoundsAgent-1488"><span class="linenos">1488</span></a>                    <span class="c1"># Override with resolved UUIDs if available (they take precedence)</span>
</span><span id="FundingRoundsAgent-1489"><a href="#FundingRoundsAgent-1489"><span class="linenos">1489</span></a>                    <span class="c1"># Only use resolved UUID if it&#39;s a valid UUID string</span>
</span><span id="FundingRoundsAgent-1490"><a href="#FundingRoundsAgent-1490"><span class="linenos">1490</span></a>                    <span class="n">resolved_uuid</span> <span class="o">=</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1491"><a href="#FundingRoundsAgent-1491"><span class="linenos">1491</span></a>                    <span class="k">if</span> <span class="n">resolved_uuid</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1492"><a href="#FundingRoundsAgent-1492"><span class="linenos">1492</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1493"><a href="#FundingRoundsAgent-1493"><span class="linenos">1493</span></a>                            <span class="c1"># Validate that it&#39;s a valid UUID string</span>
</span><span id="FundingRoundsAgent-1494"><a href="#FundingRoundsAgent-1494"><span class="linenos">1494</span></a>                            <span class="n">UUID</span><span class="p">(</span><span class="n">resolved_uuid</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1495"><a href="#FundingRoundsAgent-1495"><span class="linenos">1495</span></a>                            <span class="n">filtered_params</span><span class="p">[</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_uuid</span>
</span><span id="FundingRoundsAgent-1496"><a href="#FundingRoundsAgent-1496"><span class="linenos">1496</span></a>                        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span id="FundingRoundsAgent-1497"><a href="#FundingRoundsAgent-1497"><span class="linenos">1497</span></a>                            <span class="c1"># Invalid UUID, log warning and skip it</span>
</span><span id="FundingRoundsAgent-1498"><a href="#FundingRoundsAgent-1498"><span class="linenos">1498</span></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1499"><a href="#FundingRoundsAgent-1499"><span class="linenos">1499</span></a>                                <span class="sa">f</span><span class="s2">&quot;Invalid UUID from resolved_uuids: </span><span class="si">{</span><span class="n">resolved_uuid</span><span class="si">}</span><span class="s2">, skipping&quot;</span>
</span><span id="FundingRoundsAgent-1500"><a href="#FundingRoundsAgent-1500"><span class="linenos">1500</span></a>                            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1501"><a href="#FundingRoundsAgent-1501"><span class="linenos">1501</span></a>
</span><span id="FundingRoundsAgent-1502"><a href="#FundingRoundsAgent-1502"><span class="linenos">1502</span></a>                    <span class="k">if</span> <span class="s2">&quot;limit&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_params</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1503"><a href="#FundingRoundsAgent-1503"><span class="linenos">1503</span></a>                        <span class="n">filtered_params</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="FundingRoundsAgent-1504"><a href="#FundingRoundsAgent-1504"><span class="linenos">1504</span></a>                    <span class="c1"># Always include organizations for better insights</span>
</span><span id="FundingRoundsAgent-1505"><a href="#FundingRoundsAgent-1505"><span class="linenos">1505</span></a>                    <span class="n">filtered_params</span><span class="p">[</span><span class="s2">&quot;include_organizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FundingRoundsAgent-1506"><a href="#FundingRoundsAgent-1506"><span class="linenos">1506</span></a>                    <span class="k">return</span> <span class="n">filtered_params</span>
</span><span id="FundingRoundsAgent-1507"><a href="#FundingRoundsAgent-1507"><span class="linenos">1507</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1508"><a href="#FundingRoundsAgent-1508"><span class="linenos">1508</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1509"><a href="#FundingRoundsAgent-1509"><span class="linenos">1509</span></a>                        <span class="sa">f</span><span class="s2">&quot;Unexpected function call: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, using defaults&quot;</span>
</span><span id="FundingRoundsAgent-1510"><a href="#FundingRoundsAgent-1510"><span class="linenos">1510</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1511"><a href="#FundingRoundsAgent-1511"><span class="linenos">1511</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-1512"><a href="#FundingRoundsAgent-1512"><span class="linenos">1512</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1513"><a href="#FundingRoundsAgent-1513"><span class="linenos">1513</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1514"><a href="#FundingRoundsAgent-1514"><span class="linenos">1514</span></a>                    <span class="sa">f</span><span class="s2">&quot;LLM did not make expected function call. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">, using defaults&quot;</span>
</span><span id="FundingRoundsAgent-1515"><a href="#FundingRoundsAgent-1515"><span class="linenos">1515</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1516"><a href="#FundingRoundsAgent-1516"><span class="linenos">1516</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-1517"><a href="#FundingRoundsAgent-1517"><span class="linenos">1517</span></a>
</span><span id="FundingRoundsAgent-1518"><a href="#FundingRoundsAgent-1518"><span class="linenos">1518</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1519"><a href="#FundingRoundsAgent-1519"><span class="linenos">1519</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM parameter extraction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, using defaults&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1520"><a href="#FundingRoundsAgent-1520"><span class="linenos">1520</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</span><span id="FundingRoundsAgent-1521"><a href="#FundingRoundsAgent-1521"><span class="linenos">1521</span></a>
</span><span id="FundingRoundsAgent-1522"><a href="#FundingRoundsAgent-1522"><span class="linenos">1522</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_format_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1523"><a href="#FundingRoundsAgent-1523"><span class="linenos">1523</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1524"><a href="#FundingRoundsAgent-1524"><span class="linenos">1524</span></a>        <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1525"><a href="#FundingRoundsAgent-1525"><span class="linenos">1525</span></a>        <span class="n">funding_rounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="FundingRoundsAgent-1526"><a href="#FundingRoundsAgent-1526"><span class="linenos">1526</span></a>        <span class="n">search_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1527"><a href="#FundingRoundsAgent-1527"><span class="linenos">1527</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentInsight</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1528"><a href="#FundingRoundsAgent-1528"><span class="linenos">1528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate domain insight from funding round data using LLM.</span>
</span><span id="FundingRoundsAgent-1529"><a href="#FundingRoundsAgent-1529"><span class="linenos">1529</span></a>
</span><span id="FundingRoundsAgent-1530"><a href="#FundingRoundsAgent-1530"><span class="linenos">1530</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent-1531"><a href="#FundingRoundsAgent-1531"><span class="linenos">1531</span></a><span class="sd">            context: The agent context.</span>
</span><span id="FundingRoundsAgent-1532"><a href="#FundingRoundsAgent-1532"><span class="linenos">1532</span></a><span class="sd">            funding_rounds: List of funding round records from the database.</span>
</span><span id="FundingRoundsAgent-1533"><a href="#FundingRoundsAgent-1533"><span class="linenos">1533</span></a><span class="sd">            search_params: Parameters used for the search.</span>
</span><span id="FundingRoundsAgent-1534"><a href="#FundingRoundsAgent-1534"><span class="linenos">1534</span></a>
</span><span id="FundingRoundsAgent-1535"><a href="#FundingRoundsAgent-1535"><span class="linenos">1535</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent-1536"><a href="#FundingRoundsAgent-1536"><span class="linenos">1536</span></a><span class="sd">            AgentInsight object with domain interpretation and reasoning.</span>
</span><span id="FundingRoundsAgent-1537"><a href="#FundingRoundsAgent-1537"><span class="linenos">1537</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1538"><a href="#FundingRoundsAgent-1538"><span class="linenos">1538</span></a>        <span class="c1"># Define function schema matching AgentInsight structure</span>
</span><span id="FundingRoundsAgent-1539"><a href="#FundingRoundsAgent-1539"><span class="linenos">1539</span></a>        <span class="n">generate_insight_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1540"><a href="#FundingRoundsAgent-1540"><span class="linenos">1540</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1541"><a href="#FundingRoundsAgent-1541"><span class="linenos">1541</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1542"><a href="#FundingRoundsAgent-1542"><span class="linenos">1542</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1543"><a href="#FundingRoundsAgent-1543"><span class="linenos">1543</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Generate domain insight from funding round data&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1544"><a href="#FundingRoundsAgent-1544"><span class="linenos">1544</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1545"><a href="#FundingRoundsAgent-1545"><span class="linenos">1545</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1546"><a href="#FundingRoundsAgent-1546"><span class="linenos">1546</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1547"><a href="#FundingRoundsAgent-1547"><span class="linenos">1547</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1548"><a href="#FundingRoundsAgent-1548"><span class="linenos">1548</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1549"><a href="#FundingRoundsAgent-1549"><span class="linenos">1549</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Human-readable insight summary answering the user&#39;s query&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1550"><a href="#FundingRoundsAgent-1550"><span class="linenos">1550</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1551"><a href="#FundingRoundsAgent-1551"><span class="linenos">1551</span></a>                        <span class="s2">&quot;key_findings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1552"><a href="#FundingRoundsAgent-1552"><span class="linenos">1552</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1553"><a href="#FundingRoundsAgent-1553"><span class="linenos">1553</span></a>                            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1554"><a href="#FundingRoundsAgent-1554"><span class="linenos">1554</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Bullet points of key findings&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1555"><a href="#FundingRoundsAgent-1555"><span class="linenos">1555</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1556"><a href="#FundingRoundsAgent-1556"><span class="linenos">1556</span></a>                        <span class="s2">&quot;evidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1557"><a href="#FundingRoundsAgent-1557"><span class="linenos">1557</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1558"><a href="#FundingRoundsAgent-1558"><span class="linenos">1558</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Supporting data from tool calls&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1559"><a href="#FundingRoundsAgent-1559"><span class="linenos">1559</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1560"><a href="#FundingRoundsAgent-1560"><span class="linenos">1560</span></a>                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent-1561"><a href="#FundingRoundsAgent-1561"><span class="linenos">1561</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1562"><a href="#FundingRoundsAgent-1562"><span class="linenos">1562</span></a>                            <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1563"><a href="#FundingRoundsAgent-1563"><span class="linenos">1563</span></a>                            <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1564"><a href="#FundingRoundsAgent-1564"><span class="linenos">1564</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Confidence in the insight&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1565"><a href="#FundingRoundsAgent-1565"><span class="linenos">1565</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent-1566"><a href="#FundingRoundsAgent-1566"><span class="linenos">1566</span></a>                    <span class="p">},</span>
</span><span id="FundingRoundsAgent-1567"><a href="#FundingRoundsAgent-1567"><span class="linenos">1567</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1568"><a href="#FundingRoundsAgent-1568"><span class="linenos">1568</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1569"><a href="#FundingRoundsAgent-1569"><span class="linenos">1569</span></a>            <span class="p">},</span>
</span><span id="FundingRoundsAgent-1570"><a href="#FundingRoundsAgent-1570"><span class="linenos">1570</span></a>        <span class="p">}</span>
</span><span id="FundingRoundsAgent-1571"><a href="#FundingRoundsAgent-1571"><span class="linenos">1571</span></a>
</span><span id="FundingRoundsAgent-1572"><a href="#FundingRoundsAgent-1572"><span class="linenos">1572</span></a>        <span class="c1"># Build system prompt using prompt_manager</span>
</span><span id="FundingRoundsAgent-1573"><a href="#FundingRoundsAgent-1573"><span class="linenos">1573</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent-1574"><a href="#FundingRoundsAgent-1574"><span class="linenos">1574</span></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a funding rounds analysis expert. Analyze the funding round data and generate insights that directly answer the user&#39;s query.</span>
</span><span id="FundingRoundsAgent-1575"><a href="#FundingRoundsAgent-1575"><span class="linenos">1575</span></a>
</span><span id="FundingRoundsAgent-1576"><a href="#FundingRoundsAgent-1576"><span class="linenos">1576</span></a><span class="s2">Your task:</span>
</span><span id="FundingRoundsAgent-1577"><a href="#FundingRoundsAgent-1577"><span class="linenos">1577</span></a><span class="s2">- Identify funding trends over time</span>
</span><span id="FundingRoundsAgent-1578"><a href="#FundingRoundsAgent-1578"><span class="linenos">1578</span></a><span class="s2">- Highlight notable rounds (size, investors, stage)</span>
</span><span id="FundingRoundsAgent-1579"><a href="#FundingRoundsAgent-1579"><span class="linenos">1579</span></a><span class="s2">- Identify patterns (funding velocity, stage progression)</span>
</span><span id="FundingRoundsAgent-1580"><a href="#FundingRoundsAgent-1580"><span class="linenos">1580</span></a><span class="s2">- Compare funding across companies/sectors if multiple results</span>
</span><span id="FundingRoundsAgent-1581"><a href="#FundingRoundsAgent-1581"><span class="linenos">1581</span></a><span class="s2">- State uncertainty where data is missing</span>
</span><span id="FundingRoundsAgent-1582"><a href="#FundingRoundsAgent-1582"><span class="linenos">1582</span></a><span class="s2">- Directly answer the user&#39;s query in the summary</span>
</span><span id="FundingRoundsAgent-1583"><a href="#FundingRoundsAgent-1583"><span class="linenos">1583</span></a>
</span><span id="FundingRoundsAgent-1584"><a href="#FundingRoundsAgent-1584"><span class="linenos">1584</span></a><span class="s2">If no funding rounds are found, explain why (e.g., search criteria too narrow, no data available for the specified parameters).&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1585"><a href="#FundingRoundsAgent-1585"><span class="linenos">1585</span></a>
</span><span id="FundingRoundsAgent-1586"><a href="#FundingRoundsAgent-1586"><span class="linenos">1586</span></a>        <span class="n">system_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_system_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1587"><a href="#FundingRoundsAgent-1587"><span class="linenos">1587</span></a>            <span class="n">base_prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1588"><a href="#FundingRoundsAgent-1588"><span class="linenos">1588</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_markdown_instructions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1589"><a href="#FundingRoundsAgent-1589"><span class="linenos">1589</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1590"><a href="#FundingRoundsAgent-1590"><span class="linenos">1590</span></a>
</span><span id="FundingRoundsAgent-1591"><a href="#FundingRoundsAgent-1591"><span class="linenos">1591</span></a>        <span class="c1"># Build user prompt with data</span>
</span><span id="FundingRoundsAgent-1592"><a href="#FundingRoundsAgent-1592"><span class="linenos">1592</span></a>        <span class="n">user_prompt_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;User Query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1593"><a href="#FundingRoundsAgent-1593"><span class="linenos">1593</span></a>
</span><span id="FundingRoundsAgent-1594"><a href="#FundingRoundsAgent-1594"><span class="linenos">1594</span></a><span class="s2">Funding Rounds Data (JSON):</span>
</span><span id="FundingRoundsAgent-1595"><a href="#FundingRoundsAgent-1595"><span class="linenos">1595</span></a><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1596"><a href="#FundingRoundsAgent-1596"><span class="linenos">1596</span></a>
</span><span id="FundingRoundsAgent-1597"><a href="#FundingRoundsAgent-1597"><span class="linenos">1597</span></a><span class="s2">Search Parameters: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">search_params</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span>
</span><span id="FundingRoundsAgent-1598"><a href="#FundingRoundsAgent-1598"><span class="linenos">1598</span></a>
</span><span id="FundingRoundsAgent-1599"><a href="#FundingRoundsAgent-1599"><span class="linenos">1599</span></a><span class="s2">Analyze this data and generate insights that directly answer the user&#39;s query. Call the generate_insight function with your analysis.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent-1600"><a href="#FundingRoundsAgent-1600"><span class="linenos">1600</span></a>
</span><span id="FundingRoundsAgent-1601"><a href="#FundingRoundsAgent-1601"><span class="linenos">1601</span></a>        <span class="n">user_prompt</span> <span class="o">=</span> <span class="n">prompt_manager</span><span class="o">.</span><span class="n">build_user_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1602"><a href="#FundingRoundsAgent-1602"><span class="linenos">1602</span></a>            <span class="n">user_query</span><span class="o">=</span><span class="n">user_prompt_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1603"><a href="#FundingRoundsAgent-1603"><span class="linenos">1603</span></a>            <span class="n">options</span><span class="o">=</span><span class="n">PromptOptions</span><span class="p">(</span><span class="n">add_temporal_context</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1604"><a href="#FundingRoundsAgent-1604"><span class="linenos">1604</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent-1605"><a href="#FundingRoundsAgent-1605"><span class="linenos">1605</span></a>
</span><span id="FundingRoundsAgent-1606"><a href="#FundingRoundsAgent-1606"><span class="linenos">1606</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1607"><a href="#FundingRoundsAgent-1607"><span class="linenos">1607</span></a>            <span class="c1"># Call LLM with function calling</span>
</span><span id="FundingRoundsAgent-1608"><a href="#FundingRoundsAgent-1608"><span class="linenos">1608</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_llm_function_response</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1609"><a href="#FundingRoundsAgent-1609"><span class="linenos">1609</span></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">user_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1610"><a href="#FundingRoundsAgent-1610"><span class="linenos">1610</span></a>                <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">generate_insight_tool</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1611"><a href="#FundingRoundsAgent-1611"><span class="linenos">1611</span></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1612"><a href="#FundingRoundsAgent-1612"><span class="linenos">1612</span></a>                <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-mini&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1613"><a href="#FundingRoundsAgent-1613"><span class="linenos">1613</span></a>                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1614"><a href="#FundingRoundsAgent-1614"><span class="linenos">1614</span></a>                <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent-1615"><a href="#FundingRoundsAgent-1615"><span class="linenos">1615</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1616"><a href="#FundingRoundsAgent-1616"><span class="linenos">1616</span></a>                    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_insight&quot;</span><span class="p">},</span>
</span><span id="FundingRoundsAgent-1617"><a href="#FundingRoundsAgent-1617"><span class="linenos">1617</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent-1618"><a href="#FundingRoundsAgent-1618"><span class="linenos">1618</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent-1619"><a href="#FundingRoundsAgent-1619"><span class="linenos">1619</span></a>
</span><span id="FundingRoundsAgent-1620"><a href="#FundingRoundsAgent-1620"><span class="linenos">1620</span></a>            <span class="c1"># Extract and return AgentInsight</span>
</span><span id="FundingRoundsAgent-1621"><a href="#FundingRoundsAgent-1621"><span class="linenos">1621</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;function_name&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1622"><a href="#FundingRoundsAgent-1622"><span class="linenos">1622</span></a>                <span class="n">args</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="FundingRoundsAgent-1623"><a href="#FundingRoundsAgent-1623"><span class="linenos">1623</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1624"><a href="#FundingRoundsAgent-1624"><span class="linenos">1624</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent-1625"><a href="#FundingRoundsAgent-1625"><span class="linenos">1625</span></a>                    <span class="n">key_findings</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_findings&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1626"><a href="#FundingRoundsAgent-1626"><span class="linenos">1626</span></a>                    <span class="n">evidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1627"><a href="#FundingRoundsAgent-1627"><span class="linenos">1627</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
</span><span id="FundingRoundsAgent-1628"><a href="#FundingRoundsAgent-1628"><span class="linenos">1628</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1629"><a href="#FundingRoundsAgent-1629"><span class="linenos">1629</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1630"><a href="#FundingRoundsAgent-1630"><span class="linenos">1630</span></a>                <span class="c1"># Fallback if LLM doesn&#39;t call function</span>
</span><span id="FundingRoundsAgent-1631"><a href="#FundingRoundsAgent-1631"><span class="linenos">1631</span></a>                <span class="k">if</span> <span class="n">funding_rounds</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1632"><a href="#FundingRoundsAgent-1632"><span class="linenos">1632</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1633"><a href="#FundingRoundsAgent-1633"><span class="linenos">1633</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">)</span><span class="si">}</span><span class="s2"> funding round(s) but failed to generate insight.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1634"><a href="#FundingRoundsAgent-1634"><span class="linenos">1634</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1635"><a href="#FundingRoundsAgent-1635"><span class="linenos">1635</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1636"><a href="#FundingRoundsAgent-1636"><span class="linenos">1636</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1637"><a href="#FundingRoundsAgent-1637"><span class="linenos">1637</span></a>                    <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1638"><a href="#FundingRoundsAgent-1638"><span class="linenos">1638</span></a>                        <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;I couldn&#39;t find any funding rounds matching your criteria. You asked about: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">. Try adjusting your search parameters or broadening your criteria.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1639"><a href="#FundingRoundsAgent-1639"><span class="linenos">1639</span></a>                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1640"><a href="#FundingRoundsAgent-1640"><span class="linenos">1640</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent-1641"><a href="#FundingRoundsAgent-1641"><span class="linenos">1641</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1642"><a href="#FundingRoundsAgent-1642"><span class="linenos">1642</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate insight from LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent-1643"><a href="#FundingRoundsAgent-1643"><span class="linenos">1643</span></a>            <span class="c1"># Fallback insight</span>
</span><span id="FundingRoundsAgent-1644"><a href="#FundingRoundsAgent-1644"><span class="linenos">1644</span></a>            <span class="k">if</span> <span class="n">funding_rounds</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1645"><a href="#FundingRoundsAgent-1645"><span class="linenos">1645</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1646"><a href="#FundingRoundsAgent-1646"><span class="linenos">1646</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">)</span><span class="si">}</span><span class="s2"> funding round(s) but encountered an error generating insights.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1647"><a href="#FundingRoundsAgent-1647"><span class="linenos">1647</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1648"><a href="#FundingRoundsAgent-1648"><span class="linenos">1648</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent-1649"><a href="#FundingRoundsAgent-1649"><span class="linenos">1649</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent-1650"><a href="#FundingRoundsAgent-1650"><span class="linenos">1650</span></a>                <span class="k">return</span> <span class="n">AgentInsight</span><span class="p">(</span>
</span><span id="FundingRoundsAgent-1651"><a href="#FundingRoundsAgent-1651"><span class="linenos">1651</span></a>                    <span class="n">summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;I couldn&#39;t find any funding rounds matching your criteria. You asked about: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">. Try adjusting your search parameters or broadening your criteria.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1652"><a href="#FundingRoundsAgent-1652"><span class="linenos">1652</span></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="FundingRoundsAgent-1653"><a href="#FundingRoundsAgent-1653"><span class="linenos">1653</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Agent specialized in handling funding round-related queries and data retrieval.</p>

<p>This agent uses LLM reasoning to understand user queries about funding rounds
and calls the get_funding_rounds tool to retrieve relevant data from the database.</p>
</div>


                            <div id="FundingRoundsAgent.__init__" class="classattr">
                                        <input id="FundingRoundsAgent.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FundingRoundsAgent</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="FundingRoundsAgent.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FundingRoundsAgent.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FundingRoundsAgent.__init__-50"><a href="#FundingRoundsAgent.__init__-50"><span class="linenos"> 50</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="FundingRoundsAgent.__init__-51"><a href="#FundingRoundsAgent.__init__-51"><span class="linenos"> 51</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the funding rounds agent.</span>
</span><span id="FundingRoundsAgent.__init__-52"><a href="#FundingRoundsAgent.__init__-52"><span class="linenos"> 52</span></a>
</span><span id="FundingRoundsAgent.__init__-53"><a href="#FundingRoundsAgent.__init__-53"><span class="linenos"> 53</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent.__init__-54"><a href="#FundingRoundsAgent.__init__-54"><span class="linenos"> 54</span></a><span class="sd">            config_path: Path to the agent&#39;s YAML config file.</span>
</span><span id="FundingRoundsAgent.__init__-55"><a href="#FundingRoundsAgent.__init__-55"><span class="linenos"> 55</span></a><span class="sd">                If None, will attempt to find it automatically.</span>
</span><span id="FundingRoundsAgent.__init__-56"><a href="#FundingRoundsAgent.__init__-56"><span class="linenos"> 56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent.__init__-57"><a href="#FundingRoundsAgent.__init__-57"><span class="linenos"> 57</span></a>        <span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.__init__-58"><a href="#FundingRoundsAgent.__init__-58"><span class="linenos"> 58</span></a>            <span class="c1"># Default to funding_rounds_agent.yaml in configs/agents</span>
</span><span id="FundingRoundsAgent.__init__-59"><a href="#FundingRoundsAgent.__init__-59"><span class="linenos"> 59</span></a>            <span class="n">src_base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span><span id="FundingRoundsAgent.__init__-60"><a href="#FundingRoundsAgent.__init__-60"><span class="linenos"> 60</span></a>            <span class="n">config_path</span> <span class="o">=</span> <span class="n">src_base</span> <span class="o">/</span> <span class="s2">&quot;configs&quot;</span> <span class="o">/</span> <span class="s2">&quot;agents&quot;</span> <span class="o">/</span> <span class="s2">&quot;funding_rounds_agent.yaml&quot;</span>
</span><span id="FundingRoundsAgent.__init__-61"><a href="#FundingRoundsAgent.__init__-61"><span class="linenos"> 61</span></a>
</span><span id="FundingRoundsAgent.__init__-62"><a href="#FundingRoundsAgent.__init__-62"><span class="linenos"> 62</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">config_path</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.__init__-63"><a href="#FundingRoundsAgent.__init__-63"><span class="linenos"> 63</span></a>
</span><span id="FundingRoundsAgent.__init__-64"><a href="#FundingRoundsAgent.__init__-64"><span class="linenos"> 64</span></a>        <span class="c1"># Store base prompts as instance variables for reuse</span>
</span><span id="FundingRoundsAgent.__init__-65"><a href="#FundingRoundsAgent.__init__-65"><span class="linenos"> 65</span></a>        <span class="c1"># Base prompt for company name and sector identification</span>
</span><span id="FundingRoundsAgent.__init__-66"><a href="#FundingRoundsAgent.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_identify_companies_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are analyzing a query about funding rounds. Your job is to identify:</span>
</span><span id="FundingRoundsAgent.__init__-67"><a href="#FundingRoundsAgent.__init__-67"><span class="linenos"> 67</span></a><span class="s2">1. Specific company names mentioned in the query</span>
</span><span id="FundingRoundsAgent.__init__-68"><a href="#FundingRoundsAgent.__init__-68"><span class="linenos"> 68</span></a><span class="s2">2. Sector/industry names mentioned in the query (for semantic search)</span>
</span><span id="FundingRoundsAgent.__init__-69"><a href="#FundingRoundsAgent.__init__-69"><span class="linenos"> 69</span></a>
</span><span id="FundingRoundsAgent.__init__-70"><a href="#FundingRoundsAgent.__init__-70"><span class="linenos"> 70</span></a><span class="s2">IMPORTANT: The semantic_search_organizations tool is designed to query by SECTOR/INDUSTRY names, not specific company names. For specific company names, use get_organizations with name/name_ilike parameter.</span>
</span><span id="FundingRoundsAgent.__init__-71"><a href="#FundingRoundsAgent.__init__-71"><span class="linenos"> 71</span></a>
</span><span id="FundingRoundsAgent.__init__-72"><a href="#FundingRoundsAgent.__init__-72"><span class="linenos"> 72</span></a><span class="s2">Examples:</span>
</span><span id="FundingRoundsAgent.__init__-73"><a href="#FundingRoundsAgent.__init__-73"><span class="linenos"> 73</span></a><span class="s2">- &quot;What funding rounds did Google raise?&quot; → company_name: &quot;Google&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent.__init__-74"><a href="#FundingRoundsAgent.__init__-74"><span class="linenos"> 74</span></a><span class="s2">- &quot;Show me funding rounds for Microsoft&quot; → company_name: &quot;Microsoft&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent.__init__-75"><a href="#FundingRoundsAgent.__init__-75"><span class="linenos"> 75</span></a><span class="s2">- &quot;Tell me about funding rounds for AI startups&quot; → company_name: None, sector_name: &quot;AI startups&quot;</span>
</span><span id="FundingRoundsAgent.__init__-76"><a href="#FundingRoundsAgent.__init__-76"><span class="linenos"> 76</span></a><span class="s2">- &quot;Funding rounds for GitHub&quot; → company_name: &quot;GitHub&quot;, sector_name: None</span>
</span><span id="FundingRoundsAgent.__init__-77"><a href="#FundingRoundsAgent.__init__-77"><span class="linenos"> 77</span></a><span class="s2">- &quot;Funding rounds for healthcare companies&quot; → company_name: None, sector_name: &quot;healthcare companies&quot;</span>
</span><span id="FundingRoundsAgent.__init__-78"><a href="#FundingRoundsAgent.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="FundingRoundsAgent.__init__-79"><a href="#FundingRoundsAgent.__init__-79"><span class="linenos"> 79</span></a><span class="s2">Only identify names that are clearly company names or sector/industry names. Leave fields as null if not mentioned.&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent.__init__-80"><a href="#FundingRoundsAgent.__init__-80"><span class="linenos"> 80</span></a>
</span><span id="FundingRoundsAgent.__init__-81"><a href="#FundingRoundsAgent.__init__-81"><span class="linenos"> 81</span></a>        <span class="c1"># Base prompt for parameter extraction</span>
</span><span id="FundingRoundsAgent.__init__-82"><a href="#FundingRoundsAgent.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are a funding rounds search assistant. Your job is to analyze user queries about funding rounds and extract relevant search parameters.</span>
</span><span id="FundingRoundsAgent.__init__-83"><a href="#FundingRoundsAgent.__init__-83"><span class="linenos"> 83</span></a>
</span><span id="FundingRoundsAgent.__init__-84"><a href="#FundingRoundsAgent.__init__-84"><span class="linenos"> 84</span></a><span class="s2">Rules:</span>
</span><span id="FundingRoundsAgent.__init__-85"><a href="#FundingRoundsAgent.__init__-85"><span class="linenos"> 85</span></a><span class="s2">- Only extract parameters that are explicitly mentioned or clearly implied in the query</span>
</span><span id="FundingRoundsAgent.__init__-86"><a href="#FundingRoundsAgent.__init__-86"><span class="linenos"> 86</span></a><span class="s2">- For date ranges, convert relative terms (e.g., &quot;last year&quot;, &quot;2023&quot;) to ISO format dates</span>
</span><span id="FundingRoundsAgent.__init__-87"><a href="#FundingRoundsAgent.__init__-87"><span class="linenos"> 87</span></a><span class="s2">- For amounts, convert mentions like &quot;over $1M&quot; to fundraise_amount_usd_min</span>
</span><span id="FundingRoundsAgent.__init__-88"><a href="#FundingRoundsAgent.__init__-88"><span class="linenos"> 88</span></a><span class="s2">- Company names have already been resolved to UUIDs - use the provided UUIDs if available</span>
</span><span id="FundingRoundsAgent.__init__-89"><a href="#FundingRoundsAgent.__init__-89"><span class="linenos"> 89</span></a><span class="s2">- Set a reasonable limit (default 10) if the user doesn&#39;t specify</span>
</span><span id="FundingRoundsAgent.__init__-90"><a href="#FundingRoundsAgent.__init__-90"><span class="linenos"> 90</span></a><span class="s2">- Leave parameters as None/null if not mentioned in the query</span>
</span><span id="FundingRoundsAgent.__init__-91"><a href="#FundingRoundsAgent.__init__-91"><span class="linenos"> 91</span></a><span class="s2">- Be conservative - only extract what you&#39;re confident about&quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent.__init__-92"><a href="#FundingRoundsAgent.__init__-92"><span class="linenos"> 92</span></a>
</span><span id="FundingRoundsAgent.__init__-93"><a href="#FundingRoundsAgent.__init__-93"><span class="linenos"> 93</span></a>        <span class="c1"># Register prompts with prompt manager for consistency and potential reuse</span>
</span><span id="FundingRoundsAgent.__init__-94"><a href="#FundingRoundsAgent.__init__-94"><span class="linenos"> 94</span></a>        <span class="n">prompt_manager</span> <span class="o">=</span> <span class="n">get_prompt_manager</span><span class="p">()</span>
</span><span id="FundingRoundsAgent.__init__-95"><a href="#FundingRoundsAgent.__init__-95"><span class="linenos"> 95</span></a>        <span class="n">prompt_manager</span><span class="o">.</span><span class="n">register_agent_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.__init__-96"><a href="#FundingRoundsAgent.__init__-96"><span class="linenos"> 96</span></a>            <span class="n">agent_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_identify_companies&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-97"><a href="#FundingRoundsAgent.__init__-97"><span class="linenos"> 97</span></a>            <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_identify_companies_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-98"><a href="#FundingRoundsAgent.__init__-98"><span class="linenos"> 98</span></a>            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-99"><a href="#FundingRoundsAgent.__init__-99"><span class="linenos"> 99</span></a>        <span class="p">)</span>
</span><span id="FundingRoundsAgent.__init__-100"><a href="#FundingRoundsAgent.__init__-100"><span class="linenos">100</span></a>        <span class="n">prompt_manager</span><span class="o">.</span><span class="n">register_agent_prompt</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.__init__-101"><a href="#FundingRoundsAgent.__init__-101"><span class="linenos">101</span></a>            <span class="n">agent_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_extract_params&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-102"><a href="#FundingRoundsAgent.__init__-102"><span class="linenos">102</span></a>            <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_prompt</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-103"><a href="#FundingRoundsAgent.__init__-103"><span class="linenos">103</span></a>            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.__init__-104"><a href="#FundingRoundsAgent.__init__-104"><span class="linenos">104</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the funding rounds agent.</p>

<p>Args:
    config_path: Path to the agent's YAML config file.
        If None, will attempt to find it automatically.</p>
</div>


                            </div>
                            <div id="FundingRoundsAgent.execute" class="classattr">
                                        <input id="FundingRoundsAgent.execute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-observe">@observe(as_type=&#39;agent&#39;)</div>

        <span class="def">async def</span>
        <span class="name">execute</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">context</span><span class="p">:</span> <span class="n"><a href="../core.html#AgentContext">src.core.AgentContext</a></span></span><span class="return-annotation">) -> <span class="n">src</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">agent_io</span><span class="o">.</span><span class="n">AgentOutput</span>:</span></span>

                <label class="view-source-button" for="FundingRoundsAgent.execute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FundingRoundsAgent.execute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FundingRoundsAgent.execute-106"><a href="#FundingRoundsAgent.execute-106"><span class="linenos">106</span></a>    <span class="nd">@observe</span><span class="p">(</span><span class="n">as_type</span><span class="o">=</span><span class="s2">&quot;agent&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-107"><a href="#FundingRoundsAgent.execute-107"><span class="linenos">107</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentOutput</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-108"><a href="#FundingRoundsAgent.execute-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the funding rounds agent to handle funding round-related queries.</span>
</span><span id="FundingRoundsAgent.execute-109"><a href="#FundingRoundsAgent.execute-109"><span class="linenos">109</span></a>
</span><span id="FundingRoundsAgent.execute-110"><a href="#FundingRoundsAgent.execute-110"><span class="linenos">110</span></a><span class="sd">        This method:</span>
</span><span id="FundingRoundsAgent.execute-111"><a href="#FundingRoundsAgent.execute-111"><span class="linenos">111</span></a><span class="sd">        1. Analyzes the user query to identify company names mentioned</span>
</span><span id="FundingRoundsAgent.execute-112"><a href="#FundingRoundsAgent.execute-112"><span class="linenos">112</span></a><span class="sd">        2. Resolves company names to UUIDs using semantic_search_organizations</span>
</span><span id="FundingRoundsAgent.execute-113"><a href="#FundingRoundsAgent.execute-113"><span class="linenos">113</span></a><span class="sd">        3. Extracts other search parameters (dates, amounts, investors, stages, etc.)</span>
</span><span id="FundingRoundsAgent.execute-114"><a href="#FundingRoundsAgent.execute-114"><span class="linenos">114</span></a><span class="sd">        4. Calls the get_funding_rounds tool with resolved UUIDs and parameters</span>
</span><span id="FundingRoundsAgent.execute-115"><a href="#FundingRoundsAgent.execute-115"><span class="linenos">115</span></a><span class="sd">        5. Formats the results into a natural language response</span>
</span><span id="FundingRoundsAgent.execute-116"><a href="#FundingRoundsAgent.execute-116"><span class="linenos">116</span></a><span class="sd">        6. Returns a structured response with tool calls tracked</span>
</span><span id="FundingRoundsAgent.execute-117"><a href="#FundingRoundsAgent.execute-117"><span class="linenos">117</span></a>
</span><span id="FundingRoundsAgent.execute-118"><a href="#FundingRoundsAgent.execute-118"><span class="linenos">118</span></a><span class="sd">        Args:</span>
</span><span id="FundingRoundsAgent.execute-119"><a href="#FundingRoundsAgent.execute-119"><span class="linenos">119</span></a><span class="sd">            context: The agent context containing the user query and metadata.</span>
</span><span id="FundingRoundsAgent.execute-120"><a href="#FundingRoundsAgent.execute-120"><span class="linenos">120</span></a>
</span><span id="FundingRoundsAgent.execute-121"><a href="#FundingRoundsAgent.execute-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="FundingRoundsAgent.execute-122"><a href="#FundingRoundsAgent.execute-122"><span class="linenos">122</span></a><span class="sd">            AgentOutput containing:</span>
</span><span id="FundingRoundsAgent.execute-123"><a href="#FundingRoundsAgent.execute-123"><span class="linenos">123</span></a><span class="sd">            - content: Natural language response with funding round information</span>
</span><span id="FundingRoundsAgent.execute-124"><a href="#FundingRoundsAgent.execute-124"><span class="linenos">124</span></a><span class="sd">            - status: SUCCESS if query processed successfully</span>
</span><span id="FundingRoundsAgent.execute-125"><a href="#FundingRoundsAgent.execute-125"><span class="linenos">125</span></a><span class="sd">            - metadata: Information about the search and results</span>
</span><span id="FundingRoundsAgent.execute-126"><a href="#FundingRoundsAgent.execute-126"><span class="linenos">126</span></a><span class="sd">            - tool_calls: List of tool calls made during execution</span>
</span><span id="FundingRoundsAgent.execute-127"><a href="#FundingRoundsAgent.execute-127"><span class="linenos">127</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FundingRoundsAgent.execute-128"><a href="#FundingRoundsAgent.execute-128"><span class="linenos">128</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-129"><a href="#FundingRoundsAgent.execute-129"><span class="linenos">129</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Funding rounds agent processing query: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-130"><a href="#FundingRoundsAgent.execute-130"><span class="linenos">130</span></a>
</span><span id="FundingRoundsAgent.execute-131"><a href="#FundingRoundsAgent.execute-131"><span class="linenos">131</span></a>            <span class="c1"># Prefer pre-extracted intent if available</span>
</span><span id="FundingRoundsAgent.execute-132"><a href="#FundingRoundsAgent.execute-132"><span class="linenos">132</span></a>            <span class="n">extracted</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s2">&quot;extracted_entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="FundingRoundsAgent.execute-133"><a href="#FundingRoundsAgent.execute-133"><span class="linenos">133</span></a>            <span class="n">query_intent</span> <span class="o">=</span> <span class="n">extracted</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_intent&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-134"><a href="#FundingRoundsAgent.execute-134"><span class="linenos">134</span></a>
</span><span id="FundingRoundsAgent.execute-135"><a href="#FundingRoundsAgent.execute-135"><span class="linenos">135</span></a>            <span class="k">if</span> <span class="n">query_intent</span> <span class="o">==</span> <span class="s2">&quot;find_investor_portfolio&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-136"><a href="#FundingRoundsAgent.execute-136"><span class="linenos">136</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_investor_portfolio_query</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-137"><a href="#FundingRoundsAgent.execute-137"><span class="linenos">137</span></a>
</span><span id="FundingRoundsAgent.execute-138"><a href="#FundingRoundsAgent.execute-138"><span class="linenos">138</span></a>            <span class="c1"># Fallback to LLM classification if intent not provided</span>
</span><span id="FundingRoundsAgent.execute-139"><a href="#FundingRoundsAgent.execute-139"><span class="linenos">139</span></a>            <span class="n">query_type</span> <span class="o">=</span> <span class="n">query_intent</span> <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_query_type</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-140"><a href="#FundingRoundsAgent.execute-140"><span class="linenos">140</span></a>
</span><span id="FundingRoundsAgent.execute-141"><a href="#FundingRoundsAgent.execute-141"><span class="linenos">141</span></a>            <span class="k">if</span> <span class="n">query_type</span> <span class="o">==</span> <span class="s2">&quot;investor_portfolio&quot;</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-142"><a href="#FundingRoundsAgent.execute-142"><span class="linenos">142</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_investor_portfolio_query</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-143"><a href="#FundingRoundsAgent.execute-143"><span class="linenos">143</span></a>
</span><span id="FundingRoundsAgent.execute-144"><a href="#FundingRoundsAgent.execute-144"><span class="linenos">144</span></a>            <span class="c1"># Step 2: Identify and resolve company names to UUIDs</span>
</span><span id="FundingRoundsAgent.execute-145"><a href="#FundingRoundsAgent.execute-145"><span class="linenos">145</span></a>            <span class="n">resolved_uuids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_company_names</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-146"><a href="#FundingRoundsAgent.execute-146"><span class="linenos">146</span></a>
</span><span id="FundingRoundsAgent.execute-147"><a href="#FundingRoundsAgent.execute-147"><span class="linenos">147</span></a>            <span class="c1"># Step 3: Extract other search parameters from the query</span>
</span><span id="FundingRoundsAgent.execute-148"><a href="#FundingRoundsAgent.execute-148"><span class="linenos">148</span></a>            <span class="n">search_params</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_search_parameters</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">resolved_uuids</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-149"><a href="#FundingRoundsAgent.execute-149"><span class="linenos">149</span></a>
</span><span id="FundingRoundsAgent.execute-150"><a href="#FundingRoundsAgent.execute-150"><span class="linenos">150</span></a>            <span class="c1"># Step 4: Call get_funding_rounds tool with extracted parameters</span>
</span><span id="FundingRoundsAgent.execute-151"><a href="#FundingRoundsAgent.execute-151"><span class="linenos">151</span></a>            <span class="c1"># Always include organizations for better insights</span>
</span><span id="FundingRoundsAgent.execute-152"><a href="#FundingRoundsAgent.execute-152"><span class="linenos">152</span></a>            <span class="n">search_params</span><span class="p">[</span><span class="s2">&quot;include_organizations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="FundingRoundsAgent.execute-153"><a href="#FundingRoundsAgent.execute-153"><span class="linenos">153</span></a>
</span><span id="FundingRoundsAgent.execute-154"><a href="#FundingRoundsAgent.execute-154"><span class="linenos">154</span></a>            <span class="c1"># Fan-out when multiple companies and no single org_uuid filter</span>
</span><span id="FundingRoundsAgent.execute-155"><a href="#FundingRoundsAgent.execute-155"><span class="linenos">155</span></a>            <span class="n">funding_rounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent.execute-156"><a href="#FundingRoundsAgent.execute-156"><span class="linenos">156</span></a>            <span class="n">tool_calls</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent.execute-157"><a href="#FundingRoundsAgent.execute-157"><span class="linenos">157</span></a>            <span class="n">funding_rounds_output</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FundingRoundsAgent.execute-158"><a href="#FundingRoundsAgent.execute-158"><span class="linenos">158</span></a>
</span><span id="FundingRoundsAgent.execute-159"><a href="#FundingRoundsAgent.execute-159"><span class="linenos">159</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-160"><a href="#FundingRoundsAgent.execute-160"><span class="linenos">160</span></a>                <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;company_pool&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-161"><a href="#FundingRoundsAgent.execute-161"><span class="linenos">161</span></a>                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="FundingRoundsAgent.execute-162"><a href="#FundingRoundsAgent.execute-162"><span class="linenos">162</span></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_uuid&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-163"><a href="#FundingRoundsAgent.execute-163"><span class="linenos">163</span></a>            <span class="p">):</span>
</span><span id="FundingRoundsAgent.execute-164"><a href="#FundingRoundsAgent.execute-164"><span class="linenos">164</span></a>                <span class="n">funding_rounds</span><span class="p">,</span> <span class="n">fanout_calls</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fanout_funding_rounds</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-165"><a href="#FundingRoundsAgent.execute-165"><span class="linenos">165</span></a>                    <span class="n">company_pool</span><span class="o">=</span><span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;company_pool&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent.execute-166"><a href="#FundingRoundsAgent.execute-166"><span class="linenos">166</span></a>                    <span class="n">base_params</span><span class="o">=</span><span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-167"><a href="#FundingRoundsAgent.execute-167"><span class="linenos">167</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-168"><a href="#FundingRoundsAgent.execute-168"><span class="linenos">168</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fanout_calls</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-169"><a href="#FundingRoundsAgent.execute-169"><span class="linenos">169</span></a>                <span class="c1"># If all fan-out calls failed, return early with error</span>
</span><span id="FundingRoundsAgent.execute-170"><a href="#FundingRoundsAgent.execute-170"><span class="linenos">170</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">funding_rounds</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-171"><a href="#FundingRoundsAgent.execute-171"><span class="linenos">171</span></a>                    <span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">fanout_calls</span>
</span><span id="FundingRoundsAgent.execute-172"><a href="#FundingRoundsAgent.execute-172"><span class="linenos">172</span></a>                <span class="p">):</span>
</span><span id="FundingRoundsAgent.execute-173"><a href="#FundingRoundsAgent.execute-173"><span class="linenos">173</span></a>                    <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-174"><a href="#FundingRoundsAgent.execute-174"><span class="linenos">174</span></a>                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-175"><a href="#FundingRoundsAgent.execute-175"><span class="linenos">175</span></a>                        <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-176"><a href="#FundingRoundsAgent.execute-176"><span class="linenos">176</span></a>                        <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-177"><a href="#FundingRoundsAgent.execute-177"><span class="linenos">177</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-178"><a href="#FundingRoundsAgent.execute-178"><span class="linenos">178</span></a>                        <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve funding rounds for all companies in fan-out.&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-179"><a href="#FundingRoundsAgent.execute-179"><span class="linenos">179</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-180"><a href="#FundingRoundsAgent.execute-180"><span class="linenos">180</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-181"><a href="#FundingRoundsAgent.execute-181"><span class="linenos">181</span></a>                <span class="n">funding_rounds_output</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_funding_rounds</span><span class="p">(</span><span class="o">**</span><span class="n">search_params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-182"><a href="#FundingRoundsAgent.execute-182"><span class="linenos">182</span></a>
</span><span id="FundingRoundsAgent.execute-183"><a href="#FundingRoundsAgent.execute-183"><span class="linenos">183</span></a>                <span class="c1"># Check if tool execution was successful</span>
</span><span id="FundingRoundsAgent.execute-184"><a href="#FundingRoundsAgent.execute-184"><span class="linenos">184</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-185"><a href="#FundingRoundsAgent.execute-185"><span class="linenos">185</span></a>                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Failed to retrieve funding rounds&quot;</span>
</span><span id="FundingRoundsAgent.execute-186"><a href="#FundingRoundsAgent.execute-186"><span class="linenos">186</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_funding_rounds tool failed: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-187"><a href="#FundingRoundsAgent.execute-187"><span class="linenos">187</span></a>                    <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-188"><a href="#FundingRoundsAgent.execute-188"><span class="linenos">188</span></a>                        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-189"><a href="#FundingRoundsAgent.execute-189"><span class="linenos">189</span></a>                        <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-190"><a href="#FundingRoundsAgent.execute-190"><span class="linenos">190</span></a>                        <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-191"><a href="#FundingRoundsAgent.execute-191"><span class="linenos">191</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-192"><a href="#FundingRoundsAgent.execute-192"><span class="linenos">192</span></a>                        <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve funding rounds: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-193"><a href="#FundingRoundsAgent.execute-193"><span class="linenos">193</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-194"><a href="#FundingRoundsAgent.execute-194"><span class="linenos">194</span></a>
</span><span id="FundingRoundsAgent.execute-195"><a href="#FundingRoundsAgent.execute-195"><span class="linenos">195</span></a>                <span class="c1"># Extract result from ToolOutput</span>
</span><span id="FundingRoundsAgent.execute-196"><a href="#FundingRoundsAgent.execute-196"><span class="linenos">196</span></a>                <span class="n">funding_rounds</span> <span class="o">=</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">result</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent.execute-197"><a href="#FundingRoundsAgent.execute-197"><span class="linenos">197</span></a>
</span><span id="FundingRoundsAgent.execute-198"><a href="#FundingRoundsAgent.execute-198"><span class="linenos">198</span></a>            <span class="c1"># Step 5: Format results into natural language response</span>
</span><span id="FundingRoundsAgent.execute-199"><a href="#FundingRoundsAgent.execute-199"><span class="linenos">199</span></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">funding_rounds</span><span class="p">,</span> <span class="n">search_params</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-200"><a href="#FundingRoundsAgent.execute-200"><span class="linenos">200</span></a>
</span><span id="FundingRoundsAgent.execute-201"><a href="#FundingRoundsAgent.execute-201"><span class="linenos">201</span></a>            <span class="c1"># Track all tool calls</span>
</span><span id="FundingRoundsAgent.execute-202"><a href="#FundingRoundsAgent.execute-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent.execute-203"><a href="#FundingRoundsAgent.execute-203"><span class="linenos">203</span></a>                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;semantic_search_calls&quot;</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent.execute-204"><a href="#FundingRoundsAgent.execute-204"><span class="linenos">204</span></a>                    <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-205"><a href="#FundingRoundsAgent.execute-205"><span class="linenos">205</span></a>                        <span class="p">{</span>
</span><span id="FundingRoundsAgent.execute-206"><a href="#FundingRoundsAgent.execute-206"><span class="linenos">206</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;semantic_search_organizations&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-207"><a href="#FundingRoundsAgent.execute-207"><span class="linenos">207</span></a>                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent.execute-208"><a href="#FundingRoundsAgent.execute-208"><span class="linenos">208</span></a>                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent.execute-209"><a href="#FundingRoundsAgent.execute-209"><span class="linenos">209</span></a>                        <span class="p">}</span>
</span><span id="FundingRoundsAgent.execute-210"><a href="#FundingRoundsAgent.execute-210"><span class="linenos">210</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-211"><a href="#FundingRoundsAgent.execute-211"><span class="linenos">211</span></a>            <span class="k">if</span> <span class="n">resolved_uuids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">):</span>
</span><span id="FundingRoundsAgent.execute-212"><a href="#FundingRoundsAgent.execute-212"><span class="linenos">212</span></a>                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">resolved_uuids</span><span class="p">[</span><span class="s2">&quot;get_organizations_calls&quot;</span><span class="p">]:</span>
</span><span id="FundingRoundsAgent.execute-213"><a href="#FundingRoundsAgent.execute-213"><span class="linenos">213</span></a>                    <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-214"><a href="#FundingRoundsAgent.execute-214"><span class="linenos">214</span></a>                        <span class="p">{</span>
</span><span id="FundingRoundsAgent.execute-215"><a href="#FundingRoundsAgent.execute-215"><span class="linenos">215</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_organizations&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-216"><a href="#FundingRoundsAgent.execute-216"><span class="linenos">216</span></a>                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent.execute-217"><a href="#FundingRoundsAgent.execute-217"><span class="linenos">217</span></a>                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span>
</span><span id="FundingRoundsAgent.execute-218"><a href="#FundingRoundsAgent.execute-218"><span class="linenos">218</span></a>                        <span class="p">}</span>
</span><span id="FundingRoundsAgent.execute-219"><a href="#FundingRoundsAgent.execute-219"><span class="linenos">219</span></a>                    <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-220"><a href="#FundingRoundsAgent.execute-220"><span class="linenos">220</span></a>
</span><span id="FundingRoundsAgent.execute-221"><a href="#FundingRoundsAgent.execute-221"><span class="linenos">221</span></a>            <span class="c1"># If we did single-call path, add that call metadata</span>
</span><span id="FundingRoundsAgent.execute-222"><a href="#FundingRoundsAgent.execute-222"><span class="linenos">222</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-223"><a href="#FundingRoundsAgent.execute-223"><span class="linenos">223</span></a>                <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;get_funding_rounds&quot;</span> <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-224"><a href="#FundingRoundsAgent.execute-224"><span class="linenos">224</span></a>                <span class="ow">and</span> <span class="n">funding_rounds_output</span>
</span><span id="FundingRoundsAgent.execute-225"><a href="#FundingRoundsAgent.execute-225"><span class="linenos">225</span></a>            <span class="p">):</span>
</span><span id="FundingRoundsAgent.execute-226"><a href="#FundingRoundsAgent.execute-226"><span class="linenos">226</span></a>                <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-227"><a href="#FundingRoundsAgent.execute-227"><span class="linenos">227</span></a>                    <span class="p">{</span>
</span><span id="FundingRoundsAgent.execute-228"><a href="#FundingRoundsAgent.execute-228"><span class="linenos">228</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_funding_rounds&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-229"><a href="#FundingRoundsAgent.execute-229"><span class="linenos">229</span></a>                        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-230"><a href="#FundingRoundsAgent.execute-230"><span class="linenos">230</span></a>                        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="FundingRoundsAgent.execute-231"><a href="#FundingRoundsAgent.execute-231"><span class="linenos">231</span></a>                            <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">),</span>
</span><span id="FundingRoundsAgent.execute-232"><a href="#FundingRoundsAgent.execute-232"><span class="linenos">232</span></a>                            <span class="s2">&quot;sample_ids&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-233"><a href="#FundingRoundsAgent.execute-233"><span class="linenos">233</span></a>                                <span class="p">[</span><span class="n">fr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funding_round_uuid&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">funding_rounds</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="FundingRoundsAgent.execute-234"><a href="#FundingRoundsAgent.execute-234"><span class="linenos">234</span></a>                                <span class="k">if</span> <span class="n">funding_rounds</span>
</span><span id="FundingRoundsAgent.execute-235"><a href="#FundingRoundsAgent.execute-235"><span class="linenos">235</span></a>                                <span class="k">else</span> <span class="p">[]</span>
</span><span id="FundingRoundsAgent.execute-236"><a href="#FundingRoundsAgent.execute-236"><span class="linenos">236</span></a>                            <span class="p">),</span>
</span><span id="FundingRoundsAgent.execute-237"><a href="#FundingRoundsAgent.execute-237"><span class="linenos">237</span></a>                            <span class="s2">&quot;execution_time_ms&quot;</span><span class="p">:</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">execution_time_ms</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-238"><a href="#FundingRoundsAgent.execute-238"><span class="linenos">238</span></a>                            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">funding_rounds_output</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-239"><a href="#FundingRoundsAgent.execute-239"><span class="linenos">239</span></a>                        <span class="p">},</span>
</span><span id="FundingRoundsAgent.execute-240"><a href="#FundingRoundsAgent.execute-240"><span class="linenos">240</span></a>                    <span class="p">}</span>
</span><span id="FundingRoundsAgent.execute-241"><a href="#FundingRoundsAgent.execute-241"><span class="linenos">241</span></a>                <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-242"><a href="#FundingRoundsAgent.execute-242"><span class="linenos">242</span></a>
</span><span id="FundingRoundsAgent.execute-243"><a href="#FundingRoundsAgent.execute-243"><span class="linenos">243</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-244"><a href="#FundingRoundsAgent.execute-244"><span class="linenos">244</span></a>                <span class="sa">f</span><span class="s2">&quot;Funding rounds agent completed: found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">)</span><span class="si">}</span><span class="s2"> funding round(s)&quot;</span>
</span><span id="FundingRoundsAgent.execute-245"><a href="#FundingRoundsAgent.execute-245"><span class="linenos">245</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-246"><a href="#FundingRoundsAgent.execute-246"><span class="linenos">246</span></a>
</span><span id="FundingRoundsAgent.execute-247"><a href="#FundingRoundsAgent.execute-247"><span class="linenos">247</span></a>            <span class="c1"># Return AgentOutput using contract helper</span>
</span><span id="FundingRoundsAgent.execute-248"><a href="#FundingRoundsAgent.execute-248"><span class="linenos">248</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-249"><a href="#FundingRoundsAgent.execute-249"><span class="linenos">249</span></a>                <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-250"><a href="#FundingRoundsAgent.execute-250"><span class="linenos">250</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-251"><a href="#FundingRoundsAgent.execute-251"><span class="linenos">251</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-252"><a href="#FundingRoundsAgent.execute-252"><span class="linenos">252</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-253"><a href="#FundingRoundsAgent.execute-253"><span class="linenos">253</span></a>                <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-254"><a href="#FundingRoundsAgent.execute-254"><span class="linenos">254</span></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="FundingRoundsAgent.execute-255"><a href="#FundingRoundsAgent.execute-255"><span class="linenos">255</span></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-256"><a href="#FundingRoundsAgent.execute-256"><span class="linenos">256</span></a>                    <span class="s2">&quot;num_results&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">funding_rounds</span><span class="p">),</span>
</span><span id="FundingRoundsAgent.execute-257"><a href="#FundingRoundsAgent.execute-257"><span class="linenos">257</span></a>                    <span class="s2">&quot;search_parameters&quot;</span><span class="p">:</span> <span class="n">search_params</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-258"><a href="#FundingRoundsAgent.execute-258"><span class="linenos">258</span></a>                    <span class="s2">&quot;resolved_companies&quot;</span><span class="p">:</span> <span class="n">resolved_uuids</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-259"><a href="#FundingRoundsAgent.execute-259"><span class="linenos">259</span></a>                <span class="p">},</span>
</span><span id="FundingRoundsAgent.execute-260"><a href="#FundingRoundsAgent.execute-260"><span class="linenos">260</span></a>            <span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-261"><a href="#FundingRoundsAgent.execute-261"><span class="linenos">261</span></a>
</span><span id="FundingRoundsAgent.execute-262"><a href="#FundingRoundsAgent.execute-262"><span class="linenos">262</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="FundingRoundsAgent.execute-263"><a href="#FundingRoundsAgent.execute-263"><span class="linenos">263</span></a>            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Funding rounds agent failed to process query: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="FundingRoundsAgent.execute-264"><a href="#FundingRoundsAgent.execute-264"><span class="linenos">264</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="FundingRoundsAgent.execute-265"><a href="#FundingRoundsAgent.execute-265"><span class="linenos">265</span></a>            <span class="k">return</span> <span class="n">create_agent_output</span><span class="p">(</span>
</span><span id="FundingRoundsAgent.execute-266"><a href="#FundingRoundsAgent.execute-266"><span class="linenos">266</span></a>                <span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-267"><a href="#FundingRoundsAgent.execute-267"><span class="linenos">267</span></a>                <span class="n">agent_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-268"><a href="#FundingRoundsAgent.execute-268"><span class="linenos">268</span></a>                <span class="n">agent_category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-269"><a href="#FundingRoundsAgent.execute-269"><span class="linenos">269</span></a>                <span class="n">status</span><span class="o">=</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-270"><a href="#FundingRoundsAgent.execute-270"><span class="linenos">270</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="FundingRoundsAgent.execute-271"><a href="#FundingRoundsAgent.execute-271"><span class="linenos">271</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the funding rounds agent to handle funding round-related queries.</p>

<p>This method:</p>

<ol>
<li>Analyzes the user query to identify company names mentioned</li>
<li>Resolves company names to UUIDs using semantic_search_organizations</li>
<li>Extracts other search parameters (dates, amounts, investors, stages, etc.)</li>
<li>Calls the get_funding_rounds tool with resolved UUIDs and parameters</li>
<li>Formats the results into a natural language response</li>
<li>Returns a structured response with tool calls tracked</li>
</ol>

<p>Args:
    context: The agent context containing the user query and metadata.</p>

<p>Returns:
    AgentOutput containing:
    - content: Natural language response with funding round information
    - status: SUCCESS if query processed successfully
    - metadata: Information about the search and results
    - tool_calls: List of tool calls made during execution</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../core/agent_base.html#AgentBase">src.core.agent_base.AgentBase</a></dt>
                                <dd id="FundingRoundsAgent.config_path" class="variable"><a href="../core/agent_base.html#AgentBase.config_path">config_path</a></dd>
                <dd id="FundingRoundsAgent.config" class="variable"><a href="../core/agent_base.html#AgentBase.config">config</a></dd>
                <dd id="FundingRoundsAgent.name" class="variable"><a href="../core/agent_base.html#AgentBase.name">name</a></dd>
                <dd id="FundingRoundsAgent.description" class="variable"><a href="../core/agent_base.html#AgentBase.description">description</a></dd>
                <dd id="FundingRoundsAgent.category" class="variable"><a href="../core/agent_base.html#AgentBase.category">category</a></dd>
                <dd id="FundingRoundsAgent.tools" class="variable"><a href="../core/agent_base.html#AgentBase.tools">tools</a></dd>
                <dd id="FundingRoundsAgent.metadata" class="variable"><a href="../core/agent_base.html#AgentBase.metadata">metadata</a></dd>
                <dd id="FundingRoundsAgent.get_tool_names" class="function"><a href="../core/agent_base.html#AgentBase.get_tool_names">get_tool_names</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>